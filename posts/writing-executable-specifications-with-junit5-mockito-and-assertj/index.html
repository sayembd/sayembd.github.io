<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Writing Executable Specifications With Junit5 Mockito and AssertJ | Random Musings</title><meta name=keywords content><meta name=description content="Executable Specifications are tests that can also serve as design specifications. They enable technical and business teams to get on the same page by enabling the use of a common language (in DDD-world this is also known as Ubiquitous Language). They function as documentations for the future maintainers of the code. In this article we will see an opinionated way of writing automated tests which could also function as Executable Specifications."><meta name=author content><link rel=canonical href=https://sayembd.github.io/posts/writing-executable-specifications-with-junit5-mockito-and-assertj/><link crossorigin=anonymous href=/assets/css/stylesheet.e884a1e83b640b9aee2f6e14748907f55216dd7fc0781155a538b49b8194f293.css integrity="sha256-6ISh6DtkC5ruL24UdIkH9VIW3X/AeBFVpTi0m4GU8pM=" rel="preload stylesheet" as=style><link rel=icon href=https://sayembd.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://sayembd.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://sayembd.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://sayembd.github.io/apple-touch-icon.png><link rel=mask-icon href=https://sayembd.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:title" content="Writing Executable Specifications With Junit5 Mockito and AssertJ"><meta property="og:description" content="Executable Specifications are tests that can also serve as design specifications. They enable technical and business teams to get on the same page by enabling the use of a common language (in DDD-world this is also known as Ubiquitous Language). They function as documentations for the future maintainers of the code. In this article we will see an opinionated way of writing automated tests which could also function as Executable Specifications."><meta property="og:type" content="article"><meta property="og:url" content="https://sayembd.github.io/posts/writing-executable-specifications-with-junit5-mockito-and-assertj/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-04-26T22:40:20+02:00"><meta property="article:modified_time" content="2020-04-26T22:40:20+02:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Writing Executable Specifications With Junit5 Mockito and AssertJ"><meta name=twitter:description content="Executable Specifications are tests that can also serve as design specifications. They enable technical and business teams to get on the same page by enabling the use of a common language (in DDD-world this is also known as Ubiquitous Language). They function as documentations for the future maintainers of the code. In this article we will see an opinionated way of writing automated tests which could also function as Executable Specifications."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://sayembd.github.io/posts/"},{"@type":"ListItem","position":3,"name":"Writing Executable Specifications With Junit5 Mockito and AssertJ","item":"https://sayembd.github.io/posts/writing-executable-specifications-with-junit5-mockito-and-assertj/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Writing Executable Specifications With Junit5 Mockito and AssertJ","name":"Writing Executable Specifications With Junit5 Mockito and AssertJ","description":"Executable Specifications are tests that can also serve as design specifications. They enable technical and business teams to get on the same page by enabling the use of a common language (in DDD-world this is also known as Ubiquitous Language). They function as documentations for the future maintainers of the code. In this article we will see an opinionated way of writing automated tests which could also function as Executable Specifications.","keywords":[],"articleBody":"Executable Specifications are tests that can also serve as design specifications. They enable technical and business teams to get on the same page by enabling the use of a common language (in DDD-world this is also known as Ubiquitous Language). They function as documentations for the future maintainers of the code. In this article we will see an opinionated way of writing automated tests which could also function as Executable Specifications.\nLet’s start with an example. Suppose we are creating an accounting system for a business. The system will allow its users to record incomes and expenses into different accounts. Before users can start recording incomes and expenses, they should be able to add new accounts into the system. Suppose that the specification for the “Add New Account” use case looks like below -\nScenario 1 Given account does not exist When user adds a new account Then added account has the given name Then added account has the given initial balance Then added account has user’s id\nScenario 2 Given account does not exist When user adds a new account with negative initial balance Then add new account fails\nScenario 3 Given account with the same name exists When user adds a new account Then add new account fails\nIn order to create a new account the user needs to enter an account name and an initial balance into the system. The system will then create the account if no account with the given name already exists and the given initial balance is positive.\nWe will first write down a test which will capture the first “Given-When-Then” part of the first scenario. This is how it looks like -\nclass AddNewAccountTest { @Test @DisplayName(\"Given account does not exist When user adds a new account Then added account has the given name\") void accountAddedWithGivenName() { } } The @DisplayName annotation was introduced in JUnit 5. It assigns a human-readable name to a test. This is the label that we would see when we execute this test e.g., in an IDE like IntelliJ IDEA.\nWe will now create a class which will be responsible for adding the account -\nclass AddNewAccountService { void addNewAccount(String accountName) { } } The class defines a single method which accepts the name of an account and will be responsible for creating it i.e., saving it to a persistent data store. Since we decided to call this class AddNewAccountService, we will also rename our test to AddNewAccountServiceTest to follow the naming convention used in the JUnit world.\nWe can now proceed with writing our test -\nclass AddNewAccountServiceTest { @Test @DisplayName(\"Given account does not exist When user adds a new account Then added account has the given name\") void accountAddedWithGivenName() { AddNewAccountService accountService = new AddNewAccountService(); accountService.addNewAccount(\"test account\"); // What to test? } } What should we test/verify to ensure that the scenario is properly implemented? If we read our specification again, it is clear that we want to create an “Account” with a user-given name, hence this is what we should try to test here. In order to do this, we will have to first create a class which will represent an Account -\n@AllArgsConstructor class Account { private String name; } The Account class has only one property called name. It will have other fields like user id and balance, but we are not testing those at the moment, hence we will not add them to the class right away.\nNow that we have created the Account class, how do we save it, and more importantly, how do we test that the account being saved has the user-given name? There are many approaches to do this, and my preferred one is to define an interface which will encapsulate this saving action. Let’s go ahead and create it -\ninterface SaveAccountPort { void saveAccount(Account account); } The AddNewAccountService will be injected with an implementation of this interface via constructor injection -\n@RequiredArgsConstructor class AddNewAccountService { private final SaveAccountPort saveAccountPort; void addNewAccount(String accountName) { } } For testing purposes we will create a mock implementation with the help of Mockito so that we don’t have to worry about the actual implementation details -\n@ExtendWith(MockitoExtension.class) class AddNewAccountServiceTest { @Mock private SaveAccountPort saveAccountPort; @Test @DisplayName(\"Given account does not exist When user adds a new account Then added account has the given name\") void accountAddedWithGivenName() { AddNewAccountService accountService = new AddNewAccountService(saveAccountPort); accountService.addNewAccount(\"test account\"); // What to test? } } Our test setup is now complete. We now expect our method under test, the addNewAccount method of the AddNewAccountService class, to invoke the saveAccount method of the SaveAccountPort, with an Account object whose name is set to the one passed to the method. Let’s codify this in our test -\n@ExtendWith(MockitoExtension.class) class AddNewAccountServiceTest { @Mock private SaveAccountPort saveAccountPort; @Captor private ArgumentCaptor\u003cAccount\u003e accountArgumentCaptor; @Test @DisplayName(\"Given account does not exist When user adds a new account Then added account has the given name\") void accountAddedWithGivenName() { AddNewAccountService accountService = new AddNewAccountService(saveAccountPort); accountService.addNewAccount(\"test account\"); BDDMockito.then(saveAccountPort).should().saveAccount(accountArgumentCaptor.capture()); BDDAssertions.then(accountArgumentCaptor.getValue().getName()).isEqualTo(\"test account\"); } } The line below -\nBDDMockito.then(saveAccountPort) .should() .saveAccount(accountArgumentCaptor.capture()); verifies that the saveAccount method of the SaveAccountPort is invoked once the method under test is invoked. We also capture the account argument that is passed to the saveAccount method with our argument captor. The next line -\nBDDAssertions.then(accountArgumentCaptor.getValue().getName()) .isEqualTo(\"test account\"); then verifies that the captured account argument has the same name as the one that was passed in the test.\nIn order to make this test pass, the minimal code that is needed in our method under test is as follows -\n@RequiredArgsConstructor class AddNewAccountService { private final SaveAccountPort saveAccountPort; void addNewAccount(String accountName) { saveAccountPort.saveAccount(new Account(accountName)); } } With that, our test starts to pass!\nLet’s move on to the second “Then” part of the first scenario, which says -\nThen added account has the given initial balance Let’s write another test which will verify this part -\n@Test @DisplayName(\"Given account does not exist When user adds a new account Then added account has the given initial balance\") void accountAddedWithGivenInitialBalance() { AddNewAccountService accountService = new AddNewAccountService(saveAccountPort); accountService.addNewAccount(\"test account\", \"56.0\"); BDDMockito.then(saveAccountPort).should().saveAccount(accountArgumentCaptor.capture()); BDDAssertions.then(accountArgumentCaptor.getValue().getBalance()) .isEqualTo(new BigDecimal(\"56.0\")); } We have modified our addNewAccount method to accept the initial balance as the second argument. We have also added a new field, called balance, in our Account object which is able to store the account balance -\n@AllArgsConstructor @Getter class Account { private String name; private BigDecimal balance; } Since we have changed the signature of the addNewAccount method, we will also have to modify our first test -\n@Test @DisplayName(\"Given account does not exist When user adds a new account Then added account has the given name\") void accountAddedWithGivenName() { AddNewAccountService accountService = new AddNewAccountService(saveAccountPort); accountService.addNewAccount(\"test account\", \"1\"); BDDMockito.then(saveAccountPort).should().saveAccount(accountArgumentCaptor.capture()); BDDAssertions.then(accountArgumentCaptor.getValue().getName()).isEqualTo(\"test account\"); } If we run our new test now it will fail as we haven’t implemented the functionality yet. Let’s do that now -\nvoid addNewAccount(String accountName, String initialBalance) { saveAccountPort.saveAccount(new Account(accountName, new BigDecimal(initialBalance))); } Both of our tests should pass now.\nAs we already have a couple of tests in place, it’s time to take a look at our implementation and see if we can make it better. Since our AddNewAccountService is as simple as it can be, we don’t have to do anything there. As for our tests, we could eliminate the duplication in our test setup code - both tests are instantiating an instance of the AddNewAccountService and invoking the addNewAccount method on it in the same way. Whether to remove or keep this duplication depends on our style of writing tests - if we want to make each test as independent as possible, then let’s leave them as they are. If we, however, are fine with having a common test setup code, then we could change the tests as follows -\n@ExtendWith(MockitoExtension.class) @DisplayName(\"Given account does not exist When user adds a new account\") class AddNewAccountServiceTest { private static final String ACCOUNT_NAME = \"test account\"; private static final String INITIAL_BALANCE = \"56.0\"; @Mock private SaveAccountPort saveAccountPort; @Captor private ArgumentCaptor\u003cAccount\u003e accountArgumentCaptor; @BeforeEach void setup() { AddNewAccountService accountService = new AddNewAccountService(saveAccountPort); accountService.addNewAccount(ACCOUNT_NAME, INITIAL_BALANCE); } @Test @DisplayName(\"Then added account has the given name\") void accountAddedWithGivenName() { BDDMockito.then(saveAccountPort).should().saveAccount(accountArgumentCaptor.capture()); BDDAssertions.then(accountArgumentCaptor.getValue().getName()).isEqualTo(ACCOUNT_NAME); } @Test @DisplayName(\"Then added account has the given initial balance\") void accountAddedWithGivenInitialBalance() { BDDMockito.then(saveAccountPort).should().saveAccount(accountArgumentCaptor.capture()); BDDAssertions.then(accountArgumentCaptor.getValue().getBalance()) .isEqualTo(new BigDecimal(INITIAL_BALANCE)); } } Notice that we have also extracted the common part of the @DisplayName and put this on top of the test class. If we are not comfortable doing this, we could also leave them as they are.\nSince we have more than one passing tests, from now on every time we make a failing test pass we will stop for a moment, take a look at our implementation, and will try to improve it. To summarise, our implementation process will now consist of the following steps -\nAdd a failing test while making sure existing tests keep passing Make the failing test pass Pause for a moment and try to improve the implementation (both the code and the tests) Moving on, we now need to store user ids with the created account. Following our method we will first write a failing test to capture this and then add the minimal amount of code needed to make the failing test pass. This is how the implementation looks like once the failing test starts to pass -\n@ExtendWith(MockitoExtension.class) @DisplayName(\"Given account does not exist When user adds a new account\") class AddNewAccountServiceTest { private static final String ACCOUNT_NAME = \"test account\"; private static final String INITIAL_BALANCE = \"56.0\"; private static final String USER_ID = \"some id\"; private Account savedAccount; @BeforeEach void setup() { AddNewAccountService accountService = new AddNewAccountService(saveAccountPort); accountService.addNewAccount(ACCOUNT_NAME, INITIAL_BALANCE, USER_ID); BDDMockito.then(saveAccountPort).should().saveAccount(accountArgumentCaptor.capture()); savedAccount = accountArgumentCaptor.getValue(); } // Other tests..... @Test @DisplayName(\"Then added account has user's id\") void accountAddedWithUsersId() { BDDAssertions.then(accountArgumentCaptor.getValue().getUserId()).isEqualTo(USER_ID); } } @RequiredArgsConstructor class AddNewAccountService { private final SaveAccountPort saveAccountPort; void addNewAccount(String accountName, String initialBalance, String userId) { saveAccountPort.saveAccount(new Account(accountName, new BigDecimal(initialBalance), userId)); } } @AllArgsConstructor @Getter class Account { private String name; private BigDecimal balance; private String userId; } Since all the tests are now passing, it’s improvement time! Notice that the addNewAccount method accepts three argument already. As we introduce more and more account properties its argument list will also start to increase. We could introduce a parameter object to avoid that -\n@RequiredArgsConstructor class AddNewAccountService { private final SaveAccountPort saveAccountPort; void addNewAccount(AddNewAccountCommand command) { saveAccountPort.saveAccount( new Account( command.getAccountName(), new BigDecimal(command.getInitialBalance()), command.getUserId() ) ); } @Builder @Getter static class AddNewAccountCommand { private final String userId; private final String accountName; private final String initialBalance; } } @ExtendWith(MockitoExtension.class) @DisplayName(\"Given account does not exist When user adds a new account\") class AddNewAccountServiceTest { // Fields..... @BeforeEach void setup() { AddNewAccountService accountService = new AddNewAccountService(saveAccountPort); AddNewAccountCommand command = AddNewAccountCommand.builder() .accountName(ACCOUNT_NAME) .initialBalance(INITIAL_BALANCE) .userId(USER_ID) .build(); accountService.addNewAccount(command); BDDMockito.then(saveAccountPort).should().saveAccount(accountArgumentCaptor.capture()); savedAccount = accountArgumentCaptor.getValue(); } // Remaining Tests..... } If I now run the tests in my IDEA, this is what I see -\nWhen we try to read the test descriptions in this view we can already get a good overview of the Add New Account use case and the way it works.\nRight, let’s move on the the second scenario of our use case, which is a validation rule -\nGiven account does not exist When user adds a new account with negative initial balance Then add new account fails\nLet’s write a new test which tries to capture this -\n@ExtendWith(MockitoExtension.class) @DisplayName(\"Given account does not exist When user adds a new account\") class AddNewAccountServiceTest { // Other tests @Test @DisplayName(\"Given account does not exist When user adds a new account with negative initial balance Then add new account fails\") void addNewAccountFailsWithNegativeInitialBalance() { AddNewAccountService accountService = new AddNewAccountService(saveAccountPort); AddNewAccountCommand command = AddNewAccountCommand.builder().initialBalance(\"-56.0\").build(); accountService.addNewAccount(command); BDDMockito.then(saveAccountPort).shouldHaveNoInteractions(); } } There are several ways we can implement validations in our service. We could throw an exception detailing the validation failures, or we could return an error object which would contain the error details. For this example we will throw exceptions if validation fails -\n@Test @DisplayName(\"Given account does not exist When user adds a new account with negative initial balance Then add new account fails\") void addNewAccountFailsWithNegativeInitialBalance() { AddNewAccountService accountService = new AddNewAccountService(saveAccountPort); AddNewAccountCommand command = AddNewAccountCommand.builder().initialBalance(\"-56.0\").build(); assertThatExceptionOfType(IllegalArgumentException.class) .isThrownBy(() -\u003e accountService.addNewAccount(command)); BDDMockito.then(saveAccountPort).shouldHaveNoInteractions(); } This test verifies that an exception is thrown when the addNewAccount method is invoked with a negative balance. It also ensures that in such cases our code does not invoke any method of the SaveAccountPort. Before we can start modifying our service to make this test pass, we have to refactor our test setup code a bit. This is because during one of our previous refactoring we moved our common test setup code into a single method which now runs before each test -\n@BeforeEach void setup() { AddNewAccountService accountService = new AddNewAccountService(saveAccountPort); AddNewAccountCommand command = AddNewAccountCommand.builder() .accountName(ACCOUNT_NAME) .initialBalance(INITIAL_BALANCE) .userId(USER_ID) .build(); accountService.addNewAccount(command); BDDMockito.then(saveAccountPort).should().saveAccount(accountArgumentCaptor.capture()); savedAccount = accountArgumentCaptor.getValue(); } This setup code is now in direct conflict with the new test that we’ve just added - before each test it will always invoke the addNewAccount method with a valid command object, resulting in an invocation of the saveAccount method of the SaveAccountPort, causing our new test to fail.\nIn order to fix this, we will create a nested class within our test class where we will move our existing setup code and the passing tests -\n@ExtendWith(MockitoExtension.class) @DisplayName(\"Given account does not exist\") class AddNewAccountServiceTest { @Mock private SaveAccountPort saveAccountPort; private AddNewAccountService accountService; @BeforeEach void setUp() { accountService = new AddNewAccountService(saveAccountPort); } @Nested @DisplayName(\"When user adds a new account\") class WhenUserAddsANewAccount { private static final String ACCOUNT_NAME = \"test account\"; private static final String INITIAL_BALANCE = \"56.0\"; private static final String USER_ID = \"some id\"; private Account savedAccount; @Captor private ArgumentCaptor\u003cAccount\u003e accountArgumentCaptor; @BeforeEach void setUp() { AddNewAccountCommand command = AddNewAccountCommand.builder() .accountName(ACCOUNT_NAME) .initialBalance(INITIAL_BALANCE) .userId(USER_ID) .build(); accountService.addNewAccount(command); BDDMockito.then(saveAccountPort).should().saveAccount(accountArgumentCaptor.capture()); savedAccount = accountArgumentCaptor.getValue(); } @Test @DisplayName(\"Then added account has the given name\") void accountAddedWithGivenName() { BDDAssertions.then(savedAccount.getName()).isEqualTo(ACCOUNT_NAME); } @Test @DisplayName(\"Then added account has the given initial balance\") void accountAddedWithGivenInitialBalance() { BDDAssertions.then(savedAccount.getBalance()).isEqualTo(new BigDecimal(INITIAL_BALANCE)); } @Test @DisplayName(\"Then added account has user's id\") void accountAddedWithUsersId() { BDDAssertions.then(accountArgumentCaptor.getValue().getUserId()).isEqualTo(USER_ID); } } @Test @DisplayName(\"When user adds a new account with negative initial balance Then add new account fails\") void addNewAccountFailsWithNegativeInitialBalance() { AddNewAccountCommand command = AddNewAccountCommand.builder() .initialBalance(\"-56.0\") .build(); assertThatExceptionOfType(IllegalArgumentException.class) .isThrownBy(() -\u003e accountService.addNewAccount(command)); BDDMockito.then(saveAccountPort).shouldHaveNoInteractions(); } } Here are the refactoring steps that we took -\nWe created an inner class and then marked the inner class with JUnit 5’s @Nested annotation. We broke down the @DisplayName label of the outermost test class and moved the “When user adds a new account” part to the newly introduced inner class. The reason we did this is because this inner class will contain the group of tests that will verify/validate behaviours related to a valid account creation scenario. We moved related setup code and fields/constants into this inner class. We have removed the “Given account does not exist” part from our new test. This is because the @DisplayName on the outermost test class already includes this, hence no point including it here again. This is how the tests now look like when I run them in my IntelliJ IDEA -\nAs we can see from the screenshot, our test labels are also grouped and indented nicely following the structure that we created in our test code. Let’s modify our service now to make the failing test pass -\nvoid addNewAccount(AddNewAccountCommand command) { BigDecimal initialBalance = new BigDecimal(command.getInitialBalance()); if (initialBalance.compareTo(BigDecimal.ZERO) \u003c 0) { throw new IllegalArgumentException(\"Initial balance of an account cannot be negative\"); } saveAccountPort.saveAccount( new Account( command.getAccountName(), initialBalance, command.getUserId() ) ); } With that all of our tests start passing again. Next step is to look for ways to improve the existing implementation if possible. If not, then we will move on to the implementation of the final scenario which is also a validation rule -\nGiven account with the same name exists When user adds a new account Then add new account fails\nAs always, let’s write a test to capture this -\n@Test @DisplayName(\"Given account with the same name exists When user adds a new account Then add new account fails\") void addNewAccountFailsForDuplicateAccounts() { AddNewAccountCommand command = AddNewAccountCommand.builder() .accountName(\"existing name\") .build(); AddNewAccountService accountService = new AddNewAccountService(saveAccountPort); assertThatExceptionOfType(IllegalArgumentException.class) .isThrownBy(() -\u003e accountService.addNewAccount(command)); BDDMockito.then(saveAccountPort).shouldHaveNoInteractions(); } First thing we have to figure out now is to how to find an existing account. Since this will involve querying our persistent data store, we will introduce an interface -\npublic interface FindAccountPort { Account findAccountByName(String accountName); } and inject it into our AddNewAccountService -\n@RequiredArgsConstructor class AddNewAccountService { private final SaveAccountPort saveAccountPort; private final FindAccountPort findAccountPort; // Rest of the code } and modify our test -\n@Test @DisplayName(\"Given account with the same name exists When user adds a new account Then add new account fails\") void addNewAccountFailsForDuplicateAccounts() { String existingAccountName = \"existing name\"; AddNewAccountCommand command = AddNewAccountCommand.builder() .initialBalance(\"0\") .accountName(existingAccountName) .build(); given(findAccountPort.findAccountByName(existingAccountName)).willReturn(mock(Account.class)); AddNewAccountService accountService = new AddNewAccountService(saveAccountPort, findAccountPort); assertThatExceptionOfType(IllegalArgumentException.class) .isThrownBy(() -\u003e accountService.addNewAccount(command)); BDDMockito.then(saveAccountPort).shouldHaveNoInteractions(); } The last change to our AddNewAccountService will also require changes to our existing tests, mainly the place where we were instantiating an instance of that class. We will, however, change a bit more than that -\n@ExtendWith(MockitoExtension.class) class AddNewAccountServiceTest { @Mock private SaveAccountPort saveAccountPort; @Mock private FindAccountPort findAccountPort; @Nested @DisplayName(\"Given account does not exist\") class AccountDoesNotExist { private AddNewAccountService accountService; @BeforeEach void setUp() { accountService = new AddNewAccountService(saveAccountPort, findAccountPort); } @Nested @DisplayName(\"When user adds a new account\") class WhenUserAddsANewAccount { private static final String ACCOUNT_NAME = \"test account\"; private static final String INITIAL_BALANCE = \"56.0\"; private static final String USER_ID = \"some id\"; private Account savedAccount; @Captor private ArgumentCaptor\u003cAccount\u003e accountArgumentCaptor; @BeforeEach void setUp() { AddNewAccountCommand command = AddNewAccountCommand.builder() .accountName(ACCOUNT_NAME) .initialBalance(INITIAL_BALANCE) .userId(USER_ID) .build(); accountService.addNewAccount(command); BDDMockito.then(saveAccountPort).should().saveAccount(accountArgumentCaptor.capture()); savedAccount = accountArgumentCaptor.getValue(); } @Test @DisplayName(\"Then added account has the given name\") void accountAddedWithGivenName() { BDDAssertions.then(savedAccount.getName()).isEqualTo(ACCOUNT_NAME); } @Test @DisplayName(\"Then added account has the given initial balance\") void accountAddedWithGivenInitialBalance() { BDDAssertions.then(savedAccount.getBalance()).isEqualTo(new BigDecimal(INITIAL_BALANCE)); } @Test @DisplayName(\"Then added account has user's id\") void accountAddedWithUsersId() { BDDAssertions.then(accountArgumentCaptor.getValue().getUserId()).isEqualTo(USER_ID); } } @Test @DisplayName(\"When user adds a new account with negative initial balance Then add new account fails\") void addNewAccountFailsWithNegativeInitialBalance() { AddNewAccountCommand command = AddNewAccountCommand.builder() .initialBalance(\"-56.0\") .build(); assertThatExceptionOfType(IllegalArgumentException.class) .isThrownBy(() -\u003e accountService.addNewAccount(command)); BDDMockito.then(saveAccountPort).shouldHaveNoInteractions(); } } @Test @DisplayName(\"Given account with the same name exists When user adds a new account Then add new account fails\") void addNewAccountFailsForDuplicateAccounts() { String existingAccountName = \"existing name\"; AddNewAccountCommand command = AddNewAccountCommand.builder() .initialBalance(\"0\") .accountName(existingAccountName) .build(); given(findAccountPort.findAccountByName(existingAccountName)).willReturn(mock(Account.class)); AddNewAccountService accountService = new AddNewAccountService(saveAccountPort, findAccountPort); assertThatExceptionOfType(IllegalArgumentException.class) .isThrownBy(() -\u003e accountService.addNewAccount(command)); BDDMockito.then(saveAccountPort).shouldHaveNoInteractions(); } } Here’s what we did -\nWe created another inner class, marked it as @Nested, and moved our existing passing tests into this. This group of tests test the behaviour of adding a new account when no account with the given name already exists. We have moved our test set up code into the newly introduced inner class as they are also related to the “no account with the given name already exists” case. For the same reason as above, we have also moved our @DisplayName annotation from the top level test class to the newly introduced inner class.\nAfter our refactoring we quickly run our tests to see if everything is working as expected (failing test failing, passing tests passing), and then move on to modify our service -\n@RequiredArgsConstructor class AddNewAccountService { private final SaveAccountPort saveAccountPort; private final FindAccountPort findAccountPort; void addNewAccount(AddNewAccountCommand command) { BigDecimal initialBalance = new BigDecimal(command.getInitialBalance()); if (initialBalance.compareTo(BigDecimal.ZERO) \u003c 0) { throw new IllegalArgumentException(\"Initial balance of an account cannot be negative\"); } if (findAccountPort.findAccountByName(command.getAccountName()) != null) { throw new IllegalArgumentException(\"An account with given name already exists\"); } saveAccountPort.saveAccount( new Account( command.getAccountName(), initialBalance, command.getUserId() ) ); } @Builder @Getter static class AddNewAccountCommand { private final String userId; private final String accountName; private final String initialBalance; } } All of our tests should now be green.\nSince our use case implementation is now complete, we will look at our implementation for one last time and see if we can improve anything. If not, our use case implementation is now complete!\nTo summarise, this is what we did throughout this article -\nWe have written down a use case that we would like to implement We have added a failing test, labelling it with a human-readable name We have added the minimal amount of code needed to make the failing test pass As soon as we had more than one passing tests, after we made each failing test pass, we looked at our implementation and tried to improve it When writing the tests we tried writing them in such a way so that our use case specifications are reflected in the test code. For this we have used - The @DisplayName annotation to assign human-readable names to our tests Used @Nested to group related tests in a hierarchical structure, reflecting our use case setup Used BDD-driven API from Mockito and AssertJ to verify the expected behaviours When should we follow this style of writing automated tests? The answer to this question is the same as every other usage questions in Software Engineering - it depends. I personally prefer this style when I am working with an application which has complex business/domain rules, which is intended to be maintained over a long period, for which a close collaboration with the business is required, and many other factors (i.e., application architecture, team adoption etc.).\nAs always, the full working example has been pushed to Github.\nUntil next time!\n","wordCount":"3542","inLanguage":"en","datePublished":"2020-04-26T22:40:20+02:00","dateModified":"2020-04-26T22:40:20+02:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://sayembd.github.io/posts/writing-executable-specifications-with-junit5-mockito-and-assertj/"},"publisher":{"@type":"Organization","name":"Random Musings","logo":{"@type":"ImageObject","url":"https://sayembd.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://sayembd.github.io accesskey=h title="Random Musings (Alt + H)">Random Musings</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://sayembd.github.io/about-me title="About Me"><span>About Me</span></a></li><li><a href=https://sayembd.github.io/index.xml title=RSS><span>RSS</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>Writing Executable Specifications With Junit5 Mockito and AssertJ</h1><div class=post-meta><span title='2020-04-26 22:40:20 +0200 CEST'>April 26, 2020</span></div></header><div class=post-content><p>Executable Specifications are tests that can also serve as design specifications. They enable technical and business teams to get on the same page by enabling the use of a common language (in DDD-world this is also known as <a href=https://martinfowler.com/bliki/UbiquitousLanguage.html>Ubiquitous Language</a>). They function as documentations for the future maintainers of the code. In this article we will see an opinionated way of writing automated tests which could also function as Executable Specifications.</p><p>Let&rsquo;s start with an example. Suppose we are creating an accounting system for a business. The system will allow its users to record incomes and expenses into different accounts. Before users can start recording incomes and expenses, they should be able to add new accounts into the system. Suppose that the specification for the &ldquo;Add New Account&rdquo; use case looks like below -</p><blockquote><p>Scenario 1
Given account does not exist
When user adds a new account
Then added account has the given name
Then added account has the given initial balance
Then added account has user&rsquo;s id</p><p>Scenario 2
Given account does not exist
When user adds a new account with negative initial balance
Then add new account fails</p><p>Scenario 3
Given account with the same name exists
When user adds a new account
Then add new account fails</p></blockquote><p>In order to create a new account the user needs to enter an account name and an initial balance into the system. The system will then create the account if no account with the given name already exists and the given initial balance is positive.</p><p>We will first write down a test which will capture the first &ldquo;Given-When-Then&rdquo; part of the first scenario. This is how it looks like -</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>class</span> <span class=nc>AddNewAccountTest</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@Test</span>
</span></span><span class=line><span class=cl>  <span class=nd>@DisplayName</span><span class=o>(</span><span class=s>&#34;Given account does not exist
</span></span></span><span class=line><span class=cl><span class=s>      When user adds a new account Then added account has the given name&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>  <span class=kt>void</span> <span class=nf>accountAddedWithGivenName</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>The <a href=https://junit.org/junit5/docs/5.0.3/api/org/junit/jupiter/api/DisplayName.html>@DisplayName</a> annotation was introduced in JUnit 5. It assigns a human-readable name to a test. This is the label that we would see when we execute this test e.g., in an IDE like IntelliJ IDEA.</p><p>We will now create a class which will be responsible for adding the account -</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>class</span> <span class=nc>AddNewAccountService</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kt>void</span> <span class=nf>addNewAccount</span><span class=o>(</span><span class=n>String</span> <span class=n>accountName</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>The class defines a single method which accepts the name of an account and will be responsible for creating it i.e., saving it to a persistent data store. Since we decided to call this class AddNewAccountService, we will also rename our test to AddNewAccountServiceTest to follow the naming convention used in the JUnit world.</p><p>We can now proceed with writing our test -</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>class</span> <span class=nc>AddNewAccountServiceTest</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@Test</span>
</span></span><span class=line><span class=cl>  <span class=nd>@DisplayName</span><span class=o>(</span><span class=s>&#34;Given account does not exist When user adds a new account Then added account has the given name&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>  <span class=kt>void</span> <span class=nf>accountAddedWithGivenName</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>AddNewAccountService</span> <span class=n>accountService</span> <span class=o>=</span> <span class=k>new</span> <span class=n>AddNewAccountService</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>accountService</span><span class=o>.</span><span class=na>addNewAccount</span><span class=o>(</span><span class=s>&#34;test account&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1>// What to test?
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>What should we test/verify to ensure that the scenario is properly implemented? If we read our specification again, it is clear that we want to create an &ldquo;Account&rdquo; with a user-given name, hence this is what we should try to test here. In order to do this, we will have to first create a class which will represent an Account -</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@AllArgsConstructor</span>
</span></span><span class=line><span class=cl><span class=kd>class</span> <span class=nc>Account</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=n>String</span> <span class=n>name</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>The Account class has only one property called name. It will have other fields like user id and balance, but we are not testing those at the moment, hence we will not add them to the class right away.</p><p>Now that we have created the Account class, how do we save it, and more importantly, how do we test that the account being saved has the user-given name? There are many approaches to do this, and my preferred one is to define an interface which will encapsulate this saving action. Let&rsquo;s go ahead and create it -</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>interface</span> <span class=nc>SaveAccountPort</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kt>void</span> <span class=nf>saveAccount</span><span class=o>(</span><span class=n>Account</span> <span class=n>account</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>The AddNewAccountService will be injected with an implementation of this interface via constructor injection -</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@RequiredArgsConstructor</span>
</span></span><span class=line><span class=cl><span class=kd>class</span> <span class=nc>AddNewAccountService</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kd>final</span> <span class=n>SaveAccountPort</span> <span class=n>saveAccountPort</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kt>void</span> <span class=nf>addNewAccount</span><span class=o>(</span><span class=n>String</span> <span class=n>accountName</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>For testing purposes we will create a mock implementation with the help of Mockito so that we don&rsquo;t have to worry about the actual implementation details -</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@ExtendWith</span><span class=o>(</span><span class=n>MockitoExtension</span><span class=o>.</span><span class=na>class</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=kd>class</span> <span class=nc>AddNewAccountServiceTest</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@Mock</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=n>SaveAccountPort</span> <span class=n>saveAccountPort</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@Test</span>
</span></span><span class=line><span class=cl>  <span class=nd>@DisplayName</span><span class=o>(</span><span class=s>&#34;Given account does not exist When user adds a new account Then added account has the given name&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>  <span class=kt>void</span> <span class=nf>accountAddedWithGivenName</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>AddNewAccountService</span> <span class=n>accountService</span> <span class=o>=</span> <span class=k>new</span> <span class=n>AddNewAccountService</span><span class=o>(</span><span class=n>saveAccountPort</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>accountService</span><span class=o>.</span><span class=na>addNewAccount</span><span class=o>(</span><span class=s>&#34;test account&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1>// What to test?
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>Our test setup is now complete. We now expect our method under test, the addNewAccount method of the AddNewAccountService class, to invoke the saveAccount method of the SaveAccountPort, with an Account object whose name is set to the one passed to the method. Let&rsquo;s codify this in our test -</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@ExtendWith</span><span class=o>(</span><span class=n>MockitoExtension</span><span class=o>.</span><span class=na>class</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=kd>class</span> <span class=nc>AddNewAccountServiceTest</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@Mock</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=n>SaveAccountPort</span> <span class=n>saveAccountPort</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@Captor</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=n>ArgumentCaptor</span><span class=o>&lt;</span><span class=n>Account</span><span class=o>&gt;</span> <span class=n>accountArgumentCaptor</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@Test</span>
</span></span><span class=line><span class=cl>  <span class=nd>@DisplayName</span><span class=o>(</span><span class=s>&#34;Given account does not exist When user adds a new account Then added account has the given name&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>  <span class=kt>void</span> <span class=nf>accountAddedWithGivenName</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>AddNewAccountService</span> <span class=n>accountService</span> <span class=o>=</span> <span class=k>new</span> <span class=n>AddNewAccountService</span><span class=o>(</span><span class=n>saveAccountPort</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>accountService</span><span class=o>.</span><span class=na>addNewAccount</span><span class=o>(</span><span class=s>&#34;test account&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>BDDMockito</span><span class=o>.</span><span class=na>then</span><span class=o>(</span><span class=n>saveAccountPort</span><span class=o>).</span><span class=na>should</span><span class=o>().</span><span class=na>saveAccount</span><span class=o>(</span><span class=n>accountArgumentCaptor</span><span class=o>.</span><span class=na>capture</span><span class=o>());</span>
</span></span><span class=line><span class=cl>    <span class=n>BDDAssertions</span><span class=o>.</span><span class=na>then</span><span class=o>(</span><span class=n>accountArgumentCaptor</span><span class=o>.</span><span class=na>getValue</span><span class=o>().</span><span class=na>getName</span><span class=o>()).</span><span class=na>isEqualTo</span><span class=o>(</span><span class=s>&#34;test account&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>The line below -</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>BDDMockito</span><span class=o>.</span><span class=na>then</span><span class=o>(</span><span class=n>saveAccountPort</span><span class=o>)</span>
</span></span><span class=line><span class=cl>  <span class=o>.</span><span class=na>should</span><span class=o>()</span>
</span></span><span class=line><span class=cl>  <span class=o>.</span><span class=na>saveAccount</span><span class=o>(</span><span class=n>accountArgumentCaptor</span><span class=o>.</span><span class=na>capture</span><span class=o>());</span>
</span></span></code></pre></div><p>verifies that the saveAccount method of the SaveAccountPort is invoked once the method under test is invoked. We also capture the account argument that is passed to the saveAccount method with our argument captor. The next line -</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>BDDAssertions</span><span class=o>.</span><span class=na>then</span><span class=o>(</span><span class=n>accountArgumentCaptor</span><span class=o>.</span><span class=na>getValue</span><span class=o>().</span><span class=na>getName</span><span class=o>())</span>
</span></span><span class=line><span class=cl>  <span class=o>.</span><span class=na>isEqualTo</span><span class=o>(</span><span class=s>&#34;test account&#34;</span><span class=o>);</span>
</span></span></code></pre></div><p>then verifies that the captured account argument has the same name as the one that was passed in the test.</p><p>In order to make this test pass, the minimal code that is needed in our method under test is as follows -</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@RequiredArgsConstructor</span>
</span></span><span class=line><span class=cl><span class=kd>class</span> <span class=nc>AddNewAccountService</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kd>final</span> <span class=n>SaveAccountPort</span> <span class=n>saveAccountPort</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kt>void</span> <span class=nf>addNewAccount</span><span class=o>(</span><span class=n>String</span> <span class=n>accountName</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>saveAccountPort</span><span class=o>.</span><span class=na>saveAccount</span><span class=o>(</span><span class=k>new</span> <span class=n>Account</span><span class=o>(</span><span class=n>accountName</span><span class=o>));</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>With that, our test starts to pass!</p><p>Let&rsquo;s move on to the second &ldquo;Then&rdquo; part of the first scenario, which says -</p><blockquote><p>Then added account has the given initial balance
Let&rsquo;s write another test which will verify this part -</p></blockquote><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Test</span>
</span></span><span class=line><span class=cl><span class=nd>@DisplayName</span><span class=o>(</span><span class=s>&#34;Given account does not exist When user adds a new account Then added account has the given initial balance&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>accountAddedWithGivenInitialBalance</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=n>AddNewAccountService</span> <span class=n>accountService</span> <span class=o>=</span> <span class=k>new</span> <span class=n>AddNewAccountService</span><span class=o>(</span><span class=n>saveAccountPort</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>accountService</span><span class=o>.</span><span class=na>addNewAccount</span><span class=o>(</span><span class=s>&#34;test account&#34;</span><span class=o>,</span> <span class=s>&#34;56.0&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=n>BDDMockito</span><span class=o>.</span><span class=na>then</span><span class=o>(</span><span class=n>saveAccountPort</span><span class=o>).</span><span class=na>should</span><span class=o>().</span><span class=na>saveAccount</span><span class=o>(</span><span class=n>accountArgumentCaptor</span><span class=o>.</span><span class=na>capture</span><span class=o>());</span>
</span></span><span class=line><span class=cl>  <span class=n>BDDAssertions</span><span class=o>.</span><span class=na>then</span><span class=o>(</span><span class=n>accountArgumentCaptor</span><span class=o>.</span><span class=na>getValue</span><span class=o>().</span><span class=na>getBalance</span><span class=o>())</span>
</span></span><span class=line><span class=cl>        <span class=o>.</span><span class=na>isEqualTo</span><span class=o>(</span><span class=k>new</span> <span class=n>BigDecimal</span><span class=o>(</span><span class=s>&#34;56.0&#34;</span><span class=o>));</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>We have modified our addNewAccount method to accept the initial balance as the second argument. We have also added a new field, called balance, in our Account object which is able to store the account balance -</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@AllArgsConstructor</span>
</span></span><span class=line><span class=cl><span class=nd>@Getter</span>
</span></span><span class=line><span class=cl><span class=kd>class</span> <span class=nc>Account</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=n>String</span> <span class=n>name</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=n>BigDecimal</span> <span class=n>balance</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>Since we have changed the signature of the addNewAccount method, we will also have to modify our first test -</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Test</span>
</span></span><span class=line><span class=cl><span class=nd>@DisplayName</span><span class=o>(</span><span class=s>&#34;Given account does not exist When user adds a new account Then added account has the given name&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>accountAddedWithGivenName</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=n>AddNewAccountService</span> <span class=n>accountService</span> <span class=o>=</span> <span class=k>new</span> <span class=n>AddNewAccountService</span><span class=o>(</span><span class=n>saveAccountPort</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>accountService</span><span class=o>.</span><span class=na>addNewAccount</span><span class=o>(</span><span class=s>&#34;test account&#34;</span><span class=o>,</span> <span class=s>&#34;1&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>BDDMockito</span><span class=o>.</span><span class=na>then</span><span class=o>(</span><span class=n>saveAccountPort</span><span class=o>).</span><span class=na>should</span><span class=o>().</span><span class=na>saveAccount</span><span class=o>(</span><span class=n>accountArgumentCaptor</span><span class=o>.</span><span class=na>capture</span><span class=o>());</span>
</span></span><span class=line><span class=cl>  <span class=n>BDDAssertions</span><span class=o>.</span><span class=na>then</span><span class=o>(</span><span class=n>accountArgumentCaptor</span><span class=o>.</span><span class=na>getValue</span><span class=o>().</span><span class=na>getName</span><span class=o>()).</span><span class=na>isEqualTo</span><span class=o>(</span><span class=s>&#34;test account&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>If we run our new test now it will fail as we haven&rsquo;t implemented the functionality yet. Let&rsquo;s do that now -</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kt>void</span> <span class=nf>addNewAccount</span><span class=o>(</span><span class=n>String</span> <span class=n>accountName</span><span class=o>,</span> <span class=n>String</span> <span class=n>initialBalance</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=n>saveAccountPort</span><span class=o>.</span><span class=na>saveAccount</span><span class=o>(</span><span class=k>new</span> <span class=n>Account</span><span class=o>(</span><span class=n>accountName</span><span class=o>,</span> <span class=k>new</span> <span class=n>BigDecimal</span><span class=o>(</span><span class=n>initialBalance</span><span class=o>)));</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>Both of our tests should pass now.</p><p>As we already have a couple of tests in place, it&rsquo;s time to take a look at our implementation and see if we can make it better. Since our AddNewAccountService is as simple as it can be, we don&rsquo;t have to do anything there. As for our tests, we could eliminate the duplication in our test setup code - both tests are instantiating an instance of the AddNewAccountService and invoking the addNewAccount method on it in the same way. Whether to remove or keep this duplication depends on our style of writing tests - if we want to make each test as independent as possible, then let&rsquo;s leave them as they are. If we, however, are fine with having a common test setup code, then we could change the tests as follows -</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@ExtendWith</span><span class=o>(</span><span class=n>MockitoExtension</span><span class=o>.</span><span class=na>class</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=nd>@DisplayName</span><span class=o>(</span><span class=s>&#34;Given account does not exist When user adds a new account&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=kd>class</span> <span class=nc>AddNewAccountServiceTest</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=n>String</span> <span class=n>ACCOUNT_NAME</span> <span class=o>=</span> <span class=s>&#34;test account&#34;</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=n>String</span> <span class=n>INITIAL_BALANCE</span> <span class=o>=</span> <span class=s>&#34;56.0&#34;</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@Mock</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=n>SaveAccountPort</span> <span class=n>saveAccountPort</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@Captor</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=n>ArgumentCaptor</span><span class=o>&lt;</span><span class=n>Account</span><span class=o>&gt;</span> <span class=n>accountArgumentCaptor</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@BeforeEach</span>
</span></span><span class=line><span class=cl>  <span class=kt>void</span> <span class=nf>setup</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>AddNewAccountService</span> <span class=n>accountService</span> <span class=o>=</span> <span class=k>new</span> <span class=n>AddNewAccountService</span><span class=o>(</span><span class=n>saveAccountPort</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>accountService</span><span class=o>.</span><span class=na>addNewAccount</span><span class=o>(</span><span class=n>ACCOUNT_NAME</span><span class=o>,</span> <span class=n>INITIAL_BALANCE</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@Test</span>
</span></span><span class=line><span class=cl>  <span class=nd>@DisplayName</span><span class=o>(</span><span class=s>&#34;Then added account has the given name&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>  <span class=kt>void</span> <span class=nf>accountAddedWithGivenName</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>BDDMockito</span><span class=o>.</span><span class=na>then</span><span class=o>(</span><span class=n>saveAccountPort</span><span class=o>).</span><span class=na>should</span><span class=o>().</span><span class=na>saveAccount</span><span class=o>(</span><span class=n>accountArgumentCaptor</span><span class=o>.</span><span class=na>capture</span><span class=o>());</span>
</span></span><span class=line><span class=cl>    <span class=n>BDDAssertions</span><span class=o>.</span><span class=na>then</span><span class=o>(</span><span class=n>accountArgumentCaptor</span><span class=o>.</span><span class=na>getValue</span><span class=o>().</span><span class=na>getName</span><span class=o>()).</span><span class=na>isEqualTo</span><span class=o>(</span><span class=n>ACCOUNT_NAME</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@Test</span>
</span></span><span class=line><span class=cl>  <span class=nd>@DisplayName</span><span class=o>(</span><span class=s>&#34;Then added account has the given initial balance&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>  <span class=kt>void</span> <span class=nf>accountAddedWithGivenInitialBalance</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>BDDMockito</span><span class=o>.</span><span class=na>then</span><span class=o>(</span><span class=n>saveAccountPort</span><span class=o>).</span><span class=na>should</span><span class=o>().</span><span class=na>saveAccount</span><span class=o>(</span><span class=n>accountArgumentCaptor</span><span class=o>.</span><span class=na>capture</span><span class=o>());</span>
</span></span><span class=line><span class=cl>    <span class=n>BDDAssertions</span><span class=o>.</span><span class=na>then</span><span class=o>(</span><span class=n>accountArgumentCaptor</span><span class=o>.</span><span class=na>getValue</span><span class=o>().</span><span class=na>getBalance</span><span class=o>())</span>
</span></span><span class=line><span class=cl>        <span class=o>.</span><span class=na>isEqualTo</span><span class=o>(</span><span class=k>new</span> <span class=n>BigDecimal</span><span class=o>(</span><span class=n>INITIAL_BALANCE</span><span class=o>));</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>Notice that we have also extracted the common part of the @DisplayName and put this on top of the test class. If we are not comfortable doing this, we could also leave them as they are.</p><p>Since we have more than one passing tests, from now on every time we make a failing test pass we will stop for a moment, take a look at our implementation, and will try to improve it. To summarise, our implementation process will now consist of the following steps -</p><ol><li>Add a failing test while making sure existing tests keep passing</li><li>Make the failing test pass</li><li>Pause for a moment and try to improve the implementation (both the code and the tests)</li></ol><p>Moving on, we now need to store user ids with the created account. Following our method we will first write a failing test to capture this and then add the minimal amount of code needed to make the failing test pass. This is how the implementation looks like once the failing test starts to pass -</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@ExtendWith</span><span class=o>(</span><span class=n>MockitoExtension</span><span class=o>.</span><span class=na>class</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=nd>@DisplayName</span><span class=o>(</span><span class=s>&#34;Given account does not exist When user adds a new account&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=kd>class</span> <span class=nc>AddNewAccountServiceTest</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=n>String</span> <span class=n>ACCOUNT_NAME</span> <span class=o>=</span> <span class=s>&#34;test account&#34;</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=n>String</span> <span class=n>INITIAL_BALANCE</span> <span class=o>=</span> <span class=s>&#34;56.0&#34;</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=n>String</span> <span class=n>USER_ID</span> <span class=o>=</span> <span class=s>&#34;some id&#34;</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=n>Account</span> <span class=n>savedAccount</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@BeforeEach</span>
</span></span><span class=line><span class=cl>  <span class=kt>void</span> <span class=nf>setup</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>AddNewAccountService</span> <span class=n>accountService</span> <span class=o>=</span> <span class=k>new</span> <span class=n>AddNewAccountService</span><span class=o>(</span><span class=n>saveAccountPort</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>accountService</span><span class=o>.</span><span class=na>addNewAccount</span><span class=o>(</span><span class=n>ACCOUNT_NAME</span><span class=o>,</span> <span class=n>INITIAL_BALANCE</span><span class=o>,</span> <span class=n>USER_ID</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>BDDMockito</span><span class=o>.</span><span class=na>then</span><span class=o>(</span><span class=n>saveAccountPort</span><span class=o>).</span><span class=na>should</span><span class=o>().</span><span class=na>saveAccount</span><span class=o>(</span><span class=n>accountArgumentCaptor</span><span class=o>.</span><span class=na>capture</span><span class=o>());</span>
</span></span><span class=line><span class=cl>    <span class=n>savedAccount</span> <span class=o>=</span> <span class=n>accountArgumentCaptor</span><span class=o>.</span><span class=na>getValue</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=c1>// Other tests.....
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=nd>@Test</span>
</span></span><span class=line><span class=cl>  <span class=nd>@DisplayName</span><span class=o>(</span><span class=s>&#34;Then added account has user&#39;s id&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>  <span class=kt>void</span> <span class=nf>accountAddedWithUsersId</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>BDDAssertions</span><span class=o>.</span><span class=na>then</span><span class=o>(</span><span class=n>accountArgumentCaptor</span><span class=o>.</span><span class=na>getValue</span><span class=o>().</span><span class=na>getUserId</span><span class=o>()).</span><span class=na>isEqualTo</span><span class=o>(</span><span class=n>USER_ID</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@RequiredArgsConstructor</span>
</span></span><span class=line><span class=cl><span class=kd>class</span> <span class=nc>AddNewAccountService</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kd>final</span> <span class=n>SaveAccountPort</span> <span class=n>saveAccountPort</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kt>void</span> <span class=nf>addNewAccount</span><span class=o>(</span><span class=n>String</span> <span class=n>accountName</span><span class=o>,</span> <span class=n>String</span> <span class=n>initialBalance</span><span class=o>,</span> <span class=n>String</span> <span class=n>userId</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>saveAccountPort</span><span class=o>.</span><span class=na>saveAccount</span><span class=o>(</span><span class=k>new</span> <span class=n>Account</span><span class=o>(</span><span class=n>accountName</span><span class=o>,</span> <span class=k>new</span> <span class=n>BigDecimal</span><span class=o>(</span><span class=n>initialBalance</span><span class=o>),</span> <span class=n>userId</span><span class=o>));</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@AllArgsConstructor</span>
</span></span><span class=line><span class=cl><span class=nd>@Getter</span>
</span></span><span class=line><span class=cl><span class=kd>class</span> <span class=nc>Account</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=n>String</span> <span class=n>name</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=n>BigDecimal</span> <span class=n>balance</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=n>String</span> <span class=n>userId</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>Since all the tests are now passing, it&rsquo;s improvement time! Notice that the addNewAccount method accepts three argument already. As we introduce more and more account properties its argument list will also start to increase. We could introduce a parameter object to avoid that -</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@RequiredArgsConstructor</span>
</span></span><span class=line><span class=cl><span class=kd>class</span> <span class=nc>AddNewAccountService</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kd>final</span> <span class=n>SaveAccountPort</span> <span class=n>saveAccountPort</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kt>void</span> <span class=nf>addNewAccount</span><span class=o>(</span><span class=n>AddNewAccountCommand</span> <span class=n>command</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>saveAccountPort</span><span class=o>.</span><span class=na>saveAccount</span><span class=o>(</span>
</span></span><span class=line><span class=cl>        <span class=k>new</span> <span class=n>Account</span><span class=o>(</span>
</span></span><span class=line><span class=cl>            <span class=n>command</span><span class=o>.</span><span class=na>getAccountName</span><span class=o>(),</span>
</span></span><span class=line><span class=cl>            <span class=k>new</span> <span class=n>BigDecimal</span><span class=o>(</span><span class=n>command</span><span class=o>.</span><span class=na>getInitialBalance</span><span class=o>()),</span>
</span></span><span class=line><span class=cl>            <span class=n>command</span><span class=o>.</span><span class=na>getUserId</span><span class=o>()</span>
</span></span><span class=line><span class=cl>        <span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@Builder</span>
</span></span><span class=line><span class=cl>  <span class=nd>@Getter</span>
</span></span><span class=line><span class=cl>  <span class=kd>static</span> <span class=kd>class</span> <span class=nc>AddNewAccountCommand</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>final</span> <span class=n>String</span> <span class=n>userId</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>final</span> <span class=n>String</span> <span class=n>accountName</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>final</span> <span class=n>String</span> <span class=n>initialBalance</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@ExtendWith</span><span class=o>(</span><span class=n>MockitoExtension</span><span class=o>.</span><span class=na>class</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=nd>@DisplayName</span><span class=o>(</span><span class=s>&#34;Given account does not exist When user adds a new account&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=kd>class</span> <span class=nc>AddNewAccountServiceTest</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// Fields.....
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=nd>@BeforeEach</span>
</span></span><span class=line><span class=cl>  <span class=kt>void</span> <span class=nf>setup</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>AddNewAccountService</span> <span class=n>accountService</span> <span class=o>=</span> <span class=k>new</span> <span class=n>AddNewAccountService</span><span class=o>(</span><span class=n>saveAccountPort</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>AddNewAccountCommand</span> <span class=n>command</span> <span class=o>=</span> <span class=n>AddNewAccountCommand</span><span class=o>.</span><span class=na>builder</span><span class=o>()</span>
</span></span><span class=line><span class=cl>        <span class=o>.</span><span class=na>accountName</span><span class=o>(</span><span class=n>ACCOUNT_NAME</span><span class=o>)</span>
</span></span><span class=line><span class=cl>        <span class=o>.</span><span class=na>initialBalance</span><span class=o>(</span><span class=n>INITIAL_BALANCE</span><span class=o>)</span>
</span></span><span class=line><span class=cl>        <span class=o>.</span><span class=na>userId</span><span class=o>(</span><span class=n>USER_ID</span><span class=o>)</span>
</span></span><span class=line><span class=cl>        <span class=o>.</span><span class=na>build</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>accountService</span><span class=o>.</span><span class=na>addNewAccount</span><span class=o>(</span><span class=n>command</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>BDDMockito</span><span class=o>.</span><span class=na>then</span><span class=o>(</span><span class=n>saveAccountPort</span><span class=o>).</span><span class=na>should</span><span class=o>().</span><span class=na>saveAccount</span><span class=o>(</span><span class=n>accountArgumentCaptor</span><span class=o>.</span><span class=na>capture</span><span class=o>());</span>
</span></span><span class=line><span class=cl>    <span class=n>savedAccount</span> <span class=o>=</span> <span class=n>accountArgumentCaptor</span><span class=o>.</span><span class=na>getValue</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// Remaining Tests.....
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>}</span>
</span></span></code></pre></div><p>If I now run the tests in my IDEA, this is what I see -</p><p><img loading=lazy src=https://1.bp.blogspot.com/-QlyUxSaCxH8/XqNb2svxO2I/AAAAAAAAM5E/YDfFHqohZwghyZeHNRV2zXqby0GJyTaWgCK4BGAsYHg/Screenshot%2B2020-04-24%2Bat%2B23.35.46.png alt="Test Output"></p><p>When we try to read the test descriptions in this view we can already get a good overview of the Add New Account use case and the way it works.</p><p>Right, let&rsquo;s move on the the second scenario of our use case, which is a validation rule -</p><blockquote><p>Given account does not exist
When user adds a new account with negative initial balance
Then add new account fails</p></blockquote><p>Let&rsquo;s write a new test which tries to capture this -</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@ExtendWith</span><span class=o>(</span><span class=n>MockitoExtension</span><span class=o>.</span><span class=na>class</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=nd>@DisplayName</span><span class=o>(</span><span class=s>&#34;Given account does not exist When user adds a new account&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=kd>class</span> <span class=nc>AddNewAccountServiceTest</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// Other tests
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=nd>@Test</span>
</span></span><span class=line><span class=cl>  <span class=nd>@DisplayName</span><span class=o>(</span><span class=s>&#34;Given account does not exist When user adds a new account with negative initial balance Then add new account fails&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>  <span class=kt>void</span> <span class=nf>addNewAccountFailsWithNegativeInitialBalance</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>AddNewAccountService</span> <span class=n>accountService</span> <span class=o>=</span> <span class=k>new</span> <span class=n>AddNewAccountService</span><span class=o>(</span><span class=n>saveAccountPort</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>AddNewAccountCommand</span> <span class=n>command</span> <span class=o>=</span> <span class=n>AddNewAccountCommand</span><span class=o>.</span><span class=na>builder</span><span class=o>().</span><span class=na>initialBalance</span><span class=o>(</span><span class=s>&#34;-56.0&#34;</span><span class=o>).</span><span class=na>build</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>accountService</span><span class=o>.</span><span class=na>addNewAccount</span><span class=o>(</span><span class=n>command</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>BDDMockito</span><span class=o>.</span><span class=na>then</span><span class=o>(</span><span class=n>saveAccountPort</span><span class=o>).</span><span class=na>shouldHaveNoInteractions</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>There are several ways we can implement validations in our service. We could throw an exception detailing the validation failures, or we could return an error object which would contain the error details. For this example we will throw exceptions if validation fails -</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Test</span>
</span></span><span class=line><span class=cl><span class=nd>@DisplayName</span><span class=o>(</span><span class=s>&#34;Given account does not exist When user adds a new account with negative initial balance Then add new account fails&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>addNewAccountFailsWithNegativeInitialBalance</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=n>AddNewAccountService</span> <span class=n>accountService</span> <span class=o>=</span> <span class=k>new</span> <span class=n>AddNewAccountService</span><span class=o>(</span><span class=n>saveAccountPort</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=n>AddNewAccountCommand</span> <span class=n>command</span> <span class=o>=</span> <span class=n>AddNewAccountCommand</span><span class=o>.</span><span class=na>builder</span><span class=o>().</span><span class=na>initialBalance</span><span class=o>(</span><span class=s>&#34;-56.0&#34;</span><span class=o>).</span><span class=na>build</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>assertThatExceptionOfType</span><span class=o>(</span><span class=n>IllegalArgumentException</span><span class=o>.</span><span class=na>class</span><span class=o>)</span>
</span></span><span class=line><span class=cl>      <span class=o>.</span><span class=na>isThrownBy</span><span class=o>(()</span> <span class=o>-&gt;</span> <span class=n>accountService</span><span class=o>.</span><span class=na>addNewAccount</span><span class=o>(</span><span class=n>command</span><span class=o>));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>BDDMockito</span><span class=o>.</span><span class=na>then</span><span class=o>(</span><span class=n>saveAccountPort</span><span class=o>).</span><span class=na>shouldHaveNoInteractions</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>This test verifies that an exception is thrown when the addNewAccount method is invoked with a negative balance. It also ensures that in such cases our code does not invoke any method of the SaveAccountPort. Before we can start modifying our service to make this test pass, we have to refactor our test setup code a bit. This is because during one of our previous refactoring we moved our common test setup code into a single method which now runs before each test -</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@BeforeEach</span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>setup</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=n>AddNewAccountService</span> <span class=n>accountService</span> <span class=o>=</span> <span class=k>new</span> <span class=n>AddNewAccountService</span><span class=o>(</span><span class=n>saveAccountPort</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=n>AddNewAccountCommand</span> <span class=n>command</span> <span class=o>=</span> <span class=n>AddNewAccountCommand</span><span class=o>.</span><span class=na>builder</span><span class=o>()</span>
</span></span><span class=line><span class=cl>      <span class=o>.</span><span class=na>accountName</span><span class=o>(</span><span class=n>ACCOUNT_NAME</span><span class=o>)</span>
</span></span><span class=line><span class=cl>      <span class=o>.</span><span class=na>initialBalance</span><span class=o>(</span><span class=n>INITIAL_BALANCE</span><span class=o>)</span>
</span></span><span class=line><span class=cl>      <span class=o>.</span><span class=na>userId</span><span class=o>(</span><span class=n>USER_ID</span><span class=o>)</span>
</span></span><span class=line><span class=cl>      <span class=o>.</span><span class=na>build</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=n>accountService</span><span class=o>.</span><span class=na>addNewAccount</span><span class=o>(</span><span class=n>command</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=n>BDDMockito</span><span class=o>.</span><span class=na>then</span><span class=o>(</span><span class=n>saveAccountPort</span><span class=o>).</span><span class=na>should</span><span class=o>().</span><span class=na>saveAccount</span><span class=o>(</span><span class=n>accountArgumentCaptor</span><span class=o>.</span><span class=na>capture</span><span class=o>());</span>
</span></span><span class=line><span class=cl>  <span class=n>savedAccount</span> <span class=o>=</span> <span class=n>accountArgumentCaptor</span><span class=o>.</span><span class=na>getValue</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>This setup code is now in direct conflict with the new test that we&rsquo;ve just added - before each test it will always invoke the addNewAccount method with a valid command object, resulting in an invocation of the saveAccount method of the SaveAccountPort, causing our new test to fail.</p><p>In order to fix this, we will create a nested class within our test class where we will move our existing setup code and the passing tests -</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@ExtendWith</span><span class=o>(</span><span class=n>MockitoExtension</span><span class=o>.</span><span class=na>class</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=nd>@DisplayName</span><span class=o>(</span><span class=s>&#34;Given account does not exist&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=kd>class</span> <span class=nc>AddNewAccountServiceTest</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@Mock</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=n>SaveAccountPort</span> <span class=n>saveAccountPort</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=n>AddNewAccountService</span> <span class=n>accountService</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@BeforeEach</span>
</span></span><span class=line><span class=cl>  <span class=kt>void</span> <span class=nf>setUp</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>accountService</span> <span class=o>=</span> <span class=k>new</span> <span class=n>AddNewAccountService</span><span class=o>(</span><span class=n>saveAccountPort</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@Nested</span>
</span></span><span class=line><span class=cl>  <span class=nd>@DisplayName</span><span class=o>(</span><span class=s>&#34;When user adds a new account&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>  <span class=kd>class</span> <span class=nc>WhenUserAddsANewAccount</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=n>String</span> <span class=n>ACCOUNT_NAME</span> <span class=o>=</span> <span class=s>&#34;test account&#34;</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=n>String</span> <span class=n>INITIAL_BALANCE</span> <span class=o>=</span> <span class=s>&#34;56.0&#34;</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=n>String</span> <span class=n>USER_ID</span> <span class=o>=</span> <span class=s>&#34;some id&#34;</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>Account</span> <span class=n>savedAccount</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Captor</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>ArgumentCaptor</span><span class=o>&lt;</span><span class=n>Account</span><span class=o>&gt;</span> <span class=n>accountArgumentCaptor</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@BeforeEach</span>
</span></span><span class=line><span class=cl>    <span class=kt>void</span> <span class=nf>setUp</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>AddNewAccountCommand</span> <span class=n>command</span> <span class=o>=</span> <span class=n>AddNewAccountCommand</span><span class=o>.</span><span class=na>builder</span><span class=o>()</span>
</span></span><span class=line><span class=cl>          <span class=o>.</span><span class=na>accountName</span><span class=o>(</span><span class=n>ACCOUNT_NAME</span><span class=o>)</span>
</span></span><span class=line><span class=cl>          <span class=o>.</span><span class=na>initialBalance</span><span class=o>(</span><span class=n>INITIAL_BALANCE</span><span class=o>)</span>
</span></span><span class=line><span class=cl>          <span class=o>.</span><span class=na>userId</span><span class=o>(</span><span class=n>USER_ID</span><span class=o>)</span>
</span></span><span class=line><span class=cl>          <span class=o>.</span><span class=na>build</span><span class=o>();</span>
</span></span><span class=line><span class=cl>      <span class=n>accountService</span><span class=o>.</span><span class=na>addNewAccount</span><span class=o>(</span><span class=n>command</span><span class=o>);</span>
</span></span><span class=line><span class=cl>      <span class=n>BDDMockito</span><span class=o>.</span><span class=na>then</span><span class=o>(</span><span class=n>saveAccountPort</span><span class=o>).</span><span class=na>should</span><span class=o>().</span><span class=na>saveAccount</span><span class=o>(</span><span class=n>accountArgumentCaptor</span><span class=o>.</span><span class=na>capture</span><span class=o>());</span>
</span></span><span class=line><span class=cl>      <span class=n>savedAccount</span> <span class=o>=</span> <span class=n>accountArgumentCaptor</span><span class=o>.</span><span class=na>getValue</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Test</span>
</span></span><span class=line><span class=cl>    <span class=nd>@DisplayName</span><span class=o>(</span><span class=s>&#34;Then added account has the given name&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=kt>void</span> <span class=nf>accountAddedWithGivenName</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>BDDAssertions</span><span class=o>.</span><span class=na>then</span><span class=o>(</span><span class=n>savedAccount</span><span class=o>.</span><span class=na>getName</span><span class=o>()).</span><span class=na>isEqualTo</span><span class=o>(</span><span class=n>ACCOUNT_NAME</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Test</span>
</span></span><span class=line><span class=cl>    <span class=nd>@DisplayName</span><span class=o>(</span><span class=s>&#34;Then added account has the given initial balance&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=kt>void</span> <span class=nf>accountAddedWithGivenInitialBalance</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>BDDAssertions</span><span class=o>.</span><span class=na>then</span><span class=o>(</span><span class=n>savedAccount</span><span class=o>.</span><span class=na>getBalance</span><span class=o>()).</span><span class=na>isEqualTo</span><span class=o>(</span><span class=k>new</span> <span class=n>BigDecimal</span><span class=o>(</span><span class=n>INITIAL_BALANCE</span><span class=o>));</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Test</span>
</span></span><span class=line><span class=cl>    <span class=nd>@DisplayName</span><span class=o>(</span><span class=s>&#34;Then added account has user&#39;s id&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=kt>void</span> <span class=nf>accountAddedWithUsersId</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>BDDAssertions</span><span class=o>.</span><span class=na>then</span><span class=o>(</span><span class=n>accountArgumentCaptor</span><span class=o>.</span><span class=na>getValue</span><span class=o>().</span><span class=na>getUserId</span><span class=o>()).</span><span class=na>isEqualTo</span><span class=o>(</span><span class=n>USER_ID</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=nd>@Test</span>
</span></span><span class=line><span class=cl>  <span class=nd>@DisplayName</span><span class=o>(</span><span class=s>&#34;When user adds a new account with negative initial balance Then add new account fails&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>  <span class=kt>void</span> <span class=nf>addNewAccountFailsWithNegativeInitialBalance</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>AddNewAccountCommand</span> <span class=n>command</span> <span class=o>=</span> <span class=n>AddNewAccountCommand</span><span class=o>.</span><span class=na>builder</span><span class=o>()</span>
</span></span><span class=line><span class=cl>        <span class=o>.</span><span class=na>initialBalance</span><span class=o>(</span><span class=s>&#34;-56.0&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>        <span class=o>.</span><span class=na>build</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>assertThatExceptionOfType</span><span class=o>(</span><span class=n>IllegalArgumentException</span><span class=o>.</span><span class=na>class</span><span class=o>)</span>
</span></span><span class=line><span class=cl>        <span class=o>.</span><span class=na>isThrownBy</span><span class=o>(()</span> <span class=o>-&gt;</span> <span class=n>accountService</span><span class=o>.</span><span class=na>addNewAccount</span><span class=o>(</span><span class=n>command</span><span class=o>));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>BDDMockito</span><span class=o>.</span><span class=na>then</span><span class=o>(</span><span class=n>saveAccountPort</span><span class=o>).</span><span class=na>shouldHaveNoInteractions</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>Here are the refactoring steps that we took -</p><ol><li>We created an inner class and then marked the inner class with JUnit 5&rsquo;s @Nested annotation.</li><li>We broke down the @DisplayName label of the outermost test class and moved the &ldquo;When user adds a new account&rdquo; part to the newly introduced inner class. The reason we did this is because this inner class will contain the group of tests that will verify/validate behaviours related to a valid account creation scenario.</li><li>We moved related setup code and fields/constants into this inner class.</li><li>We have removed the &ldquo;Given account does not exist&rdquo; part from our new test. This is because the @DisplayName on the outermost test class already includes this, hence no point including it here again.</li></ol><p>This is how the tests now look like when I run them in my IntelliJ IDEA -</p><p><img loading=lazy src=https://1.bp.blogspot.com/-jCOVWBgxNBc/XqUoBStH8-I/AAAAAAAAM54/TTpb1QX-qXEIXu6YC0sizPwGheGN83vCwCK4BGAsYHg/Screenshot%2B2020-04-26%2Bat%2B08.18.15.png alt="Test Run"></p><p>As we can see from the screenshot, our test labels are also grouped and indented nicely following the structure that we created in our test code. Let&rsquo;s modify our service now to make the failing test pass -</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kt>void</span> <span class=nf>addNewAccount</span><span class=o>(</span><span class=n>AddNewAccountCommand</span> <span class=n>command</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=n>BigDecimal</span> <span class=n>initialBalance</span> <span class=o>=</span> <span class=k>new</span> <span class=n>BigDecimal</span><span class=o>(</span><span class=n>command</span><span class=o>.</span><span class=na>getInitialBalance</span><span class=o>());</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>initialBalance</span><span class=o>.</span><span class=na>compareTo</span><span class=o>(</span><span class=n>BigDecimal</span><span class=o>.</span><span class=na>ZERO</span><span class=o>)</span> <span class=o>&lt;</span> <span class=n>0</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalArgumentException</span><span class=o>(</span><span class=s>&#34;Initial balance of an account cannot be negative&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=n>saveAccountPort</span><span class=o>.</span><span class=na>saveAccount</span><span class=o>(</span>
</span></span><span class=line><span class=cl>    <span class=k>new</span> <span class=n>Account</span><span class=o>(</span>
</span></span><span class=line><span class=cl>      <span class=n>command</span><span class=o>.</span><span class=na>getAccountName</span><span class=o>(),</span>
</span></span><span class=line><span class=cl>      <span class=n>initialBalance</span><span class=o>,</span>
</span></span><span class=line><span class=cl>      <span class=n>command</span><span class=o>.</span><span class=na>getUserId</span><span class=o>()</span>
</span></span><span class=line><span class=cl>    <span class=o>)</span>
</span></span><span class=line><span class=cl>  <span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>With that all of our tests start passing again. Next step is to look for ways to improve the existing implementation if possible. If not, then we will move on to the implementation of the final scenario which is also a validation rule -</p><blockquote><p>Given account with the same name exists
When user adds a new account
Then add new account fails</p></blockquote><p>As always, let&rsquo;s write a test to capture this -</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Test</span>
</span></span><span class=line><span class=cl><span class=nd>@DisplayName</span><span class=o>(</span><span class=s>&#34;Given account with the same name exists When user adds a new account Then add new account fails&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>addNewAccountFailsForDuplicateAccounts</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=n>AddNewAccountCommand</span> <span class=n>command</span> <span class=o>=</span> <span class=n>AddNewAccountCommand</span><span class=o>.</span><span class=na>builder</span><span class=o>()</span>
</span></span><span class=line><span class=cl>      <span class=o>.</span><span class=na>accountName</span><span class=o>(</span><span class=s>&#34;existing name&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>      <span class=o>.</span><span class=na>build</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=n>AddNewAccountService</span> <span class=n>accountService</span> <span class=o>=</span> <span class=k>new</span> <span class=n>AddNewAccountService</span><span class=o>(</span><span class=n>saveAccountPort</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>assertThatExceptionOfType</span><span class=o>(</span><span class=n>IllegalArgumentException</span><span class=o>.</span><span class=na>class</span><span class=o>)</span>
</span></span><span class=line><span class=cl>      <span class=o>.</span><span class=na>isThrownBy</span><span class=o>(()</span> <span class=o>-&gt;</span> <span class=n>accountService</span><span class=o>.</span><span class=na>addNewAccount</span><span class=o>(</span><span class=n>command</span><span class=o>));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>BDDMockito</span><span class=o>.</span><span class=na>then</span><span class=o>(</span><span class=n>saveAccountPort</span><span class=o>).</span><span class=na>shouldHaveNoInteractions</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>First thing we have to figure out now is to how to find an existing account. Since this will involve querying our persistent data store, we will introduce an interface -</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>interface</span> <span class=nc>FindAccountPort</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>Account</span> <span class=nf>findAccountByName</span><span class=o>(</span><span class=n>String</span> <span class=n>accountName</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>and inject it into our AddNewAccountService -</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@RequiredArgsConstructor</span>
</span></span><span class=line><span class=cl><span class=kd>class</span> <span class=nc>AddNewAccountService</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kd>final</span> <span class=n>SaveAccountPort</span> <span class=n>saveAccountPort</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kd>final</span> <span class=n>FindAccountPort</span> <span class=n>findAccountPort</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=c1>// Rest of the code
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>}</span>
</span></span></code></pre></div><p>and modify our test -</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Test</span>
</span></span><span class=line><span class=cl><span class=nd>@DisplayName</span><span class=o>(</span><span class=s>&#34;Given account with the same name exists When user adds a new account Then add new account fails&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>addNewAccountFailsForDuplicateAccounts</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=n>String</span> <span class=n>existingAccountName</span> <span class=o>=</span> <span class=s>&#34;existing name&#34;</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=n>AddNewAccountCommand</span> <span class=n>command</span> <span class=o>=</span> <span class=n>AddNewAccountCommand</span><span class=o>.</span><span class=na>builder</span><span class=o>()</span>
</span></span><span class=line><span class=cl>      <span class=o>.</span><span class=na>initialBalance</span><span class=o>(</span><span class=s>&#34;0&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>      <span class=o>.</span><span class=na>accountName</span><span class=o>(</span><span class=n>existingAccountName</span><span class=o>)</span>
</span></span><span class=line><span class=cl>      <span class=o>.</span><span class=na>build</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=n>given</span><span class=o>(</span><span class=n>findAccountPort</span><span class=o>.</span><span class=na>findAccountByName</span><span class=o>(</span><span class=n>existingAccountName</span><span class=o>)).</span><span class=na>willReturn</span><span class=o>(</span><span class=n>mock</span><span class=o>(</span><span class=n>Account</span><span class=o>.</span><span class=na>class</span><span class=o>));</span>
</span></span><span class=line><span class=cl>  <span class=n>AddNewAccountService</span> <span class=n>accountService</span> <span class=o>=</span> <span class=k>new</span> <span class=n>AddNewAccountService</span><span class=o>(</span><span class=n>saveAccountPort</span><span class=o>,</span>
</span></span><span class=line><span class=cl>      <span class=n>findAccountPort</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>assertThatExceptionOfType</span><span class=o>(</span><span class=n>IllegalArgumentException</span><span class=o>.</span><span class=na>class</span><span class=o>)</span>
</span></span><span class=line><span class=cl>      <span class=o>.</span><span class=na>isThrownBy</span><span class=o>(()</span> <span class=o>-&gt;</span> <span class=n>accountService</span><span class=o>.</span><span class=na>addNewAccount</span><span class=o>(</span><span class=n>command</span><span class=o>));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>BDDMockito</span><span class=o>.</span><span class=na>then</span><span class=o>(</span><span class=n>saveAccountPort</span><span class=o>).</span><span class=na>shouldHaveNoInteractions</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>The last change to our AddNewAccountService will also require changes to our existing tests, mainly the place where we were instantiating an instance of that class. We will, however, change a bit more than that -</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@ExtendWith</span><span class=o>(</span><span class=n>MockitoExtension</span><span class=o>.</span><span class=na>class</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=kd>class</span> <span class=nc>AddNewAccountServiceTest</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@Mock</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=n>SaveAccountPort</span> <span class=n>saveAccountPort</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@Mock</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=n>FindAccountPort</span> <span class=n>findAccountPort</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@Nested</span>
</span></span><span class=line><span class=cl>  <span class=nd>@DisplayName</span><span class=o>(</span><span class=s>&#34;Given account does not exist&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>  <span class=kd>class</span> <span class=nc>AccountDoesNotExist</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>AddNewAccountService</span> <span class=n>accountService</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@BeforeEach</span>
</span></span><span class=line><span class=cl>    <span class=kt>void</span> <span class=nf>setUp</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>accountService</span> <span class=o>=</span> <span class=k>new</span> <span class=n>AddNewAccountService</span><span class=o>(</span><span class=n>saveAccountPort</span><span class=o>,</span> <span class=n>findAccountPort</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Nested</span>
</span></span><span class=line><span class=cl>    <span class=nd>@DisplayName</span><span class=o>(</span><span class=s>&#34;When user adds a new account&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=kd>class</span> <span class=nc>WhenUserAddsANewAccount</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=n>String</span> <span class=n>ACCOUNT_NAME</span> <span class=o>=</span> <span class=s>&#34;test account&#34;</span><span class=o>;</span>
</span></span><span class=line><span class=cl>      <span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=n>String</span> <span class=n>INITIAL_BALANCE</span> <span class=o>=</span> <span class=s>&#34;56.0&#34;</span><span class=o>;</span>
</span></span><span class=line><span class=cl>      <span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=n>String</span> <span class=n>USER_ID</span> <span class=o>=</span> <span class=s>&#34;some id&#34;</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=kd>private</span> <span class=n>Account</span> <span class=n>savedAccount</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=nd>@Captor</span>
</span></span><span class=line><span class=cl>      <span class=kd>private</span> <span class=n>ArgumentCaptor</span><span class=o>&lt;</span><span class=n>Account</span><span class=o>&gt;</span> <span class=n>accountArgumentCaptor</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=nd>@BeforeEach</span>
</span></span><span class=line><span class=cl>      <span class=kt>void</span> <span class=nf>setUp</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>AddNewAccountCommand</span> <span class=n>command</span> <span class=o>=</span> <span class=n>AddNewAccountCommand</span><span class=o>.</span><span class=na>builder</span><span class=o>()</span>
</span></span><span class=line><span class=cl>            <span class=o>.</span><span class=na>accountName</span><span class=o>(</span><span class=n>ACCOUNT_NAME</span><span class=o>)</span>
</span></span><span class=line><span class=cl>            <span class=o>.</span><span class=na>initialBalance</span><span class=o>(</span><span class=n>INITIAL_BALANCE</span><span class=o>)</span>
</span></span><span class=line><span class=cl>            <span class=o>.</span><span class=na>userId</span><span class=o>(</span><span class=n>USER_ID</span><span class=o>)</span>
</span></span><span class=line><span class=cl>            <span class=o>.</span><span class=na>build</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>accountService</span><span class=o>.</span><span class=na>addNewAccount</span><span class=o>(</span><span class=n>command</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>BDDMockito</span><span class=o>.</span><span class=na>then</span><span class=o>(</span><span class=n>saveAccountPort</span><span class=o>).</span><span class=na>should</span><span class=o>().</span><span class=na>saveAccount</span><span class=o>(</span><span class=n>accountArgumentCaptor</span><span class=o>.</span><span class=na>capture</span><span class=o>());</span>
</span></span><span class=line><span class=cl>        <span class=n>savedAccount</span> <span class=o>=</span> <span class=n>accountArgumentCaptor</span><span class=o>.</span><span class=na>getValue</span><span class=o>();</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=nd>@Test</span>
</span></span><span class=line><span class=cl>      <span class=nd>@DisplayName</span><span class=o>(</span><span class=s>&#34;Then added account has the given name&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>      <span class=kt>void</span> <span class=nf>accountAddedWithGivenName</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>BDDAssertions</span><span class=o>.</span><span class=na>then</span><span class=o>(</span><span class=n>savedAccount</span><span class=o>.</span><span class=na>getName</span><span class=o>()).</span><span class=na>isEqualTo</span><span class=o>(</span><span class=n>ACCOUNT_NAME</span><span class=o>);</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=nd>@Test</span>
</span></span><span class=line><span class=cl>      <span class=nd>@DisplayName</span><span class=o>(</span><span class=s>&#34;Then added account has the given initial balance&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>      <span class=kt>void</span> <span class=nf>accountAddedWithGivenInitialBalance</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>BDDAssertions</span><span class=o>.</span><span class=na>then</span><span class=o>(</span><span class=n>savedAccount</span><span class=o>.</span><span class=na>getBalance</span><span class=o>()).</span><span class=na>isEqualTo</span><span class=o>(</span><span class=k>new</span> <span class=n>BigDecimal</span><span class=o>(</span><span class=n>INITIAL_BALANCE</span><span class=o>));</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=nd>@Test</span>
</span></span><span class=line><span class=cl>      <span class=nd>@DisplayName</span><span class=o>(</span><span class=s>&#34;Then added account has user&#39;s id&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>      <span class=kt>void</span> <span class=nf>accountAddedWithUsersId</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>BDDAssertions</span><span class=o>.</span><span class=na>then</span><span class=o>(</span><span class=n>accountArgumentCaptor</span><span class=o>.</span><span class=na>getValue</span><span class=o>().</span><span class=na>getUserId</span><span class=o>()).</span><span class=na>isEqualTo</span><span class=o>(</span><span class=n>USER_ID</span><span class=o>);</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Test</span>
</span></span><span class=line><span class=cl>    <span class=nd>@DisplayName</span><span class=o>(</span><span class=s>&#34;When user adds a new account with negative initial balance Then add new account fails&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=kt>void</span> <span class=nf>addNewAccountFailsWithNegativeInitialBalance</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>AddNewAccountCommand</span> <span class=n>command</span> <span class=o>=</span> <span class=n>AddNewAccountCommand</span><span class=o>.</span><span class=na>builder</span><span class=o>()</span>
</span></span><span class=line><span class=cl>          <span class=o>.</span><span class=na>initialBalance</span><span class=o>(</span><span class=s>&#34;-56.0&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>          <span class=o>.</span><span class=na>build</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=n>assertThatExceptionOfType</span><span class=o>(</span><span class=n>IllegalArgumentException</span><span class=o>.</span><span class=na>class</span><span class=o>)</span>
</span></span><span class=line><span class=cl>          <span class=o>.</span><span class=na>isThrownBy</span><span class=o>(()</span> <span class=o>-&gt;</span> <span class=n>accountService</span><span class=o>.</span><span class=na>addNewAccount</span><span class=o>(</span><span class=n>command</span><span class=o>));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=n>BDDMockito</span><span class=o>.</span><span class=na>then</span><span class=o>(</span><span class=n>saveAccountPort</span><span class=o>).</span><span class=na>shouldHaveNoInteractions</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@Test</span>
</span></span><span class=line><span class=cl>  <span class=nd>@DisplayName</span><span class=o>(</span><span class=s>&#34;Given account with the same name exists When user adds a new account Then add new account fails&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>  <span class=kt>void</span> <span class=nf>addNewAccountFailsForDuplicateAccounts</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>String</span> <span class=n>existingAccountName</span> <span class=o>=</span> <span class=s>&#34;existing name&#34;</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=n>AddNewAccountCommand</span> <span class=n>command</span> <span class=o>=</span> <span class=n>AddNewAccountCommand</span><span class=o>.</span><span class=na>builder</span><span class=o>()</span>
</span></span><span class=line><span class=cl>        <span class=o>.</span><span class=na>initialBalance</span><span class=o>(</span><span class=s>&#34;0&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>        <span class=o>.</span><span class=na>accountName</span><span class=o>(</span><span class=n>existingAccountName</span><span class=o>)</span>
</span></span><span class=line><span class=cl>        <span class=o>.</span><span class=na>build</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>given</span><span class=o>(</span><span class=n>findAccountPort</span><span class=o>.</span><span class=na>findAccountByName</span><span class=o>(</span><span class=n>existingAccountName</span><span class=o>)).</span><span class=na>willReturn</span><span class=o>(</span><span class=n>mock</span><span class=o>(</span><span class=n>Account</span><span class=o>.</span><span class=na>class</span><span class=o>));</span>
</span></span><span class=line><span class=cl>    <span class=n>AddNewAccountService</span> <span class=n>accountService</span> <span class=o>=</span> <span class=k>new</span> <span class=n>AddNewAccountService</span><span class=o>(</span><span class=n>saveAccountPort</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=n>findAccountPort</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>assertThatExceptionOfType</span><span class=o>(</span><span class=n>IllegalArgumentException</span><span class=o>.</span><span class=na>class</span><span class=o>)</span>
</span></span><span class=line><span class=cl>        <span class=o>.</span><span class=na>isThrownBy</span><span class=o>(()</span> <span class=o>-&gt;</span> <span class=n>accountService</span><span class=o>.</span><span class=na>addNewAccount</span><span class=o>(</span><span class=n>command</span><span class=o>));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>BDDMockito</span><span class=o>.</span><span class=na>then</span><span class=o>(</span><span class=n>saveAccountPort</span><span class=o>).</span><span class=na>shouldHaveNoInteractions</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>Here&rsquo;s what we did -</p><blockquote><p>We created another inner class, marked it as @Nested, and moved our existing passing tests into this. This group of tests test the behaviour of adding a new account when no account with the given name already exists.
We have moved our test set up code into the newly introduced inner class as they are also related to the &ldquo;no account with the given name already exists&rdquo; case.
For the same reason as above, we have also moved our @DisplayName annotation from the top level test class to the newly introduced inner class.</p></blockquote><p>After our refactoring we quickly run our tests to see if everything is working as expected (failing test failing, passing tests passing), and then move on to modify our service -</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@RequiredArgsConstructor</span>
</span></span><span class=line><span class=cl><span class=kd>class</span> <span class=nc>AddNewAccountService</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kd>final</span> <span class=n>SaveAccountPort</span> <span class=n>saveAccountPort</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kd>final</span> <span class=n>FindAccountPort</span> <span class=n>findAccountPort</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kt>void</span> <span class=nf>addNewAccount</span><span class=o>(</span><span class=n>AddNewAccountCommand</span> <span class=n>command</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>BigDecimal</span> <span class=n>initialBalance</span> <span class=o>=</span> <span class=k>new</span> <span class=n>BigDecimal</span><span class=o>(</span><span class=n>command</span><span class=o>.</span><span class=na>getInitialBalance</span><span class=o>());</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>initialBalance</span><span class=o>.</span><span class=na>compareTo</span><span class=o>(</span><span class=n>BigDecimal</span><span class=o>.</span><span class=na>ZERO</span><span class=o>)</span> <span class=o>&lt;</span> <span class=n>0</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalArgumentException</span><span class=o>(</span><span class=s>&#34;Initial balance of an account cannot be negative&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>findAccountPort</span><span class=o>.</span><span class=na>findAccountByName</span><span class=o>(</span><span class=n>command</span><span class=o>.</span><span class=na>getAccountName</span><span class=o>())</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalArgumentException</span><span class=o>(</span><span class=s>&#34;An account with given name already exists&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=n>saveAccountPort</span><span class=o>.</span><span class=na>saveAccount</span><span class=o>(</span>
</span></span><span class=line><span class=cl>        <span class=k>new</span> <span class=n>Account</span><span class=o>(</span>
</span></span><span class=line><span class=cl>            <span class=n>command</span><span class=o>.</span><span class=na>getAccountName</span><span class=o>(),</span>
</span></span><span class=line><span class=cl>            <span class=n>initialBalance</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>command</span><span class=o>.</span><span class=na>getUserId</span><span class=o>()</span>
</span></span><span class=line><span class=cl>        <span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@Builder</span>
</span></span><span class=line><span class=cl>  <span class=nd>@Getter</span>
</span></span><span class=line><span class=cl>  <span class=kd>static</span> <span class=kd>class</span> <span class=nc>AddNewAccountCommand</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>final</span> <span class=n>String</span> <span class=n>userId</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>final</span> <span class=n>String</span> <span class=n>accountName</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>final</span> <span class=n>String</span> <span class=n>initialBalance</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>All of our tests should now be green.</p><p>Since our use case implementation is now complete, we will look at our implementation for one last time and see if we can improve anything. If not, our use case implementation is now complete!</p><p>To summarise, this is what we did throughout this article -</p><ol><li>We have written down a use case that we would like to implement</li><li>We have added a failing test, labelling it with a human-readable name</li><li>We have added the minimal amount of code needed to make the failing test pass</li><li>As soon as we had more than one passing tests, after we made each failing test pass, we looked at our implementation and tried to improve it</li><li>When writing the tests we tried writing them in such a way so that our use case specifications are reflected in the test code. For this we have used -</li><li>The @DisplayName annotation to assign human-readable names to our tests</li><li>Used @Nested to group related tests in a hierarchical structure, reflecting our use case setup</li><li>Used BDD-driven API from Mockito and AssertJ to verify the expected behaviours</li></ol><p>When should we follow this style of writing automated tests? The answer to this question is the same as every other usage questions in Software Engineering - it depends. I personally prefer this style when I am working with an application which has complex business/domain rules, which is intended to be maintained over a long period, for which a close collaboration with the business is required, and many other factors (i.e., application architecture, team adoption etc.).</p><p>As always, the full working example has been pushed to <a href=https://github.com/sayembd/java-examples/tree/master/executable-specification-example>Github</a>.</p><p>Until next time!</p></div><footer class=post-footer><ul class=post-tags></ul><nav class=paginav><a class=prev href=https://sayembd.github.io/posts/how-to-build-observable-system-an-introduction-to-observability/><span class=title>« Prev</span><br><span>How to Build Observable Systems - An Introduction to Observability</span></a></nav><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share Writing Executable Specifications With Junit5 Mockito and AssertJ on twitter" href="https://twitter.com/intent/tweet/?text=Writing%20Executable%20Specifications%20With%20Junit5%20Mockito%20and%20AssertJ&url=https%3a%2f%2fsayembd.github.io%2fposts%2fwriting-executable-specifications-with-junit5-mockito-and-assertj%2f&hashtags="><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Writing Executable Specifications With Junit5 Mockito and AssertJ on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fsayembd.github.io%2fposts%2fwriting-executable-specifications-with-junit5-mockito-and-assertj%2f&title=Writing%20Executable%20Specifications%20With%20Junit5%20Mockito%20and%20AssertJ&summary=Writing%20Executable%20Specifications%20With%20Junit5%20Mockito%20and%20AssertJ&source=https%3a%2f%2fsayembd.github.io%2fposts%2fwriting-executable-specifications-with-junit5-mockito-and-assertj%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Writing Executable Specifications With Junit5 Mockito and AssertJ on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fsayembd.github.io%2fposts%2fwriting-executable-specifications-with-junit5-mockito-and-assertj%2f&title=Writing%20Executable%20Specifications%20With%20Junit5%20Mockito%20and%20AssertJ"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Writing Executable Specifications With Junit5 Mockito and AssertJ on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fsayembd.github.io%2fposts%2fwriting-executable-specifications-with-junit5-mockito-and-assertj%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Writing Executable Specifications With Junit5 Mockito and AssertJ on whatsapp" href="https://api.whatsapp.com/send?text=Writing%20Executable%20Specifications%20With%20Junit5%20Mockito%20and%20AssertJ%20-%20https%3a%2f%2fsayembd.github.io%2fposts%2fwriting-executable-specifications-with-junit5-mockito-and-assertj%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Writing Executable Specifications With Junit5 Mockito and AssertJ on telegram" href="https://telegram.me/share/url?text=Writing%20Executable%20Specifications%20With%20Junit5%20Mockito%20and%20AssertJ&url=https%3a%2f%2fsayembd.github.io%2fposts%2fwriting-executable-specifications-with-junit5-mockito-and-assertj%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></div></footer></article></main><footer class=footer><span>&copy; 2022 <a href=https://sayembd.github.io>Random Musings</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>