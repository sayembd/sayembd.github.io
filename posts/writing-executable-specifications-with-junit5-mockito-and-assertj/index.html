<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Writing Executable Specifications With Junit5 Mockito and AssertJ | Random Musings</title><meta name=keywords content><meta name=description content="A hands-on tutorial demonstrating a clean way to write unit tests as Executable Specifications using JUnit 5, Mockito, and AssertJ."><meta name=author content><link rel=canonical href=https://sayembd.github.io/posts/writing-executable-specifications-with-junit5-mockito-and-assertj/><link crossorigin=anonymous href=/assets/css/stylesheet.min.5fc7093e58e5038c03e70b417ab8f50482ebc513e1b1e74b0e42a004bc7ce7ed.css integrity="sha256-X8cJPljlA4wD5wtBerj1BILrxRPhsedLDkKgBLx85+0=" rel="preload stylesheet" as=style><link rel=icon href=https://sayembd.github.io/favicon.ico><link rel=apple-touch-icon href=https://sayembd.github.io/apple-touch-icon.png><meta name=twitter:title content="Writing Executable Specifications With Junit5 Mockito and AssertJ | Random Musings"><meta name=twitter:description content="A hands-on tutorial demonstrating a clean way to write unit tests as Executable Specifications using JUnit 5, Mockito, and AssertJ."><meta name=twitter:site content="@novoreorx"><meta name=twitter:creator content="@novoreorx"><meta property="og:title" content="Writing Executable Specifications With Junit5 Mockito and AssertJ | Random Musings"><meta property="og:description" content="A hands-on tutorial demonstrating a clean way to write unit tests as Executable Specifications using JUnit 5, Mockito, and AssertJ."><meta property="og:type" content="article"><meta property="og:url" content="https://sayembd.github.io/posts/writing-executable-specifications-with-junit5-mockito-and-assertj/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-04-26T22:40:20+02:00"><meta property="article:modified_time" content="2020-04-26T22:40:20+02:00"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://sayembd.github.io/posts/"},{"@type":"ListItem","position":3,"name":"Writing Executable Specifications With Junit5 Mockito and AssertJ","item":"https://sayembd.github.io/posts/writing-executable-specifications-with-junit5-mockito-and-assertj/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Writing Executable Specifications With Junit5 Mockito and AssertJ | Random Musings","name":"Writing Executable Specifications With Junit5 Mockito and AssertJ","description":"A hands-on tutorial demonstrating a clean way to write unit tests as Executable Specifications using JUnit 5, Mockito, and AssertJ.","keywords":[],"wordCount":"3542","inLanguage":"en","datePublished":"2020-04-26T22:40:20+02:00","dateModified":"2020-04-26T22:40:20+02:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://sayembd.github.io/posts/writing-executable-specifications-with-junit5-mockito-and-assertj/"},"publisher":{"@type":"Organization","name":"Random Musings","logo":{"@type":"ImageObject","url":"https://sayembd.github.io/favicon.ico"}}}</script><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript></head><body id=top><script data-no-instant>function switchTheme(e){switch(e){case"light":document.body.classList.remove("dark");break;case"dark":document.body.classList.add("dark");break;default:window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")}}function isDarkTheme(){return document.body.className.includes("dark")}function getPrefTheme(){return localStorage.getItem("pref-theme")}function setPrefTheme(e){switchTheme(e),localStorage.setItem("pref-theme",e)}const toggleThemeCallbacks={};toggleThemeCallbacks.main=e=>{setPrefTheme(e?"light":"dark")},window.addEventListener("toggle-theme",function(){const e=isDarkTheme();for(const t in toggleThemeCallbacks)toggleThemeCallbacks[t](e)});function toggleThemeListener(){window.dispatchEvent(new CustomEvent("toggle-theme"))}</script><script>(function(){const t="light",e=getPrefTheme(),n=e||t;switchTheme(n)})()</script><header class=header><nav class=nav><div class=logo><a href=https://sayembd.github.io accesskey=h title="Random Musings (Alt + H)">Random Musings</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=https://sayembd.github.io/about-me/ title="About Me">About Me</a></li><li><a href=https://sayembd.github.io/index.xml/ title=RSS>RSS</a></li></ul></nav></header><main class="main post"><article class=post-single><header class=post-header><h1 class=post-title>Writing Executable Specifications With Junit5 Mockito and AssertJ</h1><div class=post-description>A hands-on tutorial demonstrating a clean way to write unit tests as Executable Specifications using JUnit 5, Mockito, and AssertJ.</div><div class=post-meta><span class=meta-item><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar" style="user-select:text"><rect x="3" y="4" width="18" height="18" rx="2" ry="2" style="user-select:text"/><line x1="16" y1="2" x2="16" y2="6" style="user-select:text"/><line x1="8" y1="2" x2="8" y2="6" style="user-select:text"/><line x1="3" y1="10" x2="21" y2="10" style="user-select:text"/></svg><span>April 26, 2020</span></span></div></header><div class=post-content><p>Executable Specifications are tests that can also serve as design specifications. They enable technical and business teams to get on the same page by enabling the use of a common language (in DDD-world this is also known as <a href=https://martinfowler.com/bliki/UbiquitousLanguage.html>Ubiquitous Language</a>). They function as documentations for the future maintainers of the code. In this article we will see an opinionated way of writing automated tests which could also function as Executable Specifications.</p><p>Let&rsquo;s start with an example. Suppose we are creating an accounting system for a business. The system will allow its users to record incomes and expenses into different accounts. Before users can start recording incomes and expenses, they should be able to add new accounts into the system. Suppose that the specification for the &ldquo;Add New Account&rdquo; use case looks like below -</p><blockquote><p>Scenario 1
Given account does not exist
When user adds a new account
Then added account has the given name
Then added account has the given initial balance
Then added account has user&rsquo;s id</p><p>Scenario 2
Given account does not exist
When user adds a new account with negative initial balance
Then add new account fails</p><p>Scenario 3
Given account with the same name exists
When user adds a new account
Then add new account fails</p></blockquote><p>In order to create a new account the user needs to enter an account name and an initial balance into the system. The system will then create the account if no account with the given name already exists and the given initial balance is positive.</p><p>We will first write down a test which will capture the first &ldquo;Given-When-Then&rdquo; part of the first scenario. This is how it looks like -</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>class</span> <span class=nc>AddNewAccountTest</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@Test</span>
</span></span><span class=line><span class=cl>  <span class=nd>@DisplayName</span><span class=o>(</span><span class=s>&#34;Given account does not exist
</span></span></span><span class=line><span class=cl><span class=s>      When user adds a new account Then added account has the given name&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>  <span class=kt>void</span> <span class=nf>accountAddedWithGivenName</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>The <a href=https://junit.org/junit5/docs/5.0.3/api/org/junit/jupiter/api/DisplayName.html>@DisplayName</a> annotation was introduced in JUnit 5. It assigns a human-readable name to a test. This is the label that we would see when we execute this test e.g., in an IDE like IntelliJ IDEA.</p><p>We will now create a class which will be responsible for adding the account -</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>class</span> <span class=nc>AddNewAccountService</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kt>void</span> <span class=nf>addNewAccount</span><span class=o>(</span><span class=n>String</span> <span class=n>accountName</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>The class defines a single method which accepts the name of an account and will be responsible for creating it i.e., saving it to a persistent data store. Since we decided to call this class AddNewAccountService, we will also rename our test to AddNewAccountServiceTest to follow the naming convention used in the JUnit world.</p><p>We can now proceed with writing our test -</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>class</span> <span class=nc>AddNewAccountServiceTest</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@Test</span>
</span></span><span class=line><span class=cl>  <span class=nd>@DisplayName</span><span class=o>(</span><span class=s>&#34;Given account does not exist When user adds a new account Then added account has the given name&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>  <span class=kt>void</span> <span class=nf>accountAddedWithGivenName</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>AddNewAccountService</span> <span class=n>accountService</span> <span class=o>=</span> <span class=k>new</span> <span class=n>AddNewAccountService</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>accountService</span><span class=o>.</span><span class=na>addNewAccount</span><span class=o>(</span><span class=s>&#34;test account&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1>// What to test?
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>What should we test/verify to ensure that the scenario is properly implemented? If we read our specification again, it is clear that we want to create an &ldquo;Account&rdquo; with a user-given name, hence this is what we should try to test here. In order to do this, we will have to first create a class which will represent an Account -</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@AllArgsConstructor</span>
</span></span><span class=line><span class=cl><span class=kd>class</span> <span class=nc>Account</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=n>String</span> <span class=n>name</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>The Account class has only one property called name. It will have other fields like user id and balance, but we are not testing those at the moment, hence we will not add them to the class right away.</p><p>Now that we have created the Account class, how do we save it, and more importantly, how do we test that the account being saved has the user-given name? There are many approaches to do this, and my preferred one is to define an interface which will encapsulate this saving action. Let&rsquo;s go ahead and create it -</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>interface</span> <span class=nc>SaveAccountPort</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kt>void</span> <span class=nf>saveAccount</span><span class=o>(</span><span class=n>Account</span> <span class=n>account</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>The AddNewAccountService will be injected with an implementation of this interface via constructor injection -</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@RequiredArgsConstructor</span>
</span></span><span class=line><span class=cl><span class=kd>class</span> <span class=nc>AddNewAccountService</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kd>final</span> <span class=n>SaveAccountPort</span> <span class=n>saveAccountPort</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kt>void</span> <span class=nf>addNewAccount</span><span class=o>(</span><span class=n>String</span> <span class=n>accountName</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>For testing purposes we will create a mock implementation with the help of Mockito so that we don&rsquo;t have to worry about the actual implementation details -</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@ExtendWith</span><span class=o>(</span><span class=n>MockitoExtension</span><span class=o>.</span><span class=na>class</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=kd>class</span> <span class=nc>AddNewAccountServiceTest</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@Mock</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=n>SaveAccountPort</span> <span class=n>saveAccountPort</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@Test</span>
</span></span><span class=line><span class=cl>  <span class=nd>@DisplayName</span><span class=o>(</span><span class=s>&#34;Given account does not exist When user adds a new account Then added account has the given name&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>  <span class=kt>void</span> <span class=nf>accountAddedWithGivenName</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>AddNewAccountService</span> <span class=n>accountService</span> <span class=o>=</span> <span class=k>new</span> <span class=n>AddNewAccountService</span><span class=o>(</span><span class=n>saveAccountPort</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>accountService</span><span class=o>.</span><span class=na>addNewAccount</span><span class=o>(</span><span class=s>&#34;test account&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1>// What to test?
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>Our test setup is now complete. We now expect our method under test, the addNewAccount method of the AddNewAccountService class, to invoke the saveAccount method of the SaveAccountPort, with an Account object whose name is set to the one passed to the method. Let&rsquo;s codify this in our test -</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@ExtendWith</span><span class=o>(</span><span class=n>MockitoExtension</span><span class=o>.</span><span class=na>class</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=kd>class</span> <span class=nc>AddNewAccountServiceTest</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@Mock</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=n>SaveAccountPort</span> <span class=n>saveAccountPort</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@Captor</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=n>ArgumentCaptor</span><span class=o>&lt;</span><span class=n>Account</span><span class=o>&gt;</span> <span class=n>accountArgumentCaptor</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@Test</span>
</span></span><span class=line><span class=cl>  <span class=nd>@DisplayName</span><span class=o>(</span><span class=s>&#34;Given account does not exist When user adds a new account Then added account has the given name&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>  <span class=kt>void</span> <span class=nf>accountAddedWithGivenName</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>AddNewAccountService</span> <span class=n>accountService</span> <span class=o>=</span> <span class=k>new</span> <span class=n>AddNewAccountService</span><span class=o>(</span><span class=n>saveAccountPort</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>accountService</span><span class=o>.</span><span class=na>addNewAccount</span><span class=o>(</span><span class=s>&#34;test account&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>BDDMockito</span><span class=o>.</span><span class=na>then</span><span class=o>(</span><span class=n>saveAccountPort</span><span class=o>).</span><span class=na>should</span><span class=o>().</span><span class=na>saveAccount</span><span class=o>(</span><span class=n>accountArgumentCaptor</span><span class=o>.</span><span class=na>capture</span><span class=o>());</span>
</span></span><span class=line><span class=cl>    <span class=n>BDDAssertions</span><span class=o>.</span><span class=na>then</span><span class=o>(</span><span class=n>accountArgumentCaptor</span><span class=o>.</span><span class=na>getValue</span><span class=o>().</span><span class=na>getName</span><span class=o>()).</span><span class=na>isEqualTo</span><span class=o>(</span><span class=s>&#34;test account&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>The line below -</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>BDDMockito</span><span class=o>.</span><span class=na>then</span><span class=o>(</span><span class=n>saveAccountPort</span><span class=o>)</span>
</span></span><span class=line><span class=cl>  <span class=o>.</span><span class=na>should</span><span class=o>()</span>
</span></span><span class=line><span class=cl>  <span class=o>.</span><span class=na>saveAccount</span><span class=o>(</span><span class=n>accountArgumentCaptor</span><span class=o>.</span><span class=na>capture</span><span class=o>());</span>
</span></span></code></pre></div><p>verifies that the saveAccount method of the SaveAccountPort is invoked once the method under test is invoked. We also capture the account argument that is passed to the saveAccount method with our argument captor. The next line -</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>BDDAssertions</span><span class=o>.</span><span class=na>then</span><span class=o>(</span><span class=n>accountArgumentCaptor</span><span class=o>.</span><span class=na>getValue</span><span class=o>().</span><span class=na>getName</span><span class=o>())</span>
</span></span><span class=line><span class=cl>  <span class=o>.</span><span class=na>isEqualTo</span><span class=o>(</span><span class=s>&#34;test account&#34;</span><span class=o>);</span>
</span></span></code></pre></div><p>then verifies that the captured account argument has the same name as the one that was passed in the test.</p><p>In order to make this test pass, the minimal code that is needed in our method under test is as follows -</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@RequiredArgsConstructor</span>
</span></span><span class=line><span class=cl><span class=kd>class</span> <span class=nc>AddNewAccountService</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kd>final</span> <span class=n>SaveAccountPort</span> <span class=n>saveAccountPort</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kt>void</span> <span class=nf>addNewAccount</span><span class=o>(</span><span class=n>String</span> <span class=n>accountName</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>saveAccountPort</span><span class=o>.</span><span class=na>saveAccount</span><span class=o>(</span><span class=k>new</span> <span class=n>Account</span><span class=o>(</span><span class=n>accountName</span><span class=o>));</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>With that, our test starts to pass!</p><p>Let&rsquo;s move on to the second &ldquo;Then&rdquo; part of the first scenario, which says -</p><blockquote><p>Then added account has the given initial balance
Let&rsquo;s write another test which will verify this part -</p></blockquote><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Test</span>
</span></span><span class=line><span class=cl><span class=nd>@DisplayName</span><span class=o>(</span><span class=s>&#34;Given account does not exist When user adds a new account Then added account has the given initial balance&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>accountAddedWithGivenInitialBalance</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=n>AddNewAccountService</span> <span class=n>accountService</span> <span class=o>=</span> <span class=k>new</span> <span class=n>AddNewAccountService</span><span class=o>(</span><span class=n>saveAccountPort</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>accountService</span><span class=o>.</span><span class=na>addNewAccount</span><span class=o>(</span><span class=s>&#34;test account&#34;</span><span class=o>,</span> <span class=s>&#34;56.0&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=n>BDDMockito</span><span class=o>.</span><span class=na>then</span><span class=o>(</span><span class=n>saveAccountPort</span><span class=o>).</span><span class=na>should</span><span class=o>().</span><span class=na>saveAccount</span><span class=o>(</span><span class=n>accountArgumentCaptor</span><span class=o>.</span><span class=na>capture</span><span class=o>());</span>
</span></span><span class=line><span class=cl>  <span class=n>BDDAssertions</span><span class=o>.</span><span class=na>then</span><span class=o>(</span><span class=n>accountArgumentCaptor</span><span class=o>.</span><span class=na>getValue</span><span class=o>().</span><span class=na>getBalance</span><span class=o>())</span>
</span></span><span class=line><span class=cl>        <span class=o>.</span><span class=na>isEqualTo</span><span class=o>(</span><span class=k>new</span> <span class=n>BigDecimal</span><span class=o>(</span><span class=s>&#34;56.0&#34;</span><span class=o>));</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>We have modified our addNewAccount method to accept the initial balance as the second argument. We have also added a new field, called balance, in our Account object which is able to store the account balance -</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@AllArgsConstructor</span>
</span></span><span class=line><span class=cl><span class=nd>@Getter</span>
</span></span><span class=line><span class=cl><span class=kd>class</span> <span class=nc>Account</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=n>String</span> <span class=n>name</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=n>BigDecimal</span> <span class=n>balance</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>Since we have changed the signature of the addNewAccount method, we will also have to modify our first test -</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Test</span>
</span></span><span class=line><span class=cl><span class=nd>@DisplayName</span><span class=o>(</span><span class=s>&#34;Given account does not exist When user adds a new account Then added account has the given name&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>accountAddedWithGivenName</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=n>AddNewAccountService</span> <span class=n>accountService</span> <span class=o>=</span> <span class=k>new</span> <span class=n>AddNewAccountService</span><span class=o>(</span><span class=n>saveAccountPort</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>accountService</span><span class=o>.</span><span class=na>addNewAccount</span><span class=o>(</span><span class=s>&#34;test account&#34;</span><span class=o>,</span> <span class=s>&#34;1&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>BDDMockito</span><span class=o>.</span><span class=na>then</span><span class=o>(</span><span class=n>saveAccountPort</span><span class=o>).</span><span class=na>should</span><span class=o>().</span><span class=na>saveAccount</span><span class=o>(</span><span class=n>accountArgumentCaptor</span><span class=o>.</span><span class=na>capture</span><span class=o>());</span>
</span></span><span class=line><span class=cl>  <span class=n>BDDAssertions</span><span class=o>.</span><span class=na>then</span><span class=o>(</span><span class=n>accountArgumentCaptor</span><span class=o>.</span><span class=na>getValue</span><span class=o>().</span><span class=na>getName</span><span class=o>()).</span><span class=na>isEqualTo</span><span class=o>(</span><span class=s>&#34;test account&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>If we run our new test now it will fail as we haven&rsquo;t implemented the functionality yet. Let&rsquo;s do that now -</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kt>void</span> <span class=nf>addNewAccount</span><span class=o>(</span><span class=n>String</span> <span class=n>accountName</span><span class=o>,</span> <span class=n>String</span> <span class=n>initialBalance</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=n>saveAccountPort</span><span class=o>.</span><span class=na>saveAccount</span><span class=o>(</span><span class=k>new</span> <span class=n>Account</span><span class=o>(</span><span class=n>accountName</span><span class=o>,</span> <span class=k>new</span> <span class=n>BigDecimal</span><span class=o>(</span><span class=n>initialBalance</span><span class=o>)));</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>Both of our tests should pass now.</p><p>As we already have a couple of tests in place, it&rsquo;s time to take a look at our implementation and see if we can make it better. Since our AddNewAccountService is as simple as it can be, we don&rsquo;t have to do anything there. As for our tests, we could eliminate the duplication in our test setup code - both tests are instantiating an instance of the AddNewAccountService and invoking the addNewAccount method on it in the same way. Whether to remove or keep this duplication depends on our style of writing tests - if we want to make each test as independent as possible, then let&rsquo;s leave them as they are. If we, however, are fine with having a common test setup code, then we could change the tests as follows -</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@ExtendWith</span><span class=o>(</span><span class=n>MockitoExtension</span><span class=o>.</span><span class=na>class</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=nd>@DisplayName</span><span class=o>(</span><span class=s>&#34;Given account does not exist When user adds a new account&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=kd>class</span> <span class=nc>AddNewAccountServiceTest</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=n>String</span> <span class=n>ACCOUNT_NAME</span> <span class=o>=</span> <span class=s>&#34;test account&#34;</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=n>String</span> <span class=n>INITIAL_BALANCE</span> <span class=o>=</span> <span class=s>&#34;56.0&#34;</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@Mock</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=n>SaveAccountPort</span> <span class=n>saveAccountPort</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@Captor</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=n>ArgumentCaptor</span><span class=o>&lt;</span><span class=n>Account</span><span class=o>&gt;</span> <span class=n>accountArgumentCaptor</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@BeforeEach</span>
</span></span><span class=line><span class=cl>  <span class=kt>void</span> <span class=nf>setup</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>AddNewAccountService</span> <span class=n>accountService</span> <span class=o>=</span> <span class=k>new</span> <span class=n>AddNewAccountService</span><span class=o>(</span><span class=n>saveAccountPort</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>accountService</span><span class=o>.</span><span class=na>addNewAccount</span><span class=o>(</span><span class=n>ACCOUNT_NAME</span><span class=o>,</span> <span class=n>INITIAL_BALANCE</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@Test</span>
</span></span><span class=line><span class=cl>  <span class=nd>@DisplayName</span><span class=o>(</span><span class=s>&#34;Then added account has the given name&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>  <span class=kt>void</span> <span class=nf>accountAddedWithGivenName</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>BDDMockito</span><span class=o>.</span><span class=na>then</span><span class=o>(</span><span class=n>saveAccountPort</span><span class=o>).</span><span class=na>should</span><span class=o>().</span><span class=na>saveAccount</span><span class=o>(</span><span class=n>accountArgumentCaptor</span><span class=o>.</span><span class=na>capture</span><span class=o>());</span>
</span></span><span class=line><span class=cl>    <span class=n>BDDAssertions</span><span class=o>.</span><span class=na>then</span><span class=o>(</span><span class=n>accountArgumentCaptor</span><span class=o>.</span><span class=na>getValue</span><span class=o>().</span><span class=na>getName</span><span class=o>()).</span><span class=na>isEqualTo</span><span class=o>(</span><span class=n>ACCOUNT_NAME</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@Test</span>
</span></span><span class=line><span class=cl>  <span class=nd>@DisplayName</span><span class=o>(</span><span class=s>&#34;Then added account has the given initial balance&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>  <span class=kt>void</span> <span class=nf>accountAddedWithGivenInitialBalance</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>BDDMockito</span><span class=o>.</span><span class=na>then</span><span class=o>(</span><span class=n>saveAccountPort</span><span class=o>).</span><span class=na>should</span><span class=o>().</span><span class=na>saveAccount</span><span class=o>(</span><span class=n>accountArgumentCaptor</span><span class=o>.</span><span class=na>capture</span><span class=o>());</span>
</span></span><span class=line><span class=cl>    <span class=n>BDDAssertions</span><span class=o>.</span><span class=na>then</span><span class=o>(</span><span class=n>accountArgumentCaptor</span><span class=o>.</span><span class=na>getValue</span><span class=o>().</span><span class=na>getBalance</span><span class=o>())</span>
</span></span><span class=line><span class=cl>        <span class=o>.</span><span class=na>isEqualTo</span><span class=o>(</span><span class=k>new</span> <span class=n>BigDecimal</span><span class=o>(</span><span class=n>INITIAL_BALANCE</span><span class=o>));</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>Notice that we have also extracted the common part of the @DisplayName and put this on top of the test class. If we are not comfortable doing this, we could also leave them as they are.</p><p>Since we have more than one passing tests, from now on every time we make a failing test pass we will stop for a moment, take a look at our implementation, and will try to improve it. To summarise, our implementation process will now consist of the following steps -</p><ol><li>Add a failing test while making sure existing tests keep passing</li><li>Make the failing test pass</li><li>Pause for a moment and try to improve the implementation (both the code and the tests)</li></ol><p>Moving on, we now need to store user ids with the created account. Following our method we will first write a failing test to capture this and then add the minimal amount of code needed to make the failing test pass. This is how the implementation looks like once the failing test starts to pass -</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@ExtendWith</span><span class=o>(</span><span class=n>MockitoExtension</span><span class=o>.</span><span class=na>class</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=nd>@DisplayName</span><span class=o>(</span><span class=s>&#34;Given account does not exist When user adds a new account&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=kd>class</span> <span class=nc>AddNewAccountServiceTest</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=n>String</span> <span class=n>ACCOUNT_NAME</span> <span class=o>=</span> <span class=s>&#34;test account&#34;</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=n>String</span> <span class=n>INITIAL_BALANCE</span> <span class=o>=</span> <span class=s>&#34;56.0&#34;</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=n>String</span> <span class=n>USER_ID</span> <span class=o>=</span> <span class=s>&#34;some id&#34;</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=n>Account</span> <span class=n>savedAccount</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@BeforeEach</span>
</span></span><span class=line><span class=cl>  <span class=kt>void</span> <span class=nf>setup</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>AddNewAccountService</span> <span class=n>accountService</span> <span class=o>=</span> <span class=k>new</span> <span class=n>AddNewAccountService</span><span class=o>(</span><span class=n>saveAccountPort</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>accountService</span><span class=o>.</span><span class=na>addNewAccount</span><span class=o>(</span><span class=n>ACCOUNT_NAME</span><span class=o>,</span> <span class=n>INITIAL_BALANCE</span><span class=o>,</span> <span class=n>USER_ID</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>BDDMockito</span><span class=o>.</span><span class=na>then</span><span class=o>(</span><span class=n>saveAccountPort</span><span class=o>).</span><span class=na>should</span><span class=o>().</span><span class=na>saveAccount</span><span class=o>(</span><span class=n>accountArgumentCaptor</span><span class=o>.</span><span class=na>capture</span><span class=o>());</span>
</span></span><span class=line><span class=cl>    <span class=n>savedAccount</span> <span class=o>=</span> <span class=n>accountArgumentCaptor</span><span class=o>.</span><span class=na>getValue</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=c1>// Other tests.....
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=nd>@Test</span>
</span></span><span class=line><span class=cl>  <span class=nd>@DisplayName</span><span class=o>(</span><span class=s>&#34;Then added account has user&#39;s id&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>  <span class=kt>void</span> <span class=nf>accountAddedWithUsersId</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>BDDAssertions</span><span class=o>.</span><span class=na>then</span><span class=o>(</span><span class=n>accountArgumentCaptor</span><span class=o>.</span><span class=na>getValue</span><span class=o>().</span><span class=na>getUserId</span><span class=o>()).</span><span class=na>isEqualTo</span><span class=o>(</span><span class=n>USER_ID</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@RequiredArgsConstructor</span>
</span></span><span class=line><span class=cl><span class=kd>class</span> <span class=nc>AddNewAccountService</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kd>final</span> <span class=n>SaveAccountPort</span> <span class=n>saveAccountPort</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kt>void</span> <span class=nf>addNewAccount</span><span class=o>(</span><span class=n>String</span> <span class=n>accountName</span><span class=o>,</span> <span class=n>String</span> <span class=n>initialBalance</span><span class=o>,</span> <span class=n>String</span> <span class=n>userId</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>saveAccountPort</span><span class=o>.</span><span class=na>saveAccount</span><span class=o>(</span><span class=k>new</span> <span class=n>Account</span><span class=o>(</span><span class=n>accountName</span><span class=o>,</span> <span class=k>new</span> <span class=n>BigDecimal</span><span class=o>(</span><span class=n>initialBalance</span><span class=o>),</span> <span class=n>userId</span><span class=o>));</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@AllArgsConstructor</span>
</span></span><span class=line><span class=cl><span class=nd>@Getter</span>
</span></span><span class=line><span class=cl><span class=kd>class</span> <span class=nc>Account</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=n>String</span> <span class=n>name</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=n>BigDecimal</span> <span class=n>balance</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=n>String</span> <span class=n>userId</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>Since all the tests are now passing, it&rsquo;s improvement time! Notice that the addNewAccount method accepts three argument already. As we introduce more and more account properties its argument list will also start to increase. We could introduce a parameter object to avoid that -</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@RequiredArgsConstructor</span>
</span></span><span class=line><span class=cl><span class=kd>class</span> <span class=nc>AddNewAccountService</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kd>final</span> <span class=n>SaveAccountPort</span> <span class=n>saveAccountPort</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kt>void</span> <span class=nf>addNewAccount</span><span class=o>(</span><span class=n>AddNewAccountCommand</span> <span class=n>command</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>saveAccountPort</span><span class=o>.</span><span class=na>saveAccount</span><span class=o>(</span>
</span></span><span class=line><span class=cl>        <span class=k>new</span> <span class=n>Account</span><span class=o>(</span>
</span></span><span class=line><span class=cl>            <span class=n>command</span><span class=o>.</span><span class=na>getAccountName</span><span class=o>(),</span>
</span></span><span class=line><span class=cl>            <span class=k>new</span> <span class=n>BigDecimal</span><span class=o>(</span><span class=n>command</span><span class=o>.</span><span class=na>getInitialBalance</span><span class=o>()),</span>
</span></span><span class=line><span class=cl>            <span class=n>command</span><span class=o>.</span><span class=na>getUserId</span><span class=o>()</span>
</span></span><span class=line><span class=cl>        <span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@Builder</span>
</span></span><span class=line><span class=cl>  <span class=nd>@Getter</span>
</span></span><span class=line><span class=cl>  <span class=kd>static</span> <span class=kd>class</span> <span class=nc>AddNewAccountCommand</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>final</span> <span class=n>String</span> <span class=n>userId</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>final</span> <span class=n>String</span> <span class=n>accountName</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>final</span> <span class=n>String</span> <span class=n>initialBalance</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@ExtendWith</span><span class=o>(</span><span class=n>MockitoExtension</span><span class=o>.</span><span class=na>class</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=nd>@DisplayName</span><span class=o>(</span><span class=s>&#34;Given account does not exist When user adds a new account&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=kd>class</span> <span class=nc>AddNewAccountServiceTest</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// Fields.....
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=nd>@BeforeEach</span>
</span></span><span class=line><span class=cl>  <span class=kt>void</span> <span class=nf>setup</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>AddNewAccountService</span> <span class=n>accountService</span> <span class=o>=</span> <span class=k>new</span> <span class=n>AddNewAccountService</span><span class=o>(</span><span class=n>saveAccountPort</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>AddNewAccountCommand</span> <span class=n>command</span> <span class=o>=</span> <span class=n>AddNewAccountCommand</span><span class=o>.</span><span class=na>builder</span><span class=o>()</span>
</span></span><span class=line><span class=cl>        <span class=o>.</span><span class=na>accountName</span><span class=o>(</span><span class=n>ACCOUNT_NAME</span><span class=o>)</span>
</span></span><span class=line><span class=cl>        <span class=o>.</span><span class=na>initialBalance</span><span class=o>(</span><span class=n>INITIAL_BALANCE</span><span class=o>)</span>
</span></span><span class=line><span class=cl>        <span class=o>.</span><span class=na>userId</span><span class=o>(</span><span class=n>USER_ID</span><span class=o>)</span>
</span></span><span class=line><span class=cl>        <span class=o>.</span><span class=na>build</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>accountService</span><span class=o>.</span><span class=na>addNewAccount</span><span class=o>(</span><span class=n>command</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>BDDMockito</span><span class=o>.</span><span class=na>then</span><span class=o>(</span><span class=n>saveAccountPort</span><span class=o>).</span><span class=na>should</span><span class=o>().</span><span class=na>saveAccount</span><span class=o>(</span><span class=n>accountArgumentCaptor</span><span class=o>.</span><span class=na>capture</span><span class=o>());</span>
</span></span><span class=line><span class=cl>    <span class=n>savedAccount</span> <span class=o>=</span> <span class=n>accountArgumentCaptor</span><span class=o>.</span><span class=na>getValue</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// Remaining Tests.....
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>}</span>
</span></span></code></pre></div><p>If I now run the tests in my IDEA, this is what I see -</p><p></p><p>When we try to read the test descriptions in this view we can already get a good overview of the Add New Account use case and the way it works.</p><p>Right, let&rsquo;s move on the the second scenario of our use case, which is a validation rule -</p><blockquote><p>Given account does not exist
When user adds a new account with negative initial balance
Then add new account fails</p></blockquote><p>Let&rsquo;s write a new test which tries to capture this -</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@ExtendWith</span><span class=o>(</span><span class=n>MockitoExtension</span><span class=o>.</span><span class=na>class</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=nd>@DisplayName</span><span class=o>(</span><span class=s>&#34;Given account does not exist When user adds a new account&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=kd>class</span> <span class=nc>AddNewAccountServiceTest</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// Other tests
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=nd>@Test</span>
</span></span><span class=line><span class=cl>  <span class=nd>@DisplayName</span><span class=o>(</span><span class=s>&#34;Given account does not exist When user adds a new account with negative initial balance Then add new account fails&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>  <span class=kt>void</span> <span class=nf>addNewAccountFailsWithNegativeInitialBalance</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>AddNewAccountService</span> <span class=n>accountService</span> <span class=o>=</span> <span class=k>new</span> <span class=n>AddNewAccountService</span><span class=o>(</span><span class=n>saveAccountPort</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>AddNewAccountCommand</span> <span class=n>command</span> <span class=o>=</span> <span class=n>AddNewAccountCommand</span><span class=o>.</span><span class=na>builder</span><span class=o>().</span><span class=na>initialBalance</span><span class=o>(</span><span class=s>&#34;-56.0&#34;</span><span class=o>).</span><span class=na>build</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>accountService</span><span class=o>.</span><span class=na>addNewAccount</span><span class=o>(</span><span class=n>command</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>BDDMockito</span><span class=o>.</span><span class=na>then</span><span class=o>(</span><span class=n>saveAccountPort</span><span class=o>).</span><span class=na>shouldHaveNoInteractions</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>There are several ways we can implement validations in our service. We could throw an exception detailing the validation failures, or we could return an error object which would contain the error details. For this example we will throw exceptions if validation fails -</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Test</span>
</span></span><span class=line><span class=cl><span class=nd>@DisplayName</span><span class=o>(</span><span class=s>&#34;Given account does not exist When user adds a new account with negative initial balance Then add new account fails&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>addNewAccountFailsWithNegativeInitialBalance</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=n>AddNewAccountService</span> <span class=n>accountService</span> <span class=o>=</span> <span class=k>new</span> <span class=n>AddNewAccountService</span><span class=o>(</span><span class=n>saveAccountPort</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=n>AddNewAccountCommand</span> <span class=n>command</span> <span class=o>=</span> <span class=n>AddNewAccountCommand</span><span class=o>.</span><span class=na>builder</span><span class=o>().</span><span class=na>initialBalance</span><span class=o>(</span><span class=s>&#34;-56.0&#34;</span><span class=o>).</span><span class=na>build</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>assertThatExceptionOfType</span><span class=o>(</span><span class=n>IllegalArgumentException</span><span class=o>.</span><span class=na>class</span><span class=o>)</span>
</span></span><span class=line><span class=cl>      <span class=o>.</span><span class=na>isThrownBy</span><span class=o>(()</span> <span class=o>-&gt;</span> <span class=n>accountService</span><span class=o>.</span><span class=na>addNewAccount</span><span class=o>(</span><span class=n>command</span><span class=o>));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>BDDMockito</span><span class=o>.</span><span class=na>then</span><span class=o>(</span><span class=n>saveAccountPort</span><span class=o>).</span><span class=na>shouldHaveNoInteractions</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>This test verifies that an exception is thrown when the addNewAccount method is invoked with a negative balance. It also ensures that in such cases our code does not invoke any method of the SaveAccountPort. Before we can start modifying our service to make this test pass, we have to refactor our test setup code a bit. This is because during one of our previous refactoring we moved our common test setup code into a single method which now runs before each test -</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@BeforeEach</span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>setup</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=n>AddNewAccountService</span> <span class=n>accountService</span> <span class=o>=</span> <span class=k>new</span> <span class=n>AddNewAccountService</span><span class=o>(</span><span class=n>saveAccountPort</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=n>AddNewAccountCommand</span> <span class=n>command</span> <span class=o>=</span> <span class=n>AddNewAccountCommand</span><span class=o>.</span><span class=na>builder</span><span class=o>()</span>
</span></span><span class=line><span class=cl>      <span class=o>.</span><span class=na>accountName</span><span class=o>(</span><span class=n>ACCOUNT_NAME</span><span class=o>)</span>
</span></span><span class=line><span class=cl>      <span class=o>.</span><span class=na>initialBalance</span><span class=o>(</span><span class=n>INITIAL_BALANCE</span><span class=o>)</span>
</span></span><span class=line><span class=cl>      <span class=o>.</span><span class=na>userId</span><span class=o>(</span><span class=n>USER_ID</span><span class=o>)</span>
</span></span><span class=line><span class=cl>      <span class=o>.</span><span class=na>build</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=n>accountService</span><span class=o>.</span><span class=na>addNewAccount</span><span class=o>(</span><span class=n>command</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=n>BDDMockito</span><span class=o>.</span><span class=na>then</span><span class=o>(</span><span class=n>saveAccountPort</span><span class=o>).</span><span class=na>should</span><span class=o>().</span><span class=na>saveAccount</span><span class=o>(</span><span class=n>accountArgumentCaptor</span><span class=o>.</span><span class=na>capture</span><span class=o>());</span>
</span></span><span class=line><span class=cl>  <span class=n>savedAccount</span> <span class=o>=</span> <span class=n>accountArgumentCaptor</span><span class=o>.</span><span class=na>getValue</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>This setup code is now in direct conflict with the new test that we&rsquo;ve just added - before each test it will always invoke the addNewAccount method with a valid command object, resulting in an invocation of the saveAccount method of the SaveAccountPort, causing our new test to fail.</p><p>In order to fix this, we will create a nested class within our test class where we will move our existing setup code and the passing tests -</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@ExtendWith</span><span class=o>(</span><span class=n>MockitoExtension</span><span class=o>.</span><span class=na>class</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=nd>@DisplayName</span><span class=o>(</span><span class=s>&#34;Given account does not exist&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=kd>class</span> <span class=nc>AddNewAccountServiceTest</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@Mock</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=n>SaveAccountPort</span> <span class=n>saveAccountPort</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=n>AddNewAccountService</span> <span class=n>accountService</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@BeforeEach</span>
</span></span><span class=line><span class=cl>  <span class=kt>void</span> <span class=nf>setUp</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>accountService</span> <span class=o>=</span> <span class=k>new</span> <span class=n>AddNewAccountService</span><span class=o>(</span><span class=n>saveAccountPort</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@Nested</span>
</span></span><span class=line><span class=cl>  <span class=nd>@DisplayName</span><span class=o>(</span><span class=s>&#34;When user adds a new account&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>  <span class=kd>class</span> <span class=nc>WhenUserAddsANewAccount</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=n>String</span> <span class=n>ACCOUNT_NAME</span> <span class=o>=</span> <span class=s>&#34;test account&#34;</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=n>String</span> <span class=n>INITIAL_BALANCE</span> <span class=o>=</span> <span class=s>&#34;56.0&#34;</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=n>String</span> <span class=n>USER_ID</span> <span class=o>=</span> <span class=s>&#34;some id&#34;</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>Account</span> <span class=n>savedAccount</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Captor</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>ArgumentCaptor</span><span class=o>&lt;</span><span class=n>Account</span><span class=o>&gt;</span> <span class=n>accountArgumentCaptor</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@BeforeEach</span>
</span></span><span class=line><span class=cl>    <span class=kt>void</span> <span class=nf>setUp</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>AddNewAccountCommand</span> <span class=n>command</span> <span class=o>=</span> <span class=n>AddNewAccountCommand</span><span class=o>.</span><span class=na>builder</span><span class=o>()</span>
</span></span><span class=line><span class=cl>          <span class=o>.</span><span class=na>accountName</span><span class=o>(</span><span class=n>ACCOUNT_NAME</span><span class=o>)</span>
</span></span><span class=line><span class=cl>          <span class=o>.</span><span class=na>initialBalance</span><span class=o>(</span><span class=n>INITIAL_BALANCE</span><span class=o>)</span>
</span></span><span class=line><span class=cl>          <span class=o>.</span><span class=na>userId</span><span class=o>(</span><span class=n>USER_ID</span><span class=o>)</span>
</span></span><span class=line><span class=cl>          <span class=o>.</span><span class=na>build</span><span class=o>();</span>
</span></span><span class=line><span class=cl>      <span class=n>accountService</span><span class=o>.</span><span class=na>addNewAccount</span><span class=o>(</span><span class=n>command</span><span class=o>);</span>
</span></span><span class=line><span class=cl>      <span class=n>BDDMockito</span><span class=o>.</span><span class=na>then</span><span class=o>(</span><span class=n>saveAccountPort</span><span class=o>).</span><span class=na>should</span><span class=o>().</span><span class=na>saveAccount</span><span class=o>(</span><span class=n>accountArgumentCaptor</span><span class=o>.</span><span class=na>capture</span><span class=o>());</span>
</span></span><span class=line><span class=cl>      <span class=n>savedAccount</span> <span class=o>=</span> <span class=n>accountArgumentCaptor</span><span class=o>.</span><span class=na>getValue</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Test</span>
</span></span><span class=line><span class=cl>    <span class=nd>@DisplayName</span><span class=o>(</span><span class=s>&#34;Then added account has the given name&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=kt>void</span> <span class=nf>accountAddedWithGivenName</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>BDDAssertions</span><span class=o>.</span><span class=na>then</span><span class=o>(</span><span class=n>savedAccount</span><span class=o>.</span><span class=na>getName</span><span class=o>()).</span><span class=na>isEqualTo</span><span class=o>(</span><span class=n>ACCOUNT_NAME</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Test</span>
</span></span><span class=line><span class=cl>    <span class=nd>@DisplayName</span><span class=o>(</span><span class=s>&#34;Then added account has the given initial balance&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=kt>void</span> <span class=nf>accountAddedWithGivenInitialBalance</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>BDDAssertions</span><span class=o>.</span><span class=na>then</span><span class=o>(</span><span class=n>savedAccount</span><span class=o>.</span><span class=na>getBalance</span><span class=o>()).</span><span class=na>isEqualTo</span><span class=o>(</span><span class=k>new</span> <span class=n>BigDecimal</span><span class=o>(</span><span class=n>INITIAL_BALANCE</span><span class=o>));</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Test</span>
</span></span><span class=line><span class=cl>    <span class=nd>@DisplayName</span><span class=o>(</span><span class=s>&#34;Then added account has user&#39;s id&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=kt>void</span> <span class=nf>accountAddedWithUsersId</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>BDDAssertions</span><span class=o>.</span><span class=na>then</span><span class=o>(</span><span class=n>accountArgumentCaptor</span><span class=o>.</span><span class=na>getValue</span><span class=o>().</span><span class=na>getUserId</span><span class=o>()).</span><span class=na>isEqualTo</span><span class=o>(</span><span class=n>USER_ID</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=nd>@Test</span>
</span></span><span class=line><span class=cl>  <span class=nd>@DisplayName</span><span class=o>(</span><span class=s>&#34;When user adds a new account with negative initial balance Then add new account fails&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>  <span class=kt>void</span> <span class=nf>addNewAccountFailsWithNegativeInitialBalance</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>AddNewAccountCommand</span> <span class=n>command</span> <span class=o>=</span> <span class=n>AddNewAccountCommand</span><span class=o>.</span><span class=na>builder</span><span class=o>()</span>
</span></span><span class=line><span class=cl>        <span class=o>.</span><span class=na>initialBalance</span><span class=o>(</span><span class=s>&#34;-56.0&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>        <span class=o>.</span><span class=na>build</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>assertThatExceptionOfType</span><span class=o>(</span><span class=n>IllegalArgumentException</span><span class=o>.</span><span class=na>class</span><span class=o>)</span>
</span></span><span class=line><span class=cl>        <span class=o>.</span><span class=na>isThrownBy</span><span class=o>(()</span> <span class=o>-&gt;</span> <span class=n>accountService</span><span class=o>.</span><span class=na>addNewAccount</span><span class=o>(</span><span class=n>command</span><span class=o>));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>BDDMockito</span><span class=o>.</span><span class=na>then</span><span class=o>(</span><span class=n>saveAccountPort</span><span class=o>).</span><span class=na>shouldHaveNoInteractions</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>Here are the refactoring steps that we took -</p><ol><li>We created an inner class and then marked the inner class with JUnit 5&rsquo;s @Nested annotation.</li><li>We broke down the @DisplayName label of the outermost test class and moved the &ldquo;When user adds a new account&rdquo; part to the newly introduced inner class. The reason we did this is because this inner class will contain the group of tests that will verify/validate behaviours related to a valid account creation scenario.</li><li>We moved related setup code and fields/constants into this inner class.</li><li>We have removed the &ldquo;Given account does not exist&rdquo; part from our new test. This is because the @DisplayName on the outermost test class already includes this, hence no point including it here again.</li></ol><p>This is how the tests now look like when I run them in my IntelliJ IDEA -</p><p></p><p>As we can see from the screenshot, our test labels are also grouped and indented nicely following the structure that we created in our test code. Let&rsquo;s modify our service now to make the failing test pass -</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kt>void</span> <span class=nf>addNewAccount</span><span class=o>(</span><span class=n>AddNewAccountCommand</span> <span class=n>command</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=n>BigDecimal</span> <span class=n>initialBalance</span> <span class=o>=</span> <span class=k>new</span> <span class=n>BigDecimal</span><span class=o>(</span><span class=n>command</span><span class=o>.</span><span class=na>getInitialBalance</span><span class=o>());</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>initialBalance</span><span class=o>.</span><span class=na>compareTo</span><span class=o>(</span><span class=n>BigDecimal</span><span class=o>.</span><span class=na>ZERO</span><span class=o>)</span> <span class=o>&lt;</span> <span class=n>0</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalArgumentException</span><span class=o>(</span><span class=s>&#34;Initial balance of an account cannot be negative&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=n>saveAccountPort</span><span class=o>.</span><span class=na>saveAccount</span><span class=o>(</span>
</span></span><span class=line><span class=cl>    <span class=k>new</span> <span class=n>Account</span><span class=o>(</span>
</span></span><span class=line><span class=cl>      <span class=n>command</span><span class=o>.</span><span class=na>getAccountName</span><span class=o>(),</span>
</span></span><span class=line><span class=cl>      <span class=n>initialBalance</span><span class=o>,</span>
</span></span><span class=line><span class=cl>      <span class=n>command</span><span class=o>.</span><span class=na>getUserId</span><span class=o>()</span>
</span></span><span class=line><span class=cl>    <span class=o>)</span>
</span></span><span class=line><span class=cl>  <span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>With that all of our tests start passing again. Next step is to look for ways to improve the existing implementation if possible. If not, then we will move on to the implementation of the final scenario which is also a validation rule -</p><blockquote><p>Given account with the same name exists
When user adds a new account
Then add new account fails</p></blockquote><p>As always, let&rsquo;s write a test to capture this -</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Test</span>
</span></span><span class=line><span class=cl><span class=nd>@DisplayName</span><span class=o>(</span><span class=s>&#34;Given account with the same name exists When user adds a new account Then add new account fails&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>addNewAccountFailsForDuplicateAccounts</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=n>AddNewAccountCommand</span> <span class=n>command</span> <span class=o>=</span> <span class=n>AddNewAccountCommand</span><span class=o>.</span><span class=na>builder</span><span class=o>()</span>
</span></span><span class=line><span class=cl>      <span class=o>.</span><span class=na>accountName</span><span class=o>(</span><span class=s>&#34;existing name&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>      <span class=o>.</span><span class=na>build</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=n>AddNewAccountService</span> <span class=n>accountService</span> <span class=o>=</span> <span class=k>new</span> <span class=n>AddNewAccountService</span><span class=o>(</span><span class=n>saveAccountPort</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>assertThatExceptionOfType</span><span class=o>(</span><span class=n>IllegalArgumentException</span><span class=o>.</span><span class=na>class</span><span class=o>)</span>
</span></span><span class=line><span class=cl>      <span class=o>.</span><span class=na>isThrownBy</span><span class=o>(()</span> <span class=o>-&gt;</span> <span class=n>accountService</span><span class=o>.</span><span class=na>addNewAccount</span><span class=o>(</span><span class=n>command</span><span class=o>));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>BDDMockito</span><span class=o>.</span><span class=na>then</span><span class=o>(</span><span class=n>saveAccountPort</span><span class=o>).</span><span class=na>shouldHaveNoInteractions</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>First thing we have to figure out now is to how to find an existing account. Since this will involve querying our persistent data store, we will introduce an interface -</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>interface</span> <span class=nc>FindAccountPort</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>Account</span> <span class=nf>findAccountByName</span><span class=o>(</span><span class=n>String</span> <span class=n>accountName</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>and inject it into our AddNewAccountService -</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@RequiredArgsConstructor</span>
</span></span><span class=line><span class=cl><span class=kd>class</span> <span class=nc>AddNewAccountService</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kd>final</span> <span class=n>SaveAccountPort</span> <span class=n>saveAccountPort</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kd>final</span> <span class=n>FindAccountPort</span> <span class=n>findAccountPort</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=c1>// Rest of the code
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>}</span>
</span></span></code></pre></div><p>and modify our test -</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Test</span>
</span></span><span class=line><span class=cl><span class=nd>@DisplayName</span><span class=o>(</span><span class=s>&#34;Given account with the same name exists When user adds a new account Then add new account fails&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>addNewAccountFailsForDuplicateAccounts</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=n>String</span> <span class=n>existingAccountName</span> <span class=o>=</span> <span class=s>&#34;existing name&#34;</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=n>AddNewAccountCommand</span> <span class=n>command</span> <span class=o>=</span> <span class=n>AddNewAccountCommand</span><span class=o>.</span><span class=na>builder</span><span class=o>()</span>
</span></span><span class=line><span class=cl>      <span class=o>.</span><span class=na>initialBalance</span><span class=o>(</span><span class=s>&#34;0&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>      <span class=o>.</span><span class=na>accountName</span><span class=o>(</span><span class=n>existingAccountName</span><span class=o>)</span>
</span></span><span class=line><span class=cl>      <span class=o>.</span><span class=na>build</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=n>given</span><span class=o>(</span><span class=n>findAccountPort</span><span class=o>.</span><span class=na>findAccountByName</span><span class=o>(</span><span class=n>existingAccountName</span><span class=o>)).</span><span class=na>willReturn</span><span class=o>(</span><span class=n>mock</span><span class=o>(</span><span class=n>Account</span><span class=o>.</span><span class=na>class</span><span class=o>));</span>
</span></span><span class=line><span class=cl>  <span class=n>AddNewAccountService</span> <span class=n>accountService</span> <span class=o>=</span> <span class=k>new</span> <span class=n>AddNewAccountService</span><span class=o>(</span><span class=n>saveAccountPort</span><span class=o>,</span>
</span></span><span class=line><span class=cl>      <span class=n>findAccountPort</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>assertThatExceptionOfType</span><span class=o>(</span><span class=n>IllegalArgumentException</span><span class=o>.</span><span class=na>class</span><span class=o>)</span>
</span></span><span class=line><span class=cl>      <span class=o>.</span><span class=na>isThrownBy</span><span class=o>(()</span> <span class=o>-&gt;</span> <span class=n>accountService</span><span class=o>.</span><span class=na>addNewAccount</span><span class=o>(</span><span class=n>command</span><span class=o>));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>BDDMockito</span><span class=o>.</span><span class=na>then</span><span class=o>(</span><span class=n>saveAccountPort</span><span class=o>).</span><span class=na>shouldHaveNoInteractions</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>The last change to our AddNewAccountService will also require changes to our existing tests, mainly the place where we were instantiating an instance of that class. We will, however, change a bit more than that -</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@ExtendWith</span><span class=o>(</span><span class=n>MockitoExtension</span><span class=o>.</span><span class=na>class</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=kd>class</span> <span class=nc>AddNewAccountServiceTest</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@Mock</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=n>SaveAccountPort</span> <span class=n>saveAccountPort</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@Mock</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=n>FindAccountPort</span> <span class=n>findAccountPort</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@Nested</span>
</span></span><span class=line><span class=cl>  <span class=nd>@DisplayName</span><span class=o>(</span><span class=s>&#34;Given account does not exist&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>  <span class=kd>class</span> <span class=nc>AccountDoesNotExist</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>AddNewAccountService</span> <span class=n>accountService</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@BeforeEach</span>
</span></span><span class=line><span class=cl>    <span class=kt>void</span> <span class=nf>setUp</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>accountService</span> <span class=o>=</span> <span class=k>new</span> <span class=n>AddNewAccountService</span><span class=o>(</span><span class=n>saveAccountPort</span><span class=o>,</span> <span class=n>findAccountPort</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Nested</span>
</span></span><span class=line><span class=cl>    <span class=nd>@DisplayName</span><span class=o>(</span><span class=s>&#34;When user adds a new account&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=kd>class</span> <span class=nc>WhenUserAddsANewAccount</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=n>String</span> <span class=n>ACCOUNT_NAME</span> <span class=o>=</span> <span class=s>&#34;test account&#34;</span><span class=o>;</span>
</span></span><span class=line><span class=cl>      <span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=n>String</span> <span class=n>INITIAL_BALANCE</span> <span class=o>=</span> <span class=s>&#34;56.0&#34;</span><span class=o>;</span>
</span></span><span class=line><span class=cl>      <span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=n>String</span> <span class=n>USER_ID</span> <span class=o>=</span> <span class=s>&#34;some id&#34;</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=kd>private</span> <span class=n>Account</span> <span class=n>savedAccount</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=nd>@Captor</span>
</span></span><span class=line><span class=cl>      <span class=kd>private</span> <span class=n>ArgumentCaptor</span><span class=o>&lt;</span><span class=n>Account</span><span class=o>&gt;</span> <span class=n>accountArgumentCaptor</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=nd>@BeforeEach</span>
</span></span><span class=line><span class=cl>      <span class=kt>void</span> <span class=nf>setUp</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>AddNewAccountCommand</span> <span class=n>command</span> <span class=o>=</span> <span class=n>AddNewAccountCommand</span><span class=o>.</span><span class=na>builder</span><span class=o>()</span>
</span></span><span class=line><span class=cl>            <span class=o>.</span><span class=na>accountName</span><span class=o>(</span><span class=n>ACCOUNT_NAME</span><span class=o>)</span>
</span></span><span class=line><span class=cl>            <span class=o>.</span><span class=na>initialBalance</span><span class=o>(</span><span class=n>INITIAL_BALANCE</span><span class=o>)</span>
</span></span><span class=line><span class=cl>            <span class=o>.</span><span class=na>userId</span><span class=o>(</span><span class=n>USER_ID</span><span class=o>)</span>
</span></span><span class=line><span class=cl>            <span class=o>.</span><span class=na>build</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>accountService</span><span class=o>.</span><span class=na>addNewAccount</span><span class=o>(</span><span class=n>command</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>BDDMockito</span><span class=o>.</span><span class=na>then</span><span class=o>(</span><span class=n>saveAccountPort</span><span class=o>).</span><span class=na>should</span><span class=o>().</span><span class=na>saveAccount</span><span class=o>(</span><span class=n>accountArgumentCaptor</span><span class=o>.</span><span class=na>capture</span><span class=o>());</span>
</span></span><span class=line><span class=cl>        <span class=n>savedAccount</span> <span class=o>=</span> <span class=n>accountArgumentCaptor</span><span class=o>.</span><span class=na>getValue</span><span class=o>();</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=nd>@Test</span>
</span></span><span class=line><span class=cl>      <span class=nd>@DisplayName</span><span class=o>(</span><span class=s>&#34;Then added account has the given name&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>      <span class=kt>void</span> <span class=nf>accountAddedWithGivenName</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>BDDAssertions</span><span class=o>.</span><span class=na>then</span><span class=o>(</span><span class=n>savedAccount</span><span class=o>.</span><span class=na>getName</span><span class=o>()).</span><span class=na>isEqualTo</span><span class=o>(</span><span class=n>ACCOUNT_NAME</span><span class=o>);</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=nd>@Test</span>
</span></span><span class=line><span class=cl>      <span class=nd>@DisplayName</span><span class=o>(</span><span class=s>&#34;Then added account has the given initial balance&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>      <span class=kt>void</span> <span class=nf>accountAddedWithGivenInitialBalance</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>BDDAssertions</span><span class=o>.</span><span class=na>then</span><span class=o>(</span><span class=n>savedAccount</span><span class=o>.</span><span class=na>getBalance</span><span class=o>()).</span><span class=na>isEqualTo</span><span class=o>(</span><span class=k>new</span> <span class=n>BigDecimal</span><span class=o>(</span><span class=n>INITIAL_BALANCE</span><span class=o>));</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=nd>@Test</span>
</span></span><span class=line><span class=cl>      <span class=nd>@DisplayName</span><span class=o>(</span><span class=s>&#34;Then added account has user&#39;s id&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>      <span class=kt>void</span> <span class=nf>accountAddedWithUsersId</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>BDDAssertions</span><span class=o>.</span><span class=na>then</span><span class=o>(</span><span class=n>accountArgumentCaptor</span><span class=o>.</span><span class=na>getValue</span><span class=o>().</span><span class=na>getUserId</span><span class=o>()).</span><span class=na>isEqualTo</span><span class=o>(</span><span class=n>USER_ID</span><span class=o>);</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Test</span>
</span></span><span class=line><span class=cl>    <span class=nd>@DisplayName</span><span class=o>(</span><span class=s>&#34;When user adds a new account with negative initial balance Then add new account fails&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=kt>void</span> <span class=nf>addNewAccountFailsWithNegativeInitialBalance</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>AddNewAccountCommand</span> <span class=n>command</span> <span class=o>=</span> <span class=n>AddNewAccountCommand</span><span class=o>.</span><span class=na>builder</span><span class=o>()</span>
</span></span><span class=line><span class=cl>          <span class=o>.</span><span class=na>initialBalance</span><span class=o>(</span><span class=s>&#34;-56.0&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>          <span class=o>.</span><span class=na>build</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=n>assertThatExceptionOfType</span><span class=o>(</span><span class=n>IllegalArgumentException</span><span class=o>.</span><span class=na>class</span><span class=o>)</span>
</span></span><span class=line><span class=cl>          <span class=o>.</span><span class=na>isThrownBy</span><span class=o>(()</span> <span class=o>-&gt;</span> <span class=n>accountService</span><span class=o>.</span><span class=na>addNewAccount</span><span class=o>(</span><span class=n>command</span><span class=o>));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=n>BDDMockito</span><span class=o>.</span><span class=na>then</span><span class=o>(</span><span class=n>saveAccountPort</span><span class=o>).</span><span class=na>shouldHaveNoInteractions</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@Test</span>
</span></span><span class=line><span class=cl>  <span class=nd>@DisplayName</span><span class=o>(</span><span class=s>&#34;Given account with the same name exists When user adds a new account Then add new account fails&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>  <span class=kt>void</span> <span class=nf>addNewAccountFailsForDuplicateAccounts</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>String</span> <span class=n>existingAccountName</span> <span class=o>=</span> <span class=s>&#34;existing name&#34;</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=n>AddNewAccountCommand</span> <span class=n>command</span> <span class=o>=</span> <span class=n>AddNewAccountCommand</span><span class=o>.</span><span class=na>builder</span><span class=o>()</span>
</span></span><span class=line><span class=cl>        <span class=o>.</span><span class=na>initialBalance</span><span class=o>(</span><span class=s>&#34;0&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>        <span class=o>.</span><span class=na>accountName</span><span class=o>(</span><span class=n>existingAccountName</span><span class=o>)</span>
</span></span><span class=line><span class=cl>        <span class=o>.</span><span class=na>build</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>given</span><span class=o>(</span><span class=n>findAccountPort</span><span class=o>.</span><span class=na>findAccountByName</span><span class=o>(</span><span class=n>existingAccountName</span><span class=o>)).</span><span class=na>willReturn</span><span class=o>(</span><span class=n>mock</span><span class=o>(</span><span class=n>Account</span><span class=o>.</span><span class=na>class</span><span class=o>));</span>
</span></span><span class=line><span class=cl>    <span class=n>AddNewAccountService</span> <span class=n>accountService</span> <span class=o>=</span> <span class=k>new</span> <span class=n>AddNewAccountService</span><span class=o>(</span><span class=n>saveAccountPort</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=n>findAccountPort</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>assertThatExceptionOfType</span><span class=o>(</span><span class=n>IllegalArgumentException</span><span class=o>.</span><span class=na>class</span><span class=o>)</span>
</span></span><span class=line><span class=cl>        <span class=o>.</span><span class=na>isThrownBy</span><span class=o>(()</span> <span class=o>-&gt;</span> <span class=n>accountService</span><span class=o>.</span><span class=na>addNewAccount</span><span class=o>(</span><span class=n>command</span><span class=o>));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>BDDMockito</span><span class=o>.</span><span class=na>then</span><span class=o>(</span><span class=n>saveAccountPort</span><span class=o>).</span><span class=na>shouldHaveNoInteractions</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>Here&rsquo;s what we did -</p><blockquote><p>We created another inner class, marked it as @Nested, and moved our existing passing tests into this. This group of tests test the behaviour of adding a new account when no account with the given name already exists.
We have moved our test set up code into the newly introduced inner class as they are also related to the &ldquo;no account with the given name already exists&rdquo; case.
For the same reason as above, we have also moved our @DisplayName annotation from the top level test class to the newly introduced inner class.</p></blockquote><p>After our refactoring we quickly run our tests to see if everything is working as expected (failing test failing, passing tests passing), and then move on to modify our service -</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@RequiredArgsConstructor</span>
</span></span><span class=line><span class=cl><span class=kd>class</span> <span class=nc>AddNewAccountService</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kd>final</span> <span class=n>SaveAccountPort</span> <span class=n>saveAccountPort</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kd>final</span> <span class=n>FindAccountPort</span> <span class=n>findAccountPort</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kt>void</span> <span class=nf>addNewAccount</span><span class=o>(</span><span class=n>AddNewAccountCommand</span> <span class=n>command</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>BigDecimal</span> <span class=n>initialBalance</span> <span class=o>=</span> <span class=k>new</span> <span class=n>BigDecimal</span><span class=o>(</span><span class=n>command</span><span class=o>.</span><span class=na>getInitialBalance</span><span class=o>());</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>initialBalance</span><span class=o>.</span><span class=na>compareTo</span><span class=o>(</span><span class=n>BigDecimal</span><span class=o>.</span><span class=na>ZERO</span><span class=o>)</span> <span class=o>&lt;</span> <span class=n>0</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalArgumentException</span><span class=o>(</span><span class=s>&#34;Initial balance of an account cannot be negative&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>findAccountPort</span><span class=o>.</span><span class=na>findAccountByName</span><span class=o>(</span><span class=n>command</span><span class=o>.</span><span class=na>getAccountName</span><span class=o>())</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalArgumentException</span><span class=o>(</span><span class=s>&#34;An account with given name already exists&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=n>saveAccountPort</span><span class=o>.</span><span class=na>saveAccount</span><span class=o>(</span>
</span></span><span class=line><span class=cl>        <span class=k>new</span> <span class=n>Account</span><span class=o>(</span>
</span></span><span class=line><span class=cl>            <span class=n>command</span><span class=o>.</span><span class=na>getAccountName</span><span class=o>(),</span>
</span></span><span class=line><span class=cl>            <span class=n>initialBalance</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>command</span><span class=o>.</span><span class=na>getUserId</span><span class=o>()</span>
</span></span><span class=line><span class=cl>        <span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@Builder</span>
</span></span><span class=line><span class=cl>  <span class=nd>@Getter</span>
</span></span><span class=line><span class=cl>  <span class=kd>static</span> <span class=kd>class</span> <span class=nc>AddNewAccountCommand</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>final</span> <span class=n>String</span> <span class=n>userId</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>final</span> <span class=n>String</span> <span class=n>accountName</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>final</span> <span class=n>String</span> <span class=n>initialBalance</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>All of our tests should now be green.</p><p>Since our use case implementation is now complete, we will look at our implementation for one last time and see if we can improve anything. If not, our use case implementation is now complete!</p><p>To summarise, this is what we did throughout this article -</p><ol><li>We have written down a use case that we would like to implement</li><li>We have added a failing test, labelling it with a human-readable name</li><li>We have added the minimal amount of code needed to make the failing test pass</li><li>As soon as we had more than one passing tests, after we made each failing test pass, we looked at our implementation and tried to improve it</li><li>When writing the tests we tried writing them in such a way so that our use case specifications are reflected in the test code. For this we have used -</li><li>The @DisplayName annotation to assign human-readable names to our tests</li><li>Used @Nested to group related tests in a hierarchical structure, reflecting our use case setup</li><li>Used BDD-driven API from Mockito and AssertJ to verify the expected behaviours</li></ol><p>When should we follow this style of writing automated tests? The answer to this question is the same as every other usage questions in Software Engineering - it depends. I personally prefer this style when I am working with an application which has complex business/domain rules, which is intended to be maintained over a long period, for which a close collaboration with the business is required, and many other factors (i.e., application architecture, team adoption etc.).</p><p>As always, the full working example has been pushed to <a href=https://github.com/sayembd/java-examples/tree/master/executable-specification-example>Github</a>.</p><p>Until next time!</p></div><footer class=post-footer><nav class=paginav><a class=prev href=https://sayembd.github.io/posts/how-to-build-observable-system-an-introduction-to-observability/><span class=title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-left" style="user-select:text"><line x1="19" y1="12" x2="5" y2="12" style="user-select:text"/><polyline points="12 19 5 12 12 5" style="user-select:text"/></svg>&nbsp;Prev Page</span><br><span>How to Build Observable Systems - An Introduction to Observability</span></a>
<a class=next href=https://sayembd.github.io/posts/a-brief-overview-of-the-fork-join-framework-in-java/><span class=title>Next Page&nbsp;<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-right" style="user-select:text"><line x1="5" y1="12" x2="19" y2="12" style="user-select:text"/><polyline points="12 5 19 12 12 19" style="user-select:text"/></svg></span><br><span>A Brief Overview of the Fork Join Framework in Java</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2022 <a href=https://sayembd.github.io>Random Musings</a></span><span style=display:inline-block;margin-left:1em>
<a href=https://creativecommons.org/licenses/by-sa/4.0/>CC BY-SA</a></span>
<span style=display:inline-block;margin-left:1em>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
    <a href=https://github.com/reorx/hugo-PaperModX/ rel=noopener target=_blank>PaperModX</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>(function(){const t=""=="1";if(t)return;let e=document.getElementById("theme-toggle");e.removeEventListener("click",toggleThemeListener),e.addEventListener("click",toggleThemeListener)})()</script><script>(function(){let e=document.getElementById("menu");e&&(e.scrollLeft=localStorage.getItem("menu-scroll-position"),e.onscroll=function(){localStorage.setItem("menu-scroll-position",e.scrollLeft)});const t=""=="1",n=""=="1";if(window.matchMedia("(prefers-reduced-motion: reduce)").matches||t||n)return;document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})})()</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>if(window.scrollListeners)for(const e of scrollListeners)window.removeEventListener("scroll",e);window.scrollListeners=[]</script><script src=/js/medium-zoom.min.js data-no-instant></script>
<script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerText="copy";function s(){t.innerText="copied!",setTimeout(()=>{t.innerText="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script><script>(function(){const r=""=="1";if(!r)return;if(!document.querySelector(".toc")){console.log("no toc found, ignore toc scroll");return}const c=window.scrollListeners,n=document.querySelectorAll("h1[id],h2[id],h3[id],h4[id],h5[id]"),s="active";let e=n[0];o(e).classList.add(s);const a=()=>{const t=[];for(const e of n)if(l(e)<5)t.push(e);else break;t.length>0?newActiveHeading=t[t.length-1]:newActiveHeading=n[0],e!=newActiveHeading&&(o(e).classList.remove(s),e=newActiveHeading,o(e).classList.add(s))};let t=null;const i=()=>{t!==null&&clearTimeout(t),t=setTimeout(a,50)};window.addEventListener("scroll",i,!1),c.push(i);function o(e){const t=encodeURI(e.getAttribute("id")).toLowerCase();return document.querySelector(`.toc ul li a[href="#${t}"]`)}function l(e){if(!e.getClientRects().length)return 0;let t=e.getBoundingClientRect();return t.top}})()</script></body></html>