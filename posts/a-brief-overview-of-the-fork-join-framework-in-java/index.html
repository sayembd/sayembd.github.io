<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>A Brief Overview of the Fork Join Framework in Java | Random Musings</title><meta name=keywords content><meta name=description content="A tutorial which demonstrates how to use Fork/Join framework in Java for both blocking and non-blocking tasks."><meta name=author content><link rel=canonical href=https://www.sayemahmed.com/posts/a-brief-overview-of-the-fork-join-framework-in-java/><link crossorigin=anonymous href=/assets/css/stylesheet.75e99ced767a858315a7f7639cf847a348c9cd6d87c9dfe94262be72551a789f.css integrity="sha256-demc7XZ6hYMVp/djnPhHo0jJzW2Hyd/pQmK+clUaeJ8=" rel="preload stylesheet" as=style><link rel=icon href=https://www.sayemahmed.com/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://www.sayemahmed.com/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://www.sayemahmed.com/favicon-32x32.png><link rel=apple-touch-icon href=https://www.sayemahmed.com/apple-touch-icon.png><link rel=mask-icon href=https://www.sayemahmed.com/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:title" content="A Brief Overview of the Fork Join Framework in Java"><meta property="og:description" content="A tutorial which demonstrates how to use Fork/Join framework in Java for both blocking and non-blocking tasks."><meta property="og:type" content="article"><meta property="og:url" content="https://www.sayemahmed.com/posts/a-brief-overview-of-the-fork-join-framework-in-java/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2018-12-16T22:17:05+02:00"><meta property="article:modified_time" content="2018-12-16T22:17:05+02:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="A Brief Overview of the Fork Join Framework in Java"><meta name=twitter:description content="A tutorial which demonstrates how to use Fork/Join framework in Java for both blocking and non-blocking tasks."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://www.sayemahmed.com/posts/"},{"@type":"ListItem","position":2,"name":"A Brief Overview of the Fork Join Framework in Java","item":"https://www.sayemahmed.com/posts/a-brief-overview-of-the-fork-join-framework-in-java/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"A Brief Overview of the Fork Join Framework in Java","name":"A Brief Overview of the Fork Join Framework in Java","description":"A tutorial which demonstrates how to use Fork/Join framework in Java for both blocking and non-blocking tasks.","keywords":[],"articleBody":"Introduction The Fork/Join framework is a framework to solve a problem using a concurrent divide-and-conquer approach. They were introduced to complement the existing concurrency API. Before their introduction, the existing ExecutorService implementations were the popular choice to run asynchronous tasks, but they work best when the tasks are homogenous and independent. Running dependent tasks and combining their results using those implementations were not easy. With the introduction of the Fork/Join framework, an attempt was made to address this shortcoming. In this post, we will take a brief look at the API and solve a couple of simple problems to understand how they work.\nSolving a non-blocking task Let’s jump directly into code. Let’s create a task which would return the sum of all elements of a List. The following steps represent our algorithm in pseudo-code:\nFind the middle index of the list Divide the list in the middle Recursively create a new task which will compute the sum of the left part Recursively create a new task which will compute the sum of the right part Add the result of the left sum, the middle element, and the right sum Here is the code -\n@Slf4j public class ListSummer extends RecursiveTask\u003cInteger\u003e { private final List\u003cInteger\u003e listToSum; ListSummer(List\u003cInteger\u003e listToSum) { this.listToSum = listToSum; } @Override protected Integer compute() { if (listToSum.isEmpty()) { log.info(\"Found empty list, sum is 0\"); return 0; } int middleIndex = listToSum.size() / 2; log.info(\"List {}, middle Index: {}\", listToSum, middleIndex); List\u003cInteger\u003e leftSublist = listToSum.subList(0, middleIndex); List\u003cInteger\u003e rightSublist = listToSum.subList(middleIndex + 1, listToSum.size()); ListSummer leftSummer = new ListSummer(leftSublist); ListSummer rightSummer = new ListSummer(rightSublist); leftSummer.fork(); rightSummer.fork(); Integer leftSum = leftSummer.join(); Integer rightSum = rightSummer.join(); int total = leftSum + listToSum.get(middleIndex) + rightSum; log.info(\"Left sum is {}, right sum is {}, total is {}\", leftSum, rightSum, total); return total; } } Firstly, we extend the RecursiveTask subtype of the ForkJoinTask. This is the type to extend from when we expect our concurrent task to return a result. When a task does not return a result but only perform an effect, we extend the RecursiveAction subtype. For most of the practical tasks that we solve, these two subtypes are sufficient.\nSecondly, both RecursiveTask and RecursiveAction define an abstract compute method. This is where we put our computation.\nThirdly, inside our compute method, we check the size of the list that is passed through the constructor. If it is empty, we already know the result of the sum which is zero, and we return immediately. Otherwise, we divide our lists into two sublists and create two instances of our ListSummer type. We then call the fork() method (defined in ForkJoinTask) on these two instances -\nleftSummer.fork(); rightSummer.fork(); Which cause these tasks to be scheduled for asynchronous execution, the exact mechanism which is used for this purpose will be explained later in this post.\nAfter that, we invoke the join() method (also defined in ForkJoinTask) to wait for the result of these two parts -\nInteger leftSum = leftSummer.join(); Integer rightSum = rightSummer.join(); Which are then summed with the middle element of the list to get the final result.\nPlenty of log messages have been added to make the example easier to understand. However, when we process a list containing thousands of entries, it might not be a good idea to have this detailed logging, especially logging the entire list.\nThat’s pretty much it. Let’s create a test class now for a test run -\npublic class ListSummerTest { @Test public void shouldSumEmptyList() { ListSummer summer = new ListSummer(List.of()); ForkJoinPool forkJoinPool = new ForkJoinPool(); forkJoinPool.submit(summer); int result = summer.join(); assertThat(result).isZero(); } @Test public void shouldSumListWithOneElement() { ListSummer summer = new ListSummer(List.of(5)); ForkJoinPool forkJoinPool = new ForkJoinPool(); forkJoinPool.submit(summer); int result = summer.join(); assertThat(result).isEqualTo(5); } @Test public void shouldSumListWithMultipleElements() { ListSummer summer = new ListSummer(List.of( 1, 2, 3, 4, 5, 6, 7, 8, 9 )); ForkJoinPool forkJoinPool = new ForkJoinPool(); forkJoinPool.submit(summer); int result = summer.join(); assertThat(result).isEqualTo(45); } } In the test, we create an instance of the ForkJoinPool. A ForkJoinPool is a unique ExecutorService implementation for running ForkJoinTasks. It employs a special algorithm known as the work-stealing algorithm. Contrary to the other ExecutorService implementations where there is only a single queue holding all the tasks to be executed, in a work-stealing implementation, each worker thread gets its work queue. Each thread starts executing tasks from their queue. When we detect that a ForkJoinTask can be broken down into multiple smaller subtasks, we do break them into smaller tasks, and then we invoke the fork() method on those tasks. This invocation causes the subtasks to be pushed into the executing thread’s queue. During the execution, when one thread exhausts its queue/has no tasks to execute, it can “steal” tasks from other thread’s queue (hence the name “work-stealing”). This stealing behaviour is what results in a better throughput than using any other ExecutorService implementations.\nEarlier, when we invoked fork() on our leftSummer and rightSummer task instances, they got pushed into the work queue of the executing thread, after which they were “stolen” by other active threads in the pool (and so on) since they did not have anything else to do at that point.\nPretty cool, right?\nSolving a blocking task The problem we solved just now is non-blocking in nature. If we want to solve a problem which does some blocking operation, then to have a better throughput we will need to change our strategy.\nLet’s examine this with another example. Let’s say we want to create a very simple web crawler. This crawler will receive a list of HTTP links, execute GET requests to fetch the response bodies, and then calculate the response length. Here is the code -\n@Slf4j public class ResponseLengthCalculator extends RecursiveTask\u003cMap\u003cString, Integer\u003e\u003e { private final List\u003cString\u003e links; ResponseLengthCalculator(List\u003cString\u003e links) { this.links = links; } @Override protected Map\u003cString, Integer\u003e compute() { if (links.isEmpty()) { log.info(\"No more links to fetch\"); return Collections.emptyMap(); } int middle = links.size() / 2; log.info(\"Middle index: {}\", links, middle); ResponseLengthCalculator leftPartition = new ResponseLengthCalculator(links.subList(0, middle)); ResponseLengthCalculator rightPartition = new ResponseLengthCalculator(links.subList(middle + 1, links.size())); log.info(\"Forking left partition\"); leftPartition.fork(); log.info(\"Left partition forked, now forking right partition\"); rightPartition.fork(); log.info(\"Right partition forked\"); String middleLink = links.get(middle); HttpRequester httpRequester = new HttpRequester(middleLink); String response; try { log.info(\"Calling managedBlock for {}\", middleLink); ForkJoinPool.managedBlock(httpRequester); response = httpRequester.response; } catch (InterruptedException ex) { log.error(\"Error occurred while trying to implement blocking link fetcher\", ex); response = \"\"; } Map\u003cString, Integer\u003e responseMap = new HashMap\u003c\u003e(links.size()); Map\u003cString, Integer\u003e leftLinks = leftPartition.join(); responseMap.putAll(leftLinks); responseMap.put(middleLink, response.length()); Map\u003cString, Integer\u003e rightLinks = rightPartition.join(); responseMap.putAll(rightLinks); log.info(\"Left map {}, middle length {}, right map {}\", leftLinks, response.length(), rightLinks); return responseMap; } private static class HttpRequester implements ForkJoinPool.ManagedBlocker { private final String link; private String response; private HttpRequester(String link) { this.link = link; } @Override public boolean block() { HttpGet headRequest = new HttpGet(link); CloseableHttpClient client = HttpClientBuilder .create() .disableRedirectHandling() .build(); log.info(\"Executing blocking request for {}\", link); try (client; CloseableHttpResponse response = client.execute(headRequest)) { log.info(\"HTTP request for link {} has been executed\", link); this.response = EntityUtils.toString(response.getEntity()); } catch (IOException e) { log.error(\"Error while trying to fetch response from link {}: {}\", link, e.getMessage()); this.response = \"\"; } return true; } @Override public boolean isReleasable() { return false; } } } We create an implementation of the ForkJoinPool.ManagedBlocker where we put the blocking HTTP call. This interface defines two methods - block() and isReleasable(). The block() method is where we put our blocking call. After we are done with our blocking operation, we return true indicating that no further blocking is necessary. We return false from the isReleasable() implementation to indicate to a fork-join worker thread that the block() method implementation is potentially blocking in nature. The isReleasable() implementation will be invoked by a fork-join worker thread first before it invokes the block() method. Finally, we submit our HttpRequester instance to our pool by invoking ForkJoinPool.managedBlock() static method. After that our blocking task will start executing. When it blocks on the HTTP request, the ForkJoinPool.managedBlock() method will also arrange for a spare thread to be activated if necessary to ensure sufficient parallelism.\nLet’s take this implementation for a test drive then! Here’s the code -\npublic class ResponseLengthCalculatorTest { @Test public void shouldReturnEmptyMapForEmptyList() { ResponseLengthCalculator responseLengthCalculator = new ResponseLengthCalculator(Collections.emptyList()); ForkJoinPool pool = new ForkJoinPool(); pool.submit(responseLengthCalculator); Map\u003cString, Integer\u003e result = responseLengthCalculator.join(); assertThat(result).isEmpty(); } @Test public void shouldHandle200Ok() { ResponseLengthCalculator responseLengthCalculator = new ResponseLengthCalculator(List.of( \"http://httpstat.us/200\" )); ForkJoinPool pool = new ForkJoinPool(); pool.submit(responseLengthCalculator); Map\u003cString, Integer\u003e result = responseLengthCalculator.join(); assertThat(result) .hasSize(1) .containsKeys(\"http://httpstat.us/200\") .containsValue(0); } @Test public void shouldFetchResponseForDifferentResponseStatus() { ResponseLengthCalculator responseLengthCalculator = new ResponseLengthCalculator(List.of( \"http://httpstat.us/200\", \"http://httpstat.us/302\", \"http://httpstat.us/404\", \"http://httpstat.us/502\" )); ForkJoinPool pool = new ForkJoinPool(); pool.submit(responseLengthCalculator); Map\u003cString, Integer\u003e result = responseLengthCalculator.join(); assertThat(result) .hasSize(4); } } That’s it for today, folks! As always, any feedback/improvement suggestions/comments are highly appreciated!\nAll the examples discussed here can be found on Github.\nA big shout out to the awesome http://httpstat.us service, it was quite helpful for developing the simple tests.\n","wordCount":"1474","inLanguage":"en","datePublished":"2018-12-16T22:17:05+02:00","dateModified":"2018-12-16T22:17:05+02:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://www.sayemahmed.com/posts/a-brief-overview-of-the-fork-join-framework-in-java/"},"publisher":{"@type":"Organization","name":"Random Musings","logo":{"@type":"ImageObject","url":"https://www.sayemahmed.com/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://www.sayemahmed.com accesskey=h title="Random Musings (Alt + H)">Random Musings</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://www.sayemahmed.com/about-me title="About Me"><span>About Me</span></a></li><li><a href=https://www.sayemahmed.com/index.xml title=RSS><span>RSS</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">A Brief Overview of the Fork Join Framework in Java</h1><div class=post-description>A tutorial which demonstrates how to use Fork/Join framework in Java for both blocking and non-blocking tasks.</div><div class=post-meta><span title='2018-12-16 22:17:05 +0200 +0200'>December 16, 2018</span></div></header><div class=post-content><h2 id=introduction>Introduction<a hidden class=anchor aria-hidden=true href=#introduction>#</a></h2><p>The Fork/Join framework is a framework to solve a problem using a concurrent divide-and-conquer approach. They were introduced to complement the existing concurrency API. Before their introduction, the existing ExecutorService implementations were the popular choice to run asynchronous tasks, but they work best when the tasks are homogenous and independent. Running dependent tasks and combining their results using those implementations were not easy. With the introduction of the Fork/Join framework, an attempt was made to address this shortcoming. In this post, we will take a brief look at the API and solve a couple of simple problems to understand how they work.</p><h2 id=solving-a-non-blocking-task>Solving a non-blocking task<a hidden class=anchor aria-hidden=true href=#solving-a-non-blocking-task>#</a></h2><p>Let&rsquo;s jump directly into code. Let&rsquo;s create a task which would return the sum of all elements of a List. The following steps represent our algorithm in pseudo-code:</p><ol><li>Find the middle index of the list</li><li>Divide the list in the middle</li><li>Recursively create a new task which will compute the sum of the left part</li><li>Recursively create a new task which will compute the sum of the right part</li><li>Add the result of the left sum, the middle element, and the right sum</li></ol><p>Here is the code -</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Slf4j</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>ListSummer</span> <span class=kd>extends</span> <span class=n>RecursiveTask</span><span class=o>&lt;</span><span class=n>Integer</span><span class=o>&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kd>final</span> <span class=n>List</span><span class=o>&lt;</span><span class=n>Integer</span><span class=o>&gt;</span> <span class=n>listToSum</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>ListSummer</span><span class=o>(</span><span class=n>List</span><span class=o>&lt;</span><span class=n>Integer</span><span class=o>&gt;</span> <span class=n>listToSum</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=o>.</span><span class=na>listToSum</span> <span class=o>=</span> <span class=n>listToSum</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>  <span class=kd>protected</span> <span class=n>Integer</span> <span class=nf>compute</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>listToSum</span><span class=o>.</span><span class=na>isEmpty</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>log</span><span class=o>.</span><span class=na>info</span><span class=o>(</span><span class=s>&#34;Found empty list, sum is 0&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=mi>0</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>middleIndex</span> <span class=o>=</span> <span class=n>listToSum</span><span class=o>.</span><span class=na>size</span><span class=o>()</span> <span class=o>/</span> <span class=mi>2</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=n>log</span><span class=o>.</span><span class=na>info</span><span class=o>(</span><span class=s>&#34;List {}, middle Index: {}&#34;</span><span class=o>,</span> <span class=n>listToSum</span><span class=o>,</span> <span class=n>middleIndex</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>List</span><span class=o>&lt;</span><span class=n>Integer</span><span class=o>&gt;</span> <span class=n>leftSublist</span> <span class=o>=</span> <span class=n>listToSum</span><span class=o>.</span><span class=na>subList</span><span class=o>(</span><span class=mi>0</span><span class=o>,</span> <span class=n>middleIndex</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>List</span><span class=o>&lt;</span><span class=n>Integer</span><span class=o>&gt;</span> <span class=n>rightSublist</span> <span class=o>=</span> <span class=n>listToSum</span><span class=o>.</span><span class=na>subList</span><span class=o>(</span><span class=n>middleIndex</span> <span class=o>+</span> <span class=mi>1</span><span class=o>,</span> <span class=n>listToSum</span><span class=o>.</span><span class=na>size</span><span class=o>());</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>ListSummer</span> <span class=n>leftSummer</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ListSummer</span><span class=o>(</span><span class=n>leftSublist</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>ListSummer</span> <span class=n>rightSummer</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ListSummer</span><span class=o>(</span><span class=n>rightSublist</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>leftSummer</span><span class=o>.</span><span class=na>fork</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>rightSummer</span><span class=o>.</span><span class=na>fork</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>Integer</span> <span class=n>leftSum</span> <span class=o>=</span> <span class=n>leftSummer</span><span class=o>.</span><span class=na>join</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>Integer</span> <span class=n>rightSum</span> <span class=o>=</span> <span class=n>rightSummer</span><span class=o>.</span><span class=na>join</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>total</span> <span class=o>=</span> <span class=n>leftSum</span> <span class=o>+</span> <span class=n>listToSum</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=n>middleIndex</span><span class=o>)</span> <span class=o>+</span> <span class=n>rightSum</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=n>log</span><span class=o>.</span><span class=na>info</span><span class=o>(</span><span class=s>&#34;Left sum is {}, right sum is {}, total is {}&#34;</span><span class=o>,</span> <span class=n>leftSum</span><span class=o>,</span> <span class=n>rightSum</span><span class=o>,</span> <span class=n>total</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>total</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>Firstly, we extend the <a href=https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/util/concurrent/RecursiveTask.html>RecursiveTask</a> subtype of the <a href=https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/util/concurrent/ForkJoinTask.html>ForkJoinTask</a>. This is the type to extend from when we expect our concurrent task to return a result. When a task does not return a result but only perform an effect, we extend the <a href=https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/util/concurrent/RecursiveAction.html>RecursiveAction</a> subtype. For most of the practical tasks that we solve, these two subtypes are sufficient.</p><p>Secondly, both RecursiveTask and RecursiveAction define an abstract compute method. This is where we put our computation.</p><p>Thirdly, inside our compute method, we check the size of the list that is passed through the constructor. If it is empty, we already know the result of the sum which is zero, and we return immediately. Otherwise, we divide our lists into two sublists and create two instances of our ListSummer type. We then call the <a href=https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/util/concurrent/ForkJoinTask.html#fork()>fork()</a> method (defined in ForkJoinTask) on these two instances -</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>leftSummer</span><span class=o>.</span><span class=na>fork</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=n>rightSummer</span><span class=o>.</span><span class=na>fork</span><span class=o>();</span>
</span></span></code></pre></div><p>Which cause these tasks to be scheduled for asynchronous execution, the exact mechanism which is used for this purpose will be explained later in this post.</p><p>After that, we invoke the <a href=https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/util/concurrent/ForkJoinTask.html#join()>join()</a> method (also defined in ForkJoinTask) to wait for the result of these two parts -</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>Integer</span> <span class=n>leftSum</span> <span class=o>=</span> <span class=n>leftSummer</span><span class=o>.</span><span class=na>join</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=n>Integer</span> <span class=n>rightSum</span> <span class=o>=</span> <span class=n>rightSummer</span><span class=o>.</span><span class=na>join</span><span class=o>();</span>
</span></span></code></pre></div><p>Which are then summed with the middle element of the list to get the final result.</p><p>Plenty of log messages have been added to make the example easier to understand. However, when we process a list containing thousands of entries, it might not be a good idea to have this detailed logging, especially logging the entire list.</p><p>That&rsquo;s pretty much it. Let&rsquo;s create a test class now for a test run -</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>ListSummerTest</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@Test</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=kt>void</span> <span class=nf>shouldSumEmptyList</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>ListSummer</span> <span class=n>summer</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ListSummer</span><span class=o>(</span><span class=n>List</span><span class=o>.</span><span class=na>of</span><span class=o>());</span>
</span></span><span class=line><span class=cl>    <span class=n>ForkJoinPool</span> <span class=n>forkJoinPool</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ForkJoinPool</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>forkJoinPool</span><span class=o>.</span><span class=na>submit</span><span class=o>(</span><span class=n>summer</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>result</span> <span class=o>=</span> <span class=n>summer</span><span class=o>.</span><span class=na>join</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>assertThat</span><span class=o>(</span><span class=n>result</span><span class=o>).</span><span class=na>isZero</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@Test</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=kt>void</span> <span class=nf>shouldSumListWithOneElement</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>ListSummer</span> <span class=n>summer</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ListSummer</span><span class=o>(</span><span class=n>List</span><span class=o>.</span><span class=na>of</span><span class=o>(</span><span class=mi>5</span><span class=o>));</span>
</span></span><span class=line><span class=cl>    <span class=n>ForkJoinPool</span> <span class=n>forkJoinPool</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ForkJoinPool</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>forkJoinPool</span><span class=o>.</span><span class=na>submit</span><span class=o>(</span><span class=n>summer</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>result</span> <span class=o>=</span> <span class=n>summer</span><span class=o>.</span><span class=na>join</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>assertThat</span><span class=o>(</span><span class=n>result</span><span class=o>).</span><span class=na>isEqualTo</span><span class=o>(</span><span class=mi>5</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@Test</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=kt>void</span> <span class=nf>shouldSumListWithMultipleElements</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>ListSummer</span> <span class=n>summer</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ListSummer</span><span class=o>(</span><span class=n>List</span><span class=o>.</span><span class=na>of</span><span class=o>(</span>
</span></span><span class=line><span class=cl>        <span class=mi>1</span><span class=o>,</span> <span class=mi>2</span><span class=o>,</span> <span class=mi>3</span><span class=o>,</span> <span class=mi>4</span><span class=o>,</span> <span class=mi>5</span><span class=o>,</span> <span class=mi>6</span><span class=o>,</span> <span class=mi>7</span><span class=o>,</span> <span class=mi>8</span><span class=o>,</span> <span class=mi>9</span>
</span></span><span class=line><span class=cl>    <span class=o>));</span>
</span></span><span class=line><span class=cl>    <span class=n>ForkJoinPool</span> <span class=n>forkJoinPool</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ForkJoinPool</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>forkJoinPool</span><span class=o>.</span><span class=na>submit</span><span class=o>(</span><span class=n>summer</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>result</span> <span class=o>=</span> <span class=n>summer</span><span class=o>.</span><span class=na>join</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>assertThat</span><span class=o>(</span><span class=n>result</span><span class=o>).</span><span class=na>isEqualTo</span><span class=o>(</span><span class=mi>45</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>In the test, we create an instance of the <a href=https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/util/concurrent/ForkJoinPool.html>ForkJoinPool</a>. A ForkJoinPool is a unique ExecutorService implementation for running ForkJoinTasks. It employs a special algorithm known as the work-stealing algorithm. Contrary to the other ExecutorService implementations where there is only a single queue holding all the tasks to be executed, in a work-stealing implementation, each worker thread gets its work queue. Each thread starts executing tasks from their queue. When we detect that a ForkJoinTask can be broken down into multiple smaller subtasks, we do break them into smaller tasks, and then we invoke the fork() method on those tasks. This invocation causes the subtasks to be pushed into the executing thread&rsquo;s queue. During the execution, when one thread exhausts its queue/has no tasks to execute, it can &ldquo;steal&rdquo; tasks from other thread&rsquo;s queue (hence the name &ldquo;work-stealing&rdquo;). This stealing behaviour is what results in a better throughput than using any other ExecutorService implementations.</p><p>Earlier, when we invoked fork() on our leftSummer and rightSummer task instances, they got pushed into the work queue of the executing thread, after which they were &ldquo;stolen&rdquo; by other active threads in the pool (and so on) since they did not have anything else to do at that point.</p><p>Pretty cool, right?</p><h2 id=solving-a-blocking-task>Solving a blocking task<a hidden class=anchor aria-hidden=true href=#solving-a-blocking-task>#</a></h2><p>The problem we solved just now is non-blocking in nature. If we want to solve a problem which does some blocking operation, then to have a better throughput we will need to change our strategy.</p><p>Let&rsquo;s examine this with another example. Let&rsquo;s say we want to create a very simple web crawler. This crawler will receive a list of HTTP links, execute GET requests to fetch the response bodies, and then calculate the response length. Here is the code -</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Slf4j</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>ResponseLengthCalculator</span> <span class=kd>extends</span> <span class=n>RecursiveTask</span><span class=o>&lt;</span><span class=n>Map</span><span class=o>&lt;</span><span class=n>String</span><span class=o>,</span> <span class=n>Integer</span><span class=o>&gt;&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kd>final</span> <span class=n>List</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span> <span class=n>links</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>ResponseLengthCalculator</span><span class=o>(</span><span class=n>List</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span> <span class=n>links</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=o>.</span><span class=na>links</span> <span class=o>=</span> <span class=n>links</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>  <span class=kd>protected</span> <span class=n>Map</span><span class=o>&lt;</span><span class=n>String</span><span class=o>,</span> <span class=n>Integer</span><span class=o>&gt;</span> <span class=nf>compute</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>links</span><span class=o>.</span><span class=na>isEmpty</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>log</span><span class=o>.</span><span class=na>info</span><span class=o>(</span><span class=s>&#34;No more links to fetch&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=n>Collections</span><span class=o>.</span><span class=na>emptyMap</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>middle</span> <span class=o>=</span> <span class=n>links</span><span class=o>.</span><span class=na>size</span><span class=o>()</span> <span class=o>/</span> <span class=mi>2</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=n>log</span><span class=o>.</span><span class=na>info</span><span class=o>(</span><span class=s>&#34;Middle index: {}&#34;</span><span class=o>,</span> <span class=n>links</span><span class=o>,</span> <span class=n>middle</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>ResponseLengthCalculator</span> <span class=n>leftPartition</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ResponseLengthCalculator</span><span class=o>(</span><span class=n>links</span><span class=o>.</span><span class=na>subList</span><span class=o>(</span><span class=mi>0</span><span class=o>,</span> <span class=n>middle</span><span class=o>));</span>
</span></span><span class=line><span class=cl>    <span class=n>ResponseLengthCalculator</span> <span class=n>rightPartition</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ResponseLengthCalculator</span><span class=o>(</span><span class=n>links</span><span class=o>.</span><span class=na>subList</span><span class=o>(</span><span class=n>middle</span> <span class=o>+</span> <span class=mi>1</span><span class=o>,</span> <span class=n>links</span><span class=o>.</span><span class=na>size</span><span class=o>()));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>log</span><span class=o>.</span><span class=na>info</span><span class=o>(</span><span class=s>&#34;Forking left partition&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>leftPartition</span><span class=o>.</span><span class=na>fork</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>log</span><span class=o>.</span><span class=na>info</span><span class=o>(</span><span class=s>&#34;Left partition forked, now forking right partition&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>rightPartition</span><span class=o>.</span><span class=na>fork</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>log</span><span class=o>.</span><span class=na>info</span><span class=o>(</span><span class=s>&#34;Right partition forked&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>String</span> <span class=n>middleLink</span> <span class=o>=</span> <span class=n>links</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=n>middle</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>HttpRequester</span> <span class=n>httpRequester</span> <span class=o>=</span> <span class=k>new</span> <span class=n>HttpRequester</span><span class=o>(</span><span class=n>middleLink</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>String</span> <span class=n>response</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>log</span><span class=o>.</span><span class=na>info</span><span class=o>(</span><span class=s>&#34;Calling managedBlock for {}&#34;</span><span class=o>,</span> <span class=n>middleLink</span><span class=o>);</span>
</span></span><span class=line><span class=cl>      <span class=n>ForkJoinPool</span><span class=o>.</span><span class=na>managedBlock</span><span class=o>(</span><span class=n>httpRequester</span><span class=o>);</span>
</span></span><span class=line><span class=cl>      <span class=n>response</span> <span class=o>=</span> <span class=n>httpRequester</span><span class=o>.</span><span class=na>response</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>InterruptedException</span> <span class=n>ex</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>log</span><span class=o>.</span><span class=na>error</span><span class=o>(</span><span class=s>&#34;Error occurred while trying to implement blocking link fetcher&#34;</span><span class=o>,</span> <span class=n>ex</span><span class=o>);</span>
</span></span><span class=line><span class=cl>      <span class=n>response</span> <span class=o>=</span> <span class=s>&#34;&#34;</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>Map</span><span class=o>&lt;</span><span class=n>String</span><span class=o>,</span> <span class=n>Integer</span><span class=o>&gt;</span> <span class=n>responseMap</span> <span class=o>=</span> <span class=k>new</span> <span class=n>HashMap</span><span class=o>&lt;&gt;(</span><span class=n>links</span><span class=o>.</span><span class=na>size</span><span class=o>());</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>Map</span><span class=o>&lt;</span><span class=n>String</span><span class=o>,</span> <span class=n>Integer</span><span class=o>&gt;</span> <span class=n>leftLinks</span> <span class=o>=</span> <span class=n>leftPartition</span><span class=o>.</span><span class=na>join</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>responseMap</span><span class=o>.</span><span class=na>putAll</span><span class=o>(</span><span class=n>leftLinks</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>responseMap</span><span class=o>.</span><span class=na>put</span><span class=o>(</span><span class=n>middleLink</span><span class=o>,</span> <span class=n>response</span><span class=o>.</span><span class=na>length</span><span class=o>());</span>
</span></span><span class=line><span class=cl>    <span class=n>Map</span><span class=o>&lt;</span><span class=n>String</span><span class=o>,</span> <span class=n>Integer</span><span class=o>&gt;</span> <span class=n>rightLinks</span> <span class=o>=</span> <span class=n>rightPartition</span><span class=o>.</span><span class=na>join</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>responseMap</span><span class=o>.</span><span class=na>putAll</span><span class=o>(</span><span class=n>rightLinks</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>log</span><span class=o>.</span><span class=na>info</span><span class=o>(</span><span class=s>&#34;Left map {}, middle length {}, right map {}&#34;</span><span class=o>,</span> <span class=n>leftLinks</span><span class=o>,</span> <span class=n>response</span><span class=o>.</span><span class=na>length</span><span class=o>(),</span> <span class=n>rightLinks</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>responseMap</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kd>static</span> <span class=kd>class</span> <span class=nc>HttpRequester</span> <span class=kd>implements</span> <span class=n>ForkJoinPool</span><span class=o>.</span><span class=na>ManagedBlocker</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>final</span> <span class=n>String</span> <span class=n>link</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>String</span> <span class=n>response</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=nf>HttpRequester</span><span class=o>(</span><span class=n>String</span> <span class=n>link</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>this</span><span class=o>.</span><span class=na>link</span> <span class=o>=</span> <span class=n>link</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>boolean</span> <span class=nf>block</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>HttpGet</span> <span class=n>headRequest</span> <span class=o>=</span> <span class=k>new</span> <span class=n>HttpGet</span><span class=o>(</span><span class=n>link</span><span class=o>);</span>
</span></span><span class=line><span class=cl>      <span class=n>CloseableHttpClient</span> <span class=n>client</span> <span class=o>=</span> <span class=n>HttpClientBuilder</span>
</span></span><span class=line><span class=cl>          <span class=o>.</span><span class=na>create</span><span class=o>()</span>
</span></span><span class=line><span class=cl>          <span class=o>.</span><span class=na>disableRedirectHandling</span><span class=o>()</span>
</span></span><span class=line><span class=cl>          <span class=o>.</span><span class=na>build</span><span class=o>();</span>
</span></span><span class=line><span class=cl>      
</span></span><span class=line><span class=cl>      <span class=n>log</span><span class=o>.</span><span class=na>info</span><span class=o>(</span><span class=s>&#34;Executing blocking request for {}&#34;</span><span class=o>,</span> <span class=n>link</span><span class=o>);</span>
</span></span><span class=line><span class=cl>      
</span></span><span class=line><span class=cl>      <span class=k>try</span> <span class=o>(</span><span class=n>client</span><span class=o>;</span> <span class=n>CloseableHttpResponse</span> <span class=n>response</span> <span class=o>=</span> <span class=n>client</span><span class=o>.</span><span class=na>execute</span><span class=o>(</span><span class=n>headRequest</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>log</span><span class=o>.</span><span class=na>info</span><span class=o>(</span><span class=s>&#34;HTTP request for link {} has been executed&#34;</span><span class=o>,</span> <span class=n>link</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=o>.</span><span class=na>response</span> <span class=o>=</span> <span class=n>EntityUtils</span><span class=o>.</span><span class=na>toString</span><span class=o>(</span><span class=n>response</span><span class=o>.</span><span class=na>getEntity</span><span class=o>());</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>IOException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>log</span><span class=o>.</span><span class=na>error</span><span class=o>(</span><span class=s>&#34;Error while trying to fetch response from link {}: {}&#34;</span><span class=o>,</span> <span class=n>link</span><span class=o>,</span> <span class=n>e</span><span class=o>.</span><span class=na>getMessage</span><span class=o>());</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=o>.</span><span class=na>response</span> <span class=o>=</span> <span class=s>&#34;&#34;</span><span class=o>;</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>boolean</span> <span class=nf>isReleasable</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>We create an implementation of the <a href=https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/util/concurrent/ForkJoinPool.ManagedBlocker.html>ForkJoinPool.ManagedBlocker</a> where we put the blocking HTTP call. This interface defines two methods - block() and isReleasable(). The block() method is where we put our blocking call. After we are done with our blocking operation, we return true indicating that no further blocking is necessary. We return false from the isReleasable() implementation to indicate to a fork-join worker thread that the block() method implementation is potentially blocking in nature. The isReleasable() implementation will be invoked by a fork-join worker thread first before it invokes the block() method. Finally, we submit our HttpRequester instance to our pool by invoking ForkJoinPool.managedBlock() static method. After that our blocking task will start executing. When it blocks on the HTTP request, the <a href=https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/util/concurrent/ForkJoinPool.html#managedBlock(java.util.concurrent.ForkJoinPool.ManagedBlocker)>ForkJoinPool.managedBlock()</a> method will also arrange for a spare thread to be activated if necessary to ensure sufficient parallelism.</p><p>Let&rsquo;s take this implementation for a test drive then! Here&rsquo;s the code -</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>ResponseLengthCalculatorTest</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@Test</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=kt>void</span> <span class=nf>shouldReturnEmptyMapForEmptyList</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>ResponseLengthCalculator</span> <span class=n>responseLengthCalculator</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ResponseLengthCalculator</span><span class=o>(</span><span class=n>Collections</span><span class=o>.</span><span class=na>emptyList</span><span class=o>());</span>
</span></span><span class=line><span class=cl>    <span class=n>ForkJoinPool</span> <span class=n>pool</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ForkJoinPool</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>pool</span><span class=o>.</span><span class=na>submit</span><span class=o>(</span><span class=n>responseLengthCalculator</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>Map</span><span class=o>&lt;</span><span class=n>String</span><span class=o>,</span> <span class=n>Integer</span><span class=o>&gt;</span> <span class=n>result</span> <span class=o>=</span> <span class=n>responseLengthCalculator</span><span class=o>.</span><span class=na>join</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>assertThat</span><span class=o>(</span><span class=n>result</span><span class=o>).</span><span class=na>isEmpty</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@Test</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=kt>void</span> <span class=nf>shouldHandle200Ok</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>ResponseLengthCalculator</span> <span class=n>responseLengthCalculator</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ResponseLengthCalculator</span><span class=o>(</span><span class=n>List</span><span class=o>.</span><span class=na>of</span><span class=o>(</span>
</span></span><span class=line><span class=cl>        <span class=s>&#34;http://httpstat.us/200&#34;</span>
</span></span><span class=line><span class=cl>    <span class=o>));</span>
</span></span><span class=line><span class=cl>    <span class=n>ForkJoinPool</span> <span class=n>pool</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ForkJoinPool</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>pool</span><span class=o>.</span><span class=na>submit</span><span class=o>(</span><span class=n>responseLengthCalculator</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>Map</span><span class=o>&lt;</span><span class=n>String</span><span class=o>,</span> <span class=n>Integer</span><span class=o>&gt;</span> <span class=n>result</span> <span class=o>=</span> <span class=n>responseLengthCalculator</span><span class=o>.</span><span class=na>join</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>assertThat</span><span class=o>(</span><span class=n>result</span><span class=o>)</span>
</span></span><span class=line><span class=cl>        <span class=o>.</span><span class=na>hasSize</span><span class=o>(</span><span class=mi>1</span><span class=o>)</span>
</span></span><span class=line><span class=cl>        <span class=o>.</span><span class=na>containsKeys</span><span class=o>(</span><span class=s>&#34;http://httpstat.us/200&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>        <span class=o>.</span><span class=na>containsValue</span><span class=o>(</span><span class=mi>0</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@Test</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=kt>void</span> <span class=nf>shouldFetchResponseForDifferentResponseStatus</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>ResponseLengthCalculator</span> <span class=n>responseLengthCalculator</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ResponseLengthCalculator</span><span class=o>(</span><span class=n>List</span><span class=o>.</span><span class=na>of</span><span class=o>(</span>
</span></span><span class=line><span class=cl>        <span class=s>&#34;http://httpstat.us/200&#34;</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=s>&#34;http://httpstat.us/302&#34;</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=s>&#34;http://httpstat.us/404&#34;</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=s>&#34;http://httpstat.us/502&#34;</span>
</span></span><span class=line><span class=cl>    <span class=o>));</span>
</span></span><span class=line><span class=cl>    <span class=n>ForkJoinPool</span> <span class=n>pool</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ForkJoinPool</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>pool</span><span class=o>.</span><span class=na>submit</span><span class=o>(</span><span class=n>responseLengthCalculator</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>Map</span><span class=o>&lt;</span><span class=n>String</span><span class=o>,</span> <span class=n>Integer</span><span class=o>&gt;</span> <span class=n>result</span> <span class=o>=</span> <span class=n>responseLengthCalculator</span><span class=o>.</span><span class=na>join</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>assertThat</span><span class=o>(</span><span class=n>result</span><span class=o>)</span>
</span></span><span class=line><span class=cl>        <span class=o>.</span><span class=na>hasSize</span><span class=o>(</span><span class=mi>4</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>That&rsquo;s it for today, folks! As always, any feedback/improvement suggestions/comments are highly appreciated!</p><p>All the examples discussed here can be found on <a href=https://github.com/sayembd/java-examples>Github</a>.</p><p>A big shout out to the awesome <a href=http://httpstat.us>http://httpstat.us</a> service, it was quite helpful for developing the simple tests.</p></div><footer class=post-footer><ul class=post-tags></ul><nav class=paginav><a class=prev href=https://www.sayemahmed.com/posts/different-states-of-java-threads/><span class=title>« Prev</span><br><span>Different States of Java Threads</span></a>
<a class=next href=https://www.sayemahmed.com/posts/java-tips-creating-a-monitoring-friendly-executorservice/><span class=title>Next »</span><br><span>Java Tips: Creating a Monitoring-friendly ExecutorService</span></a></nav><ul class=share-buttons><li><a target=_blank rel="noopener noreferrer" aria-label="share A Brief Overview of the Fork Join Framework in Java on x" href="https://x.com/intent/tweet/?text=A%20Brief%20Overview%20of%20the%20Fork%20Join%20Framework%20in%20Java&amp;url=https%3a%2f%2fwww.sayemahmed.com%2fposts%2fa-brief-overview-of-the-fork-join-framework-in-java%2f&amp;hashtags="><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share A Brief Overview of the Fork Join Framework in Java on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fwww.sayemahmed.com%2fposts%2fa-brief-overview-of-the-fork-join-framework-in-java%2f&amp;title=A%20Brief%20Overview%20of%20the%20Fork%20Join%20Framework%20in%20Java&amp;summary=A%20Brief%20Overview%20of%20the%20Fork%20Join%20Framework%20in%20Java&amp;source=https%3a%2f%2fwww.sayemahmed.com%2fposts%2fa-brief-overview-of-the-fork-join-framework-in-java%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share A Brief Overview of the Fork Join Framework in Java on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fwww.sayemahmed.com%2fposts%2fa-brief-overview-of-the-fork-join-framework-in-java%2f&title=A%20Brief%20Overview%20of%20the%20Fork%20Join%20Framework%20in%20Java"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share A Brief Overview of the Fork Join Framework in Java on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fwww.sayemahmed.com%2fposts%2fa-brief-overview-of-the-fork-join-framework-in-java%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share A Brief Overview of the Fork Join Framework in Java on whatsapp" href="https://api.whatsapp.com/send?text=A%20Brief%20Overview%20of%20the%20Fork%20Join%20Framework%20in%20Java%20-%20https%3a%2f%2fwww.sayemahmed.com%2fposts%2fa-brief-overview-of-the-fork-join-framework-in-java%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share A Brief Overview of the Fork Join Framework in Java on telegram" href="https://telegram.me/share/url?text=A%20Brief%20Overview%20of%20the%20Fork%20Join%20Framework%20in%20Java&amp;url=https%3a%2f%2fwww.sayemahmed.com%2fposts%2fa-brief-overview-of-the-fork-join-framework-in-java%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share A Brief Overview of the Fork Join Framework in Java on ycombinator" href="https://news.ycombinator.com/submitlink?t=A%20Brief%20Overview%20of%20the%20Fork%20Join%20Framework%20in%20Java&u=https%3a%2f%2fwww.sayemahmed.com%2fposts%2fa-brief-overview-of-the-fork-join-framework-in-java%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentcolor" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></li></ul></footer></article></main><footer class=footer><span>&copy; 2024 <a href=https://www.sayemahmed.com>Random Musings</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>