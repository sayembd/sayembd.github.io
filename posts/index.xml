<?xml version="1.0" encoding="utf-8" standalone="yes"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:content="http://purl.org/rss/1.0/modules/content/">
  <channel>
    <title>Posts on Random Musings</title>
    <link>https://sayembd.github.io/posts/</link>
    <description>Recent content in Posts on Random Musings</description>
    <generator>Hugo -- gohugo.io</generator>
    <lastBuildDate>Mon, 19 Oct 2020 02:38:52 +0200</lastBuildDate><atom:link href="https://sayembd.github.io/posts/index.xml" rel="self" type="application/rss+xml" />
    <item>
      <title>How to Build Observable Systems - An Introduction to Observability</title>
      <link>https://sayembd.github.io/posts/how-to-build-observable-system-an-introduction-to-observability/</link>
      <pubDate>Mon, 19 Oct 2020 02:38:52 +0200</pubDate>
      
      <guid>https://sayembd.github.io/posts/how-to-build-observable-system-an-introduction-to-observability/</guid>
      <description>What is Observability? What is an Observable System? This article tries to explain these concepts in a beginner-friendly way.</description>
      <content:encoded><![CDATA[<h2 id="introduction">Introduction</h2>
<p>Recently I have been hearing about observability more and more. The promise that an observable system can help us to debug and identify performance and reliability issues in a microservice architecture sounded quite good to me. Hence I decided to read up and learn more on this topic. In this blog post I will try to summarise what I have learned about observability so far.</p>
<h2 id="what-is-observability">What is Observability?</h2>
<p>Observability is a term or a concept that has its root in Physics, mainly in Control Theory. According to <a href="https://en.wikipedia.org/wiki/Observability">Wikipedia</a> -</p>
<blockquote>
<p><em>Observability is a measure of how well internal states of a system can be inferred from knowledge of its external outputs.</em></p>
<p><em>&hellip; A system is said to be observable if, for any possible evolution of state and control vectors, the current state can be estimated using only the information from outputs (physically, this generally corresponds to information obtained by sensors). In other words, one can determine the behavior of the entire system from the system&rsquo;s outputs. On the other hand, if the system is not observable, there are state trajectories that are not distinguishable by only measuring the outputs.</em></p>
</blockquote>
<p>Extending the same concept to a software system, we can say -</p>
<blockquote>
<p><em>A software system is observable if we can ask new questions from the outside to understand what is going on on the inside, all without deploying new code.</em></p>
</blockquote>
<p>So in effect, observability is a measure of how well we can make sense of what is going on with our application by asking arbitrary questions (the unknown-unknowns) about the system, without having to know the questions in advance. The more observable our systems are, the more arbitrary questions we are able to ask. Used effectively, it can greatly improve our application quality and reliability by making it relatively easy to debug and identify potential performance and reliability issues in production.</p>
<h2 id="why-should-i-care-about-observability">Why should I care about Observability?</h2>
<p>Because software is becoming more and more complex than what it used to be, making it more difficult to predict most of the production issues in advance.</p>
<p>Consider a regular monolithic application. In such applications the entire codebase is in one place, making it possible to browse through different use cases end-to-end and anticipate most (if not all) of the production issues in advance. Once the problematic areas have been identified we augment the application code to collect and report various metrics, visualise these metrics in dashboards, and create alerts. Combining application logs with with these collected metrics was often enough to debug most of the performance and reliability issues in production. If we could also throw in distributed tracing to the mix, then our chances of finding and quickly fixing these issues would increase even further.</p>
<p>Contrast this with the current trend in the software world. Nowadays we see a clear preference among companies to decompose large monolithic applications into smaller-sized microservices in order to achieve greater business agility. As a result, systems are becoming more and more distributed. Small and independent teams are working on different distributed systems in parallel whose code bases are separate. What used to be functions invocations before have now been converted to network calls between remote applications. With the adoption of DevOps practices releases are becoming more frequent, reducing the time needed to release features to production once they are ready.  All of these are resulting in more moving parts in a system which are changing frequently at their own pace, making it difficult to predict how an application will <a href="https://www.martinfowler.com/bliki/SyntheticMonitoring.html">behave in production</a>. Often times, questions like “will the release of this new features in application X interfere with the existing features in application a? What about application b? Or c?….” can be answered only after we release application X in production. As a direct consequence of adopting a microservice-oriented architecture, debugging gets more difficult than a monolithic system.</p>
<p>This is where the concept of observability is particularly useful. Being able to ask arbitrary questions about our entire system without having to know them in advance can greatly reduce the burden of debugging and identifying performance and reliability issues in a microservice architecture.</p>
<h2 id="the-3-pillars-of-observability">The 3 pillars of Observability</h2>
<p>Metrics, Logs, and Distributed Traces are often called the 3 pillars of observability because these are the tools we have been traditionally using to make sense of our system. Most of us already familiar with these concepts and related tools, so we are not going to dive deep into them in this article. Instead, we will try to understand why these 3 pillars are not enough to create an observable system.</p>
<h3 id="metrics">Metrics</h3>
<p>Metrics are numerical measurements taken over intervals of time. We use metrics to to measure response times of requests, to count the number requests that failed to get a valid response etc. For a long time metrics have been the standard way to monitor the overall health of an application - number of live instances, current memory consumption, cpu usage, response times, query execution time etc. They are also being used to trigger alerts in case of emergencies like instances going down, low memory, high cpu usage etc. All in all, very useful tool.</p>
<p>However, traditional metrics-based tools are not enough to create an observable system. One of the primary reasons for this is that any tools that are metric-based can deal with only low-cardinality dimensions. Things like user ids, purchase ids, shopping cart ids - any data that have high-cardinality are not collected with these tools as otherwise the cost would blow up. Also, in order to keep the associated costs low, metrics are aggregated on the client-side and then stored in their aggregated form, losing granularity even further. Without high-cardinality data it is difficult to investigate and debug issues in a microservice architecture. As a result any questions that are answered by a metric-based tool have to be pre-defined so that we can collect targeted metrics to answer them. This is an antithesis to the premise of observability as observability requires being able to ask arbitrary questions about a system without knowing them in advance. Without high-cardinality data, this is not possible.</p>
<p>Another downside is that the metrics that are collected are not tied to their source request which triggered them. In a microsevice-oriented architecture a single user request can hit many different services, query different databases or caches, send messages to queues or kafka topics, or can interact with any combination of these. We can collect metrics from each of these sources, but once collected we can never link them back together. This makes it difficult to answer questions like <em>why do this particular group of users see a high response times of 10 seconds while our metrics dashboard is showing a p99 of 1 seconds</em>?</p>
<h3 id="logs">Logs</h3>
<p>Logs are a useful tool which help us debug issues by providing us context-dependent messages and stack traces. However, they cannot be used effectively to create an observable system.</p>
<p>One of the primary downsides of using logging to create an observable system is the associated cost. Systems that use logging to improve observability becomes too expensive to maintain. This is how <a href="https://twitter.com/el_bhs">Ben Sigelman</a>, co-founder of Lightstep, explains the problem in <a href="https://lightstep.com/blog/three-pillars-zero-answers-towards-new-scorecard-observability/">one of his articles</a> written on the Lightstep blog (I highly recommend to give the entire article a thorough read) -</p>
<blockquote>
<p><em>If we want to use logs to account for individual transactions (like we used to in the days of a monolithic web server&rsquo;s request logs), we would need to pay for the following:</em></p>
<pre><code> Application transaction rate
     * all microservices
     * cost of network and storage
     * weeks of data retention
 = way, way too much $$$$
</code></pre>
<p><em>Logging systems can&rsquo;t afford to store data about every transaction anymore because the cost of those transactional logs is proportional to the number of microservices touched by an average transaction.</em></p>
</blockquote>
<p>Another downside is that In order to answer any arbitrary questions about our system we would have to log quite aggressively. Since traditional logging libraries cannot dynamically sample logs, logging excessively could adversely affect the performance of the application as a whole.</p>
<h3 id="distributed-tracing">Distributed Tracing</h3>
<p>This is how <a href="https://opentracing.io/">OpenTracing</a>, a Cloud Native Computing Foundation project, defines Distributed Tracing -</p>
<blockquote>
<p><em>Distributed tracing, also called distributed request tracing, is a method used to profile and monitor applications, especially those built using a microservices architecture. Distributed tracing helps pinpoint where failures occur and what causes poor performance.</em></p>
</blockquote>
<p>Distributed Tracing has its use in building an observable system. After all, they are the threads with which we can connect an end-to-end request in a microservice architecture. However, they come with a few challenges on their own.</p>
<p>The first challenge is choosing a right sampling strategy. Traditionally distributed tracing tools have been making the decision of whether to sample a request or not at the very beginning, when a request enters the infrastructure for the first time from outside. This results in a sampling strategy that is either too aggressive and collect too much data which are expensive to store and analyse, or too relaxed and does not collect enough data to help us with observability.</p>
<p>The second challenge is the UI with which we analyse the trace data. Tracing tools usually come with a UI component which display all the traces in what is called a trace view. In a system with hundreds of services where a typical request touches 20 or 30 of them, the trace view becomes too complex for a human to analyse without any automated support. In addition, spans, which are treated as units of work by the tracing systems and responsible for capturing trace data from services, are too low level to be used for debugging purposes. <a href="https://twitter.com/copyconstruct">Cindy Sridharan</a> wrote <a href="https://copyconstruct.medium.com/distributed-tracing-weve-been-doing-it-wrong-39fc92a857df">an excellent article</a> on this topic where she explains the problem in a much better way -</p>
<blockquote>
<p><em>Admittedly, some tracing systems provide condensed traceviews when the number of spans in a trace are so exceedingly large that they cannot be displayed in a single visualization. Yet, the amount of information being encapsulated even in such pared down views still squarely puts the onus on the engineers to sift through all the data the traceview exposes and narrow down the set of culprit services. This is an endeavor machines are truly faster, more repeatable and less error-prone than humans at accomplishing.</em></p>
<p><em>&hellip; The fundamental problem with the traceview is that a span is too low-level a primitive for both latency and “root cause” analysis. It’s akin to looking at individual CPU instructions to debug an exception when a much higher level entity like a backtrace would benefit day-to-day engineers the most.</em></p>
<p><em>Furthermore, I’d argue that what is ideally required isn’t the entire picture of what happened during the lifecycle of a request that modern day traces depict. What is instead required is some form of higher level abstraction of what went wrong (analogous to the backtrace) along with some context. Instead of seeing an entire trace, what I really want to be seeing is a portion of the trace where something interesting or unusual is happening. Currently, this process is entirely manual: given a trace, an engineer is required to find relevant spans to spot anything interesting. Humans eyeballing spans in individual traces in the hopes of finding suspicious behavior simply isn’t scalable, especially when they have to deal with the cognitive overhead of making sense of all the metadata encoded in all the various spans like the span ID, the RPC method name, the duration of the span, logs, tags and so forth.</em></p>
</blockquote>
<p>I highly recommend you to give the article a thorough read.</p>
<h2 id="what-does-an-ideal-observability-tool-look-like">What does an ideal Observability tool look like?</h2>
<p><a href="https://twitter.com/mipsytipsy">Charity Majors</a>, co-founder of HoneyComb, wrote <a href="https://www.honeycomb.io/blog/so-you-want-to-build-an-observability-tool/">an excellent article</a> on the HoneyComb blog where she mentions the criteria that a tool must fulfil in order to deliver observability -</p>
<ol>
<li>Arbitrarily-wide structured raw events</li>
<li>Context persisted through the execution path</li>
<li>Without indexes or schemas</li>
<li>High-cardinality, high-dimensionality</li>
<li>Ordered dimensions for traceability</li>
<li>Client-side dynamic sampling</li>
<li>An exploratory visual interface that lets you slice and dice and combine dimensions</li>
<li>In close to real-time</li>
</ol>
<p>She then goes on to explain the reasoning behind her choices, all of which I fully agree with. I highly recommend giving the article a thorough read.</p>
<h2 id="trying-out-an-existing-observability-tool---honeycomb">Trying out an existing Observability tool - HoneyComb</h2>
<p>In the same article that I have mentioned just now, Charity mentions how <a href="https://www.honeycomb.io/">HoneyComb</a> was built to deliver on these promises. Hence I decided to give it a try by checking out their live play scenarios.</p>
<p>In the <a href="https://play.honeycomb.io/tracing">Play with Tracing and BubbleUp</a> scenario I followed the step by step guide to identify some outlier requests which were taking longer than the rest. By the end of the demo I was able to nail the problem down to the individual user who was experiencing the slower response times. I could definitely see how this technique could help me to debug performance issues in production which are affecting a portion of the users but are not visible in my pre-defined metrics dashboard.</p>
<p>Next I tried out the <a href="https://play.honeycomb.io/events">Play with Events</a> scenario which contains data about an actual production incident that HoneyComb <a href="https://www.honeycomb.io/blog/rds-performance-degradation-postmortem/">faced back in 2018</a>. Using the step by step guide as before I was able to identify the failed database that was the root of the issue.</p>
<p>I noticed the following aspects of the tool -</p>
<ol>
<li>High-cardinality data: In the first scenario I was able to link the response time with an individual user, and then link the slower response time with the individual query that was being executed. Without high-cardinality this would have been impossible. In the absence of high cardinality data I could at best try to guess the issue and add sporadic log statements here and there, but I would still have to rely on luck to give me a break. Debugging should not be tied to luck.</li>
<li>Metrics are also tied to requests/traces: All response times were tied with each individual trace, thus making it easy to identify requests which were slow.</li>
<li>Wide events: The trace events contained a lot of data, including even the database query that was executed by the affected user! Without this query it would have been difficult to nail it down to the database performance problem.</li>
<li>Dynamic dashboards: all the dashboards that are being generated are fully dynamic, and it&rsquo;s possible to create dashboards per dimension!</li>
</ol>
<p>At this point I was curious to know the strategy HoneyComb uses to decide which requests to sample. I searched in the doc and found <a href="https://docs.honeycomb.io/working-with-your-data/best-practices/sampling/#static-map-of-sample-rates">the section about Dynamic Sampling</a>, where it&rsquo;s mentioned how it&rsquo;s possible to make the sampling decision based on whether an HTTP request encounters an error -</p>
<blockquote>
<p><em>For example: when recording HTTP events, we may care about seeing every server error but need less resolution when looking at successful requests. We can then set the sample rate for successful requests to 100 (storing one in a hundred successful events). We include the sample rate along with each event—100 for successful events and 1 for error events.</em></p>
</blockquote>
<p>Hence with HoneyComb it is possible to delay the sampling decision once the request has been fully executed. This strategy is very handy and can be used to sample aggressively for failed/problematic requests and thus making it easy to debug them, while at the same time performing a relaxed sampling for the successful requests and thus helping us to keep the data volume low.</p>
<p>One other thing that I noticed - in order to identify which requests are slow, we first need to define what a slow request looks like. For some applications it may be perfectly acceptable if a request completes within 4 seconds, while for some other type of applications it might be too slow. Since <a href="https://landing.google.com/sre/sre-book/chapters/service-level-objectives/">SLI/SLO/SLAs are gaining more and more popularity</a> in our industry, it would make sense to use SLOs to define these criteria, and then create sampling strategies based on this definition. If a request fails our SLO, we can always decide to sample and store the request so that we can later debug why it failed. If it is successful, we can adopt a more relaxed sampling rate.</p>
<p>All in all, HoneyComb has left quite a good impression on me. Indeed it&rsquo;s an excellent tool!</p>
<h2 id="are-metric-based-monitoring-tools-going-to-be-obsolete">Are Metric-based monitoring tools going to be obsolete?</h2>
<p>I don&rsquo;t think so. Metrics-based monitoring tools are still the best choice when we want to answer any pre-defined questions about our system (also called known-unknowns) -</p>
<ol>
<li>How many application instances are live at the moment?</li>
<li>What is the amount of memory being consumed by the applications?</li>
<li>What is the CPU usage etc.</li>
</ol>
<p>Observability tools, on the other hand, are best at answering the unknown-unknowns, things like -</p>
<ol>
<li>Why does this user sees a response time of 4 seconds?</li>
<li>Why are the database queries hitting the database instances in region X take more than 5 seconds to complete etc.</li>
</ol>
<p>Any ideal observable system would combine them both.</p>
<h2 id="conclusion">Conclusion</h2>
<p>I am still at the very early stage of my observability journey, and still learning the concepts and the tools used in this field. However, I am already convinced that in a distributed system architecture observability practices are invaluable and can help us improve the quality and the reliability of our applications by a great deal. I intend to apply these practices in my day to day work and as I learn more I will definitely try to share my learnings in my blog (given time permits)!</p>
<h2 id="acknowledgements">Acknowledgements</h2>
<p>These are the resources which helped me learned about what observability truly is and how to build an observable system -</p>
<ol>
<li><a href="https://twitter.com/mipsytipsy/status/1305398051842871297">Definition of Observability by Charity Majors</a></li>
<li><a href="https://thenewstack.io/observability-a-3-year-retrospective/">Observability — A 3-Year Retrospective - Charity Majors</a></li>
<li><a href="https://lightstep.com/blog/three-pillars-zero-answers-towards-new-scorecard-observability/">Three Pillars with Zero Answers - Towards a New Scorecard for Observability - Ben Sigelman</a></li>
<li><a href="https://www.honeycomb.io/blog/so-you-want-to-build-an-observability-tool/">So You Want To Build An Observability Tool… - Charity Majors</a></li>
<li><a href="https://learning.oreilly.com/library/view/distributed-systems-observability/9781492033431/">Distributed Systems Observability - Cindy Sridharan</a></li>
<li><a href="https://copyconstruct.medium.com/distributed-tracing-weve-been-doing-it-wrong-39fc92a857df">Distributed Tracing — we’ve been doing it wrong - Cindy Sridharan</a></li>
</ol>
]]></content:encoded>
    </item>
    
    <item>
      <title>Writing Executable Specifications With Junit5 Mockito and AssertJ</title>
      <link>https://sayembd.github.io/posts/writing-executable-specifications-with-junit5-mockito-and-assertj/</link>
      <pubDate>Sun, 26 Apr 2020 22:40:20 +0200</pubDate>
      
      <guid>https://sayembd.github.io/posts/writing-executable-specifications-with-junit5-mockito-and-assertj/</guid>
      <description>A hands-on tutorial demonstrating a clean way to write unit tests as Executable Specifications using JUnit 5, Mockito, and AssertJ.</description>
      <content:encoded><![CDATA[<p>Executable Specifications are tests that can also serve as design specifications. They enable technical and business teams to get on the same page by enabling the use of a common language (in DDD-world this is also known as <a href="https://martinfowler.com/bliki/UbiquitousLanguage.html">Ubiquitous Language</a>). They function as documentations for the future maintainers of the code. In this article we will see an opinionated way of writing automated tests which could also function as Executable Specifications.</p>
<p>Let&rsquo;s start with an example. Suppose we are creating an accounting system for a business. The system will allow its users to record incomes and expenses into different accounts. Before users can start recording incomes and expenses, they should be able to add new accounts into the system. Suppose that the specification for the &ldquo;Add New Account&rdquo; use case looks like below -</p>
<blockquote>
<p>Scenario 1
Given account does not exist
When user adds a new account
Then added account has the given name
Then added account has the given initial balance
Then added account has user&rsquo;s id</p>
<p>Scenario 2
Given account does not exist
When user adds a new account with negative initial balance
Then add new account fails</p>
<p>Scenario 3
Given account with the same name exists
When user adds a new account
Then add new account fails</p>
</blockquote>
<p>In order to create a new account the user needs to enter an account name and an initial balance into the system. The system will then create the account if no account with the given name already exists and the given initial balance is positive.</p>
<p>We will first write down a test which will capture the first &ldquo;Given-When-Then&rdquo; part of the first scenario. This is how it looks like -</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">AddNewAccountTest</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nd">@Test</span>
</span></span><span class="line"><span class="cl">  <span class="nd">@DisplayName</span><span class="o">(</span><span class="s">&#34;Given account does not exist
</span></span></span><span class="line"><span class="cl"><span class="s">      When user adds a new account Then added account has the given name&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">  <span class="kt">void</span> <span class="nf">accountAddedWithGivenName</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">  <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>The <a href="https://junit.org/junit5/docs/5.0.3/api/org/junit/jupiter/api/DisplayName.html">@DisplayName</a> annotation was introduced in JUnit 5. It assigns a human-readable name to a test. This is the label that we would see when we execute this test e.g., in an IDE like IntelliJ IDEA.</p>
<p>We will now create a class which will be responsible for adding the account -</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">AddNewAccountService</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kt">void</span> <span class="nf">addNewAccount</span><span class="o">(</span><span class="n">String</span> <span class="n">accountName</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>The class defines a single method which accepts the name of an account and will be responsible for creating it i.e., saving it to a persistent data store. Since we decided to call this class AddNewAccountService, we will also rename our test to AddNewAccountServiceTest to follow the naming convention used in the JUnit world.</p>
<p>We can now proceed with writing our test -</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">AddNewAccountServiceTest</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nd">@Test</span>
</span></span><span class="line"><span class="cl">  <span class="nd">@DisplayName</span><span class="o">(</span><span class="s">&#34;Given account does not exist When user adds a new account Then added account has the given name&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">  <span class="kt">void</span> <span class="nf">accountAddedWithGivenName</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">AddNewAccountService</span> <span class="n">accountService</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AddNewAccountService</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">accountService</span><span class="o">.</span><span class="na">addNewAccount</span><span class="o">(</span><span class="s">&#34;test account&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">// What to test?
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>What should we test/verify to ensure that the scenario is properly implemented? If we read our specification again, it is clear that we want to create an &ldquo;Account&rdquo; with a user-given name, hence this is what we should try to test here. In order to do this, we will have to first create a class which will represent an Account -</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@AllArgsConstructor</span>
</span></span><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">Account</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">  <span class="kd">private</span> <span class="n">String</span> <span class="n">name</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>The Account class has only one property called name. It will have other fields like user id and balance, but we are not testing those at the moment, hence we will not add them to the class right away.</p>
<p>Now that we have created the Account class, how do we save it, and more importantly, how do we test that the account being saved has the user-given name? There are many approaches to do this, and my preferred one is to define an interface which will encapsulate this saving action. Let&rsquo;s go ahead and create it -</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">interface</span> <span class="nc">SaveAccountPort</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kt">void</span> <span class="nf">saveAccount</span><span class="o">(</span><span class="n">Account</span> <span class="n">account</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>The AddNewAccountService will be injected with an implementation of this interface via constructor injection -</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@RequiredArgsConstructor</span>
</span></span><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">AddNewAccountService</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">  <span class="kd">private</span> <span class="kd">final</span> <span class="n">SaveAccountPort</span> <span class="n">saveAccountPort</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kt">void</span> <span class="nf">addNewAccount</span><span class="o">(</span><span class="n">String</span> <span class="n">accountName</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>For testing purposes we will create a mock implementation with the help of Mockito so that we don&rsquo;t have to worry about the actual implementation details -</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@ExtendWith</span><span class="o">(</span><span class="n">MockitoExtension</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">AddNewAccountServiceTest</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nd">@Mock</span>
</span></span><span class="line"><span class="cl">  <span class="kd">private</span> <span class="n">SaveAccountPort</span> <span class="n">saveAccountPort</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nd">@Test</span>
</span></span><span class="line"><span class="cl">  <span class="nd">@DisplayName</span><span class="o">(</span><span class="s">&#34;Given account does not exist When user adds a new account Then added account has the given name&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">  <span class="kt">void</span> <span class="nf">accountAddedWithGivenName</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">AddNewAccountService</span> <span class="n">accountService</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AddNewAccountService</span><span class="o">(</span><span class="n">saveAccountPort</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">accountService</span><span class="o">.</span><span class="na">addNewAccount</span><span class="o">(</span><span class="s">&#34;test account&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">// What to test?
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>Our test setup is now complete. We now expect our method under test, the addNewAccount method of the AddNewAccountService class, to invoke the saveAccount method of the SaveAccountPort, with an Account object whose name is set to the one passed to the method. Let&rsquo;s codify this in our test -</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@ExtendWith</span><span class="o">(</span><span class="n">MockitoExtension</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">AddNewAccountServiceTest</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nd">@Mock</span>
</span></span><span class="line"><span class="cl">  <span class="kd">private</span> <span class="n">SaveAccountPort</span> <span class="n">saveAccountPort</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nd">@Captor</span>
</span></span><span class="line"><span class="cl">  <span class="kd">private</span> <span class="n">ArgumentCaptor</span><span class="o">&lt;</span><span class="n">Account</span><span class="o">&gt;</span> <span class="n">accountArgumentCaptor</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nd">@Test</span>
</span></span><span class="line"><span class="cl">  <span class="nd">@DisplayName</span><span class="o">(</span><span class="s">&#34;Given account does not exist When user adds a new account Then added account has the given name&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">  <span class="kt">void</span> <span class="nf">accountAddedWithGivenName</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">AddNewAccountService</span> <span class="n">accountService</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AddNewAccountService</span><span class="o">(</span><span class="n">saveAccountPort</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">accountService</span><span class="o">.</span><span class="na">addNewAccount</span><span class="o">(</span><span class="s">&#34;test account&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">BDDMockito</span><span class="o">.</span><span class="na">then</span><span class="o">(</span><span class="n">saveAccountPort</span><span class="o">).</span><span class="na">should</span><span class="o">().</span><span class="na">saveAccount</span><span class="o">(</span><span class="n">accountArgumentCaptor</span><span class="o">.</span><span class="na">capture</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="n">BDDAssertions</span><span class="o">.</span><span class="na">then</span><span class="o">(</span><span class="n">accountArgumentCaptor</span><span class="o">.</span><span class="na">getValue</span><span class="o">().</span><span class="na">getName</span><span class="o">()).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="s">&#34;test account&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>The line below -</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">BDDMockito</span><span class="o">.</span><span class="na">then</span><span class="o">(</span><span class="n">saveAccountPort</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="na">should</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="na">saveAccount</span><span class="o">(</span><span class="n">accountArgumentCaptor</span><span class="o">.</span><span class="na">capture</span><span class="o">());</span>
</span></span></code></pre></div><p>verifies that the saveAccount method of the SaveAccountPort is invoked once the method under test is invoked. We also capture the account argument that is passed to the saveAccount method with our argument captor. The next line -</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">BDDAssertions</span><span class="o">.</span><span class="na">then</span><span class="o">(</span><span class="n">accountArgumentCaptor</span><span class="o">.</span><span class="na">getValue</span><span class="o">().</span><span class="na">getName</span><span class="o">())</span>
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="na">isEqualTo</span><span class="o">(</span><span class="s">&#34;test account&#34;</span><span class="o">);</span>
</span></span></code></pre></div><p>then verifies that the captured account argument has the same name as the one that was passed in the test.</p>
<p>In order to make this test pass, the minimal code that is needed in our method under test is as follows -</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@RequiredArgsConstructor</span>
</span></span><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">AddNewAccountService</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">  <span class="kd">private</span> <span class="kd">final</span> <span class="n">SaveAccountPort</span> <span class="n">saveAccountPort</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kt">void</span> <span class="nf">addNewAccount</span><span class="o">(</span><span class="n">String</span> <span class="n">accountName</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">saveAccountPort</span><span class="o">.</span><span class="na">saveAccount</span><span class="o">(</span><span class="k">new</span> <span class="n">Account</span><span class="o">(</span><span class="n">accountName</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>With that, our test starts to pass!</p>
<p>Let&rsquo;s move on to the second &ldquo;Then&rdquo; part of the first scenario, which says -</p>
<blockquote>
<p>Then added account has the given initial balance
Let&rsquo;s write another test which will verify this part -</p>
</blockquote>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Test</span>
</span></span><span class="line"><span class="cl"><span class="nd">@DisplayName</span><span class="o">(</span><span class="s">&#34;Given account does not exist When user adds a new account Then added account has the given initial balance&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">accountAddedWithGivenInitialBalance</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">AddNewAccountService</span> <span class="n">accountService</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AddNewAccountService</span><span class="o">(</span><span class="n">saveAccountPort</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">accountService</span><span class="o">.</span><span class="na">addNewAccount</span><span class="o">(</span><span class="s">&#34;test account&#34;</span><span class="o">,</span> <span class="s">&#34;56.0&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  <span class="n">BDDMockito</span><span class="o">.</span><span class="na">then</span><span class="o">(</span><span class="n">saveAccountPort</span><span class="o">).</span><span class="na">should</span><span class="o">().</span><span class="na">saveAccount</span><span class="o">(</span><span class="n">accountArgumentCaptor</span><span class="o">.</span><span class="na">capture</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">  <span class="n">BDDAssertions</span><span class="o">.</span><span class="na">then</span><span class="o">(</span><span class="n">accountArgumentCaptor</span><span class="o">.</span><span class="na">getValue</span><span class="o">().</span><span class="na">getBalance</span><span class="o">())</span>
</span></span><span class="line"><span class="cl">        <span class="o">.</span><span class="na">isEqualTo</span><span class="o">(</span><span class="k">new</span> <span class="n">BigDecimal</span><span class="o">(</span><span class="s">&#34;56.0&#34;</span><span class="o">));</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>We have modified our addNewAccount method to accept the initial balance as the second argument. We have also added a new field, called balance, in our Account object which is able to store the account balance -</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@AllArgsConstructor</span>
</span></span><span class="line"><span class="cl"><span class="nd">@Getter</span>
</span></span><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">Account</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">  <span class="kd">private</span> <span class="n">String</span> <span class="n">name</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">  <span class="kd">private</span> <span class="n">BigDecimal</span> <span class="n">balance</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>Since we have changed the signature of the addNewAccount method, we will also have to modify our first test -</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Test</span>
</span></span><span class="line"><span class="cl"><span class="nd">@DisplayName</span><span class="o">(</span><span class="s">&#34;Given account does not exist When user adds a new account Then added account has the given name&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">accountAddedWithGivenName</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">AddNewAccountService</span> <span class="n">accountService</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AddNewAccountService</span><span class="o">(</span><span class="n">saveAccountPort</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">accountService</span><span class="o">.</span><span class="na">addNewAccount</span><span class="o">(</span><span class="s">&#34;test account&#34;</span><span class="o">,</span> <span class="s">&#34;1&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">BDDMockito</span><span class="o">.</span><span class="na">then</span><span class="o">(</span><span class="n">saveAccountPort</span><span class="o">).</span><span class="na">should</span><span class="o">().</span><span class="na">saveAccount</span><span class="o">(</span><span class="n">accountArgumentCaptor</span><span class="o">.</span><span class="na">capture</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">  <span class="n">BDDAssertions</span><span class="o">.</span><span class="na">then</span><span class="o">(</span><span class="n">accountArgumentCaptor</span><span class="o">.</span><span class="na">getValue</span><span class="o">().</span><span class="na">getName</span><span class="o">()).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="s">&#34;test account&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>If we run our new test now it will fail as we haven&rsquo;t implemented the functionality yet. Let&rsquo;s do that now -</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">addNewAccount</span><span class="o">(</span><span class="n">String</span> <span class="n">accountName</span><span class="o">,</span> <span class="n">String</span> <span class="n">initialBalance</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">saveAccountPort</span><span class="o">.</span><span class="na">saveAccount</span><span class="o">(</span><span class="k">new</span> <span class="n">Account</span><span class="o">(</span><span class="n">accountName</span><span class="o">,</span> <span class="k">new</span> <span class="n">BigDecimal</span><span class="o">(</span><span class="n">initialBalance</span><span class="o">)));</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>Both of our tests should pass now.</p>
<p>As we already have a couple of tests in place, it&rsquo;s time to take a look at our implementation and see if we can make it better. Since our AddNewAccountService is as simple as it can be, we don&rsquo;t have to do anything there. As for our tests, we could eliminate the duplication in our test setup code - both tests are instantiating an instance of the AddNewAccountService and invoking the addNewAccount method on it in the same way. Whether to remove or keep this duplication depends on our style of writing tests - if we want to make each test as independent as possible, then let&rsquo;s leave them as they are. If we, however, are fine with having a common test setup code, then we could change the tests as follows -</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@ExtendWith</span><span class="o">(</span><span class="n">MockitoExtension</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nd">@DisplayName</span><span class="o">(</span><span class="s">&#34;Given account does not exist When user adds a new account&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">AddNewAccountServiceTest</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">ACCOUNT_NAME</span> <span class="o">=</span> <span class="s">&#34;test account&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">  <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">INITIAL_BALANCE</span> <span class="o">=</span> <span class="s">&#34;56.0&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nd">@Mock</span>
</span></span><span class="line"><span class="cl">  <span class="kd">private</span> <span class="n">SaveAccountPort</span> <span class="n">saveAccountPort</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nd">@Captor</span>
</span></span><span class="line"><span class="cl">  <span class="kd">private</span> <span class="n">ArgumentCaptor</span><span class="o">&lt;</span><span class="n">Account</span><span class="o">&gt;</span> <span class="n">accountArgumentCaptor</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nd">@BeforeEach</span>
</span></span><span class="line"><span class="cl">  <span class="kt">void</span> <span class="nf">setup</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">AddNewAccountService</span> <span class="n">accountService</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AddNewAccountService</span><span class="o">(</span><span class="n">saveAccountPort</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">accountService</span><span class="o">.</span><span class="na">addNewAccount</span><span class="o">(</span><span class="n">ACCOUNT_NAME</span><span class="o">,</span> <span class="n">INITIAL_BALANCE</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nd">@Test</span>
</span></span><span class="line"><span class="cl">  <span class="nd">@DisplayName</span><span class="o">(</span><span class="s">&#34;Then added account has the given name&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">  <span class="kt">void</span> <span class="nf">accountAddedWithGivenName</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">BDDMockito</span><span class="o">.</span><span class="na">then</span><span class="o">(</span><span class="n">saveAccountPort</span><span class="o">).</span><span class="na">should</span><span class="o">().</span><span class="na">saveAccount</span><span class="o">(</span><span class="n">accountArgumentCaptor</span><span class="o">.</span><span class="na">capture</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="n">BDDAssertions</span><span class="o">.</span><span class="na">then</span><span class="o">(</span><span class="n">accountArgumentCaptor</span><span class="o">.</span><span class="na">getValue</span><span class="o">().</span><span class="na">getName</span><span class="o">()).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="n">ACCOUNT_NAME</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nd">@Test</span>
</span></span><span class="line"><span class="cl">  <span class="nd">@DisplayName</span><span class="o">(</span><span class="s">&#34;Then added account has the given initial balance&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">  <span class="kt">void</span> <span class="nf">accountAddedWithGivenInitialBalance</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">BDDMockito</span><span class="o">.</span><span class="na">then</span><span class="o">(</span><span class="n">saveAccountPort</span><span class="o">).</span><span class="na">should</span><span class="o">().</span><span class="na">saveAccount</span><span class="o">(</span><span class="n">accountArgumentCaptor</span><span class="o">.</span><span class="na">capture</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="n">BDDAssertions</span><span class="o">.</span><span class="na">then</span><span class="o">(</span><span class="n">accountArgumentCaptor</span><span class="o">.</span><span class="na">getValue</span><span class="o">().</span><span class="na">getBalance</span><span class="o">())</span>
</span></span><span class="line"><span class="cl">        <span class="o">.</span><span class="na">isEqualTo</span><span class="o">(</span><span class="k">new</span> <span class="n">BigDecimal</span><span class="o">(</span><span class="n">INITIAL_BALANCE</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>Notice that we have also extracted the common part of the @DisplayName and put this on top of the test class. If we are not comfortable doing this, we could also leave them as they are.</p>
<p>Since we have more than one passing tests, from now on every time we make a failing test pass we will stop for a moment, take a look at our implementation, and will try to improve it. To summarise, our implementation process will now consist of the following steps -</p>
<ol>
<li>Add a failing test while making sure existing tests keep passing</li>
<li>Make the failing test pass</li>
<li>Pause for a moment and try to improve the implementation (both the code and the tests)</li>
</ol>
<p>Moving on, we now need to store user ids with the created account. Following our method we will first write a failing test to capture this and then add the minimal amount of code needed to make the failing test pass. This is how the implementation looks like once the failing test starts to pass -</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@ExtendWith</span><span class="o">(</span><span class="n">MockitoExtension</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nd">@DisplayName</span><span class="o">(</span><span class="s">&#34;Given account does not exist When user adds a new account&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">AddNewAccountServiceTest</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">ACCOUNT_NAME</span> <span class="o">=</span> <span class="s">&#34;test account&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">  <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">INITIAL_BALANCE</span> <span class="o">=</span> <span class="s">&#34;56.0&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">  <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">USER_ID</span> <span class="o">=</span> <span class="s">&#34;some id&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">private</span> <span class="n">Account</span> <span class="n">savedAccount</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nd">@BeforeEach</span>
</span></span><span class="line"><span class="cl">  <span class="kt">void</span> <span class="nf">setup</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">AddNewAccountService</span> <span class="n">accountService</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AddNewAccountService</span><span class="o">(</span><span class="n">saveAccountPort</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">accountService</span><span class="o">.</span><span class="na">addNewAccount</span><span class="o">(</span><span class="n">ACCOUNT_NAME</span><span class="o">,</span> <span class="n">INITIAL_BALANCE</span><span class="o">,</span> <span class="n">USER_ID</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">BDDMockito</span><span class="o">.</span><span class="na">then</span><span class="o">(</span><span class="n">saveAccountPort</span><span class="o">).</span><span class="na">should</span><span class="o">().</span><span class="na">saveAccount</span><span class="o">(</span><span class="n">accountArgumentCaptor</span><span class="o">.</span><span class="na">capture</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="n">savedAccount</span> <span class="o">=</span> <span class="n">accountArgumentCaptor</span><span class="o">.</span><span class="na">getValue</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  <span class="c1">// Other tests.....
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="nd">@Test</span>
</span></span><span class="line"><span class="cl">  <span class="nd">@DisplayName</span><span class="o">(</span><span class="s">&#34;Then added account has user&#39;s id&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">  <span class="kt">void</span> <span class="nf">accountAddedWithUsersId</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">BDDAssertions</span><span class="o">.</span><span class="na">then</span><span class="o">(</span><span class="n">accountArgumentCaptor</span><span class="o">.</span><span class="na">getValue</span><span class="o">().</span><span class="na">getUserId</span><span class="o">()).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="n">USER_ID</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@RequiredArgsConstructor</span>
</span></span><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">AddNewAccountService</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">private</span> <span class="kd">final</span> <span class="n">SaveAccountPort</span> <span class="n">saveAccountPort</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kt">void</span> <span class="nf">addNewAccount</span><span class="o">(</span><span class="n">String</span> <span class="n">accountName</span><span class="o">,</span> <span class="n">String</span> <span class="n">initialBalance</span><span class="o">,</span> <span class="n">String</span> <span class="n">userId</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">saveAccountPort</span><span class="o">.</span><span class="na">saveAccount</span><span class="o">(</span><span class="k">new</span> <span class="n">Account</span><span class="o">(</span><span class="n">accountName</span><span class="o">,</span> <span class="k">new</span> <span class="n">BigDecimal</span><span class="o">(</span><span class="n">initialBalance</span><span class="o">),</span> <span class="n">userId</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@AllArgsConstructor</span>
</span></span><span class="line"><span class="cl"><span class="nd">@Getter</span>
</span></span><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">Account</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">private</span> <span class="n">String</span> <span class="n">name</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">  <span class="kd">private</span> <span class="n">BigDecimal</span> <span class="n">balance</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">  <span class="kd">private</span> <span class="n">String</span> <span class="n">userId</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>Since all the tests are now passing, it&rsquo;s improvement time! Notice that the addNewAccount method accepts three argument already. As we introduce more and more account properties its argument list will also start to increase. We could introduce a parameter object to avoid that -</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@RequiredArgsConstructor</span>
</span></span><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">AddNewAccountService</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">private</span> <span class="kd">final</span> <span class="n">SaveAccountPort</span> <span class="n">saveAccountPort</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kt">void</span> <span class="nf">addNewAccount</span><span class="o">(</span><span class="n">AddNewAccountCommand</span> <span class="n">command</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">saveAccountPort</span><span class="o">.</span><span class="na">saveAccount</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">        <span class="k">new</span> <span class="n">Account</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">command</span><span class="o">.</span><span class="na">getAccountName</span><span class="o">(),</span>
</span></span><span class="line"><span class="cl">            <span class="k">new</span> <span class="n">BigDecimal</span><span class="o">(</span><span class="n">command</span><span class="o">.</span><span class="na">getInitialBalance</span><span class="o">()),</span>
</span></span><span class="line"><span class="cl">            <span class="n">command</span><span class="o">.</span><span class="na">getUserId</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">        <span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">);</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nd">@Builder</span>
</span></span><span class="line"><span class="cl">  <span class="nd">@Getter</span>
</span></span><span class="line"><span class="cl">  <span class="kd">static</span> <span class="kd">class</span> <span class="nc">AddNewAccountCommand</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">userId</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">accountName</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">initialBalance</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@ExtendWith</span><span class="o">(</span><span class="n">MockitoExtension</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nd">@DisplayName</span><span class="o">(</span><span class="s">&#34;Given account does not exist When user adds a new account&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">AddNewAccountServiceTest</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// Fields.....
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="nd">@BeforeEach</span>
</span></span><span class="line"><span class="cl">  <span class="kt">void</span> <span class="nf">setup</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">AddNewAccountService</span> <span class="n">accountService</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AddNewAccountService</span><span class="o">(</span><span class="n">saveAccountPort</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">AddNewAccountCommand</span> <span class="n">command</span> <span class="o">=</span> <span class="n">AddNewAccountCommand</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">        <span class="o">.</span><span class="na">accountName</span><span class="o">(</span><span class="n">ACCOUNT_NAME</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">        <span class="o">.</span><span class="na">initialBalance</span><span class="o">(</span><span class="n">INITIAL_BALANCE</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">        <span class="o">.</span><span class="na">userId</span><span class="o">(</span><span class="n">USER_ID</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">        <span class="o">.</span><span class="na">build</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">accountService</span><span class="o">.</span><span class="na">addNewAccount</span><span class="o">(</span><span class="n">command</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">BDDMockito</span><span class="o">.</span><span class="na">then</span><span class="o">(</span><span class="n">saveAccountPort</span><span class="o">).</span><span class="na">should</span><span class="o">().</span><span class="na">saveAccount</span><span class="o">(</span><span class="n">accountArgumentCaptor</span><span class="o">.</span><span class="na">capture</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="n">savedAccount</span> <span class="o">=</span> <span class="n">accountArgumentCaptor</span><span class="o">.</span><span class="na">getValue</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// Remaining Tests.....
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">}</span>
</span></span></code></pre></div><p>If I now run the tests in my IDEA, this is what I see -</p>
<p></p>
<p>When we try to read the test descriptions in this view we can already get a good overview of the Add New Account use case and the way it works.</p>
<p>Right, let&rsquo;s move on the the second scenario of our use case, which is a validation rule  -</p>
<blockquote>
<p>Given account does not exist
When user adds a new account with negative initial balance
Then add new account fails</p>
</blockquote>
<p>Let&rsquo;s write a new test which tries to capture this -</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@ExtendWith</span><span class="o">(</span><span class="n">MockitoExtension</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nd">@DisplayName</span><span class="o">(</span><span class="s">&#34;Given account does not exist When user adds a new account&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">AddNewAccountServiceTest</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// Other tests
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="nd">@Test</span>
</span></span><span class="line"><span class="cl">  <span class="nd">@DisplayName</span><span class="o">(</span><span class="s">&#34;Given account does not exist When user adds a new account with negative initial balance Then add new account fails&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">  <span class="kt">void</span> <span class="nf">addNewAccountFailsWithNegativeInitialBalance</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">AddNewAccountService</span> <span class="n">accountService</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AddNewAccountService</span><span class="o">(</span><span class="n">saveAccountPort</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">AddNewAccountCommand</span> <span class="n">command</span> <span class="o">=</span> <span class="n">AddNewAccountCommand</span><span class="o">.</span><span class="na">builder</span><span class="o">().</span><span class="na">initialBalance</span><span class="o">(</span><span class="s">&#34;-56.0&#34;</span><span class="o">).</span><span class="na">build</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">accountService</span><span class="o">.</span><span class="na">addNewAccount</span><span class="o">(</span><span class="n">command</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">BDDMockito</span><span class="o">.</span><span class="na">then</span><span class="o">(</span><span class="n">saveAccountPort</span><span class="o">).</span><span class="na">shouldHaveNoInteractions</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>There are several ways we can implement validations in our service. We could throw an exception detailing the validation failures, or we could return an error object which would contain the error details. For this example we will throw exceptions if validation fails -</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Test</span>
</span></span><span class="line"><span class="cl"><span class="nd">@DisplayName</span><span class="o">(</span><span class="s">&#34;Given account does not exist When user adds a new account with negative initial balance Then add new account fails&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">addNewAccountFailsWithNegativeInitialBalance</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">AddNewAccountService</span> <span class="n">accountService</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AddNewAccountService</span><span class="o">(</span><span class="n">saveAccountPort</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">AddNewAccountCommand</span> <span class="n">command</span> <span class="o">=</span> <span class="n">AddNewAccountCommand</span><span class="o">.</span><span class="na">builder</span><span class="o">().</span><span class="na">initialBalance</span><span class="o">(</span><span class="s">&#34;-56.0&#34;</span><span class="o">).</span><span class="na">build</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">assertThatExceptionOfType</span><span class="o">(</span><span class="n">IllegalArgumentException</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">      <span class="o">.</span><span class="na">isThrownBy</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="n">accountService</span><span class="o">.</span><span class="na">addNewAccount</span><span class="o">(</span><span class="n">command</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">BDDMockito</span><span class="o">.</span><span class="na">then</span><span class="o">(</span><span class="n">saveAccountPort</span><span class="o">).</span><span class="na">shouldHaveNoInteractions</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>This test verifies that an exception is thrown when the addNewAccount method is invoked with a negative balance. It also ensures that in such cases our code does not invoke any method of the SaveAccountPort. Before we can start modifying our service to make this test pass, we have to refactor our test setup code a bit. This is because during one of our previous refactoring we moved our common test setup code into a single method which now runs before each test -</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@BeforeEach</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">setup</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">AddNewAccountService</span> <span class="n">accountService</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AddNewAccountService</span><span class="o">(</span><span class="n">saveAccountPort</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">AddNewAccountCommand</span> <span class="n">command</span> <span class="o">=</span> <span class="n">AddNewAccountCommand</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">      <span class="o">.</span><span class="na">accountName</span><span class="o">(</span><span class="n">ACCOUNT_NAME</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">      <span class="o">.</span><span class="na">initialBalance</span><span class="o">(</span><span class="n">INITIAL_BALANCE</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">      <span class="o">.</span><span class="na">userId</span><span class="o">(</span><span class="n">USER_ID</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">      <span class="o">.</span><span class="na">build</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">  <span class="n">accountService</span><span class="o">.</span><span class="na">addNewAccount</span><span class="o">(</span><span class="n">command</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">BDDMockito</span><span class="o">.</span><span class="na">then</span><span class="o">(</span><span class="n">saveAccountPort</span><span class="o">).</span><span class="na">should</span><span class="o">().</span><span class="na">saveAccount</span><span class="o">(</span><span class="n">accountArgumentCaptor</span><span class="o">.</span><span class="na">capture</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">  <span class="n">savedAccount</span> <span class="o">=</span> <span class="n">accountArgumentCaptor</span><span class="o">.</span><span class="na">getValue</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>This setup code is now in direct conflict with the new test that we&rsquo;ve just added - before each test it will always invoke the addNewAccount method with a valid command object, resulting in an invocation of the saveAccount method of the SaveAccountPort, causing our new test to fail.</p>
<p>In order to fix this, we will create a nested class within our test class where we will move our existing setup code and the passing tests -</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@ExtendWith</span><span class="o">(</span><span class="n">MockitoExtension</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nd">@DisplayName</span><span class="o">(</span><span class="s">&#34;Given account does not exist&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">AddNewAccountServiceTest</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nd">@Mock</span>
</span></span><span class="line"><span class="cl">  <span class="kd">private</span> <span class="n">SaveAccountPort</span> <span class="n">saveAccountPort</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">private</span> <span class="n">AddNewAccountService</span> <span class="n">accountService</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nd">@BeforeEach</span>
</span></span><span class="line"><span class="cl">  <span class="kt">void</span> <span class="nf">setUp</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">accountService</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AddNewAccountService</span><span class="o">(</span><span class="n">saveAccountPort</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nd">@Nested</span>
</span></span><span class="line"><span class="cl">  <span class="nd">@DisplayName</span><span class="o">(</span><span class="s">&#34;When user adds a new account&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">  <span class="kd">class</span> <span class="nc">WhenUserAddsANewAccount</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">ACCOUNT_NAME</span> <span class="o">=</span> <span class="s">&#34;test account&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">INITIAL_BALANCE</span> <span class="o">=</span> <span class="s">&#34;56.0&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">USER_ID</span> <span class="o">=</span> <span class="s">&#34;some id&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">Account</span> <span class="n">savedAccount</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Captor</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">ArgumentCaptor</span><span class="o">&lt;</span><span class="n">Account</span><span class="o">&gt;</span> <span class="n">accountArgumentCaptor</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@BeforeEach</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">setUp</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">AddNewAccountCommand</span> <span class="n">command</span> <span class="o">=</span> <span class="n">AddNewAccountCommand</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">          <span class="o">.</span><span class="na">accountName</span><span class="o">(</span><span class="n">ACCOUNT_NAME</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">          <span class="o">.</span><span class="na">initialBalance</span><span class="o">(</span><span class="n">INITIAL_BALANCE</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">          <span class="o">.</span><span class="na">userId</span><span class="o">(</span><span class="n">USER_ID</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">          <span class="o">.</span><span class="na">build</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">      <span class="n">accountService</span><span class="o">.</span><span class="na">addNewAccount</span><span class="o">(</span><span class="n">command</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">BDDMockito</span><span class="o">.</span><span class="na">then</span><span class="o">(</span><span class="n">saveAccountPort</span><span class="o">).</span><span class="na">should</span><span class="o">().</span><span class="na">saveAccount</span><span class="o">(</span><span class="n">accountArgumentCaptor</span><span class="o">.</span><span class="na">capture</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">      <span class="n">savedAccount</span> <span class="o">=</span> <span class="n">accountArgumentCaptor</span><span class="o">.</span><span class="na">getValue</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Test</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@DisplayName</span><span class="o">(</span><span class="s">&#34;Then added account has the given name&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">accountAddedWithGivenName</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">BDDAssertions</span><span class="o">.</span><span class="na">then</span><span class="o">(</span><span class="n">savedAccount</span><span class="o">.</span><span class="na">getName</span><span class="o">()).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="n">ACCOUNT_NAME</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Test</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@DisplayName</span><span class="o">(</span><span class="s">&#34;Then added account has the given initial balance&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">accountAddedWithGivenInitialBalance</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">BDDAssertions</span><span class="o">.</span><span class="na">then</span><span class="o">(</span><span class="n">savedAccount</span><span class="o">.</span><span class="na">getBalance</span><span class="o">()).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="k">new</span> <span class="n">BigDecimal</span><span class="o">(</span><span class="n">INITIAL_BALANCE</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Test</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@DisplayName</span><span class="o">(</span><span class="s">&#34;Then added account has user&#39;s id&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">accountAddedWithUsersId</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">BDDAssertions</span><span class="o">.</span><span class="na">then</span><span class="o">(</span><span class="n">accountArgumentCaptor</span><span class="o">.</span><span class="na">getValue</span><span class="o">().</span><span class="na">getUserId</span><span class="o">()).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="n">USER_ID</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  <span class="nd">@Test</span>
</span></span><span class="line"><span class="cl">  <span class="nd">@DisplayName</span><span class="o">(</span><span class="s">&#34;When user adds a new account with negative initial balance Then add new account fails&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">  <span class="kt">void</span> <span class="nf">addNewAccountFailsWithNegativeInitialBalance</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">AddNewAccountCommand</span> <span class="n">command</span> <span class="o">=</span> <span class="n">AddNewAccountCommand</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">        <span class="o">.</span><span class="na">initialBalance</span><span class="o">(</span><span class="s">&#34;-56.0&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">        <span class="o">.</span><span class="na">build</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">assertThatExceptionOfType</span><span class="o">(</span><span class="n">IllegalArgumentException</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">        <span class="o">.</span><span class="na">isThrownBy</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="n">accountService</span><span class="o">.</span><span class="na">addNewAccount</span><span class="o">(</span><span class="n">command</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">BDDMockito</span><span class="o">.</span><span class="na">then</span><span class="o">(</span><span class="n">saveAccountPort</span><span class="o">).</span><span class="na">shouldHaveNoInteractions</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>Here are the refactoring steps that we took -</p>
<ol>
<li>We created an inner class and then marked the inner class with JUnit 5&rsquo;s @Nested annotation.</li>
<li>We broke down the @DisplayName label of the outermost test class and moved the &ldquo;When user adds a new account&rdquo; part to the newly introduced inner class. The reason we did this is because this inner class will contain the group of tests that will verify/validate behaviours related to a valid account creation scenario.</li>
<li>We moved related setup code and fields/constants into this inner class.</li>
<li>We have removed the &ldquo;Given account does not exist&rdquo; part from our new test. This is because the @DisplayName on the outermost test class already includes this, hence no point including it here again.</li>
</ol>
<p>This is how the tests now look like when I run them in my IntelliJ IDEA -</p>
<p></p>
<p>As we can see from the screenshot, our test labels are also grouped and indented nicely following the structure that we created in our test code. Let&rsquo;s modify our service now to make the failing test pass -</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">addNewAccount</span><span class="o">(</span><span class="n">AddNewAccountCommand</span> <span class="n">command</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">BigDecimal</span> <span class="n">initialBalance</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BigDecimal</span><span class="o">(</span><span class="n">command</span><span class="o">.</span><span class="na">getInitialBalance</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="o">(</span><span class="n">initialBalance</span><span class="o">.</span><span class="na">compareTo</span><span class="o">(</span><span class="n">BigDecimal</span><span class="o">.</span><span class="na">ZERO</span><span class="o">)</span> <span class="o">&lt;</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalArgumentException</span><span class="o">(</span><span class="s">&#34;Initial balance of an account cannot be negative&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span>
</span></span><span class="line"><span class="cl">  <span class="n">saveAccountPort</span><span class="o">.</span><span class="na">saveAccount</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">    <span class="k">new</span> <span class="n">Account</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">      <span class="n">command</span><span class="o">.</span><span class="na">getAccountName</span><span class="o">(),</span>
</span></span><span class="line"><span class="cl">      <span class="n">initialBalance</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">      <span class="n">command</span><span class="o">.</span><span class="na">getUserId</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">    <span class="o">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>With that all of our tests start passing again. Next step is to look for ways to improve the existing implementation if possible. If not, then we will move on to the implementation of the final scenario which is also a validation rule -</p>
<blockquote>
<p>Given account with the same name exists
When user adds a new account
Then add new account fails</p>
</blockquote>
<p>As always, let&rsquo;s write a test to capture this -</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Test</span>
</span></span><span class="line"><span class="cl"><span class="nd">@DisplayName</span><span class="o">(</span><span class="s">&#34;Given account with the same name exists When user adds a new account Then add new account fails&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">addNewAccountFailsForDuplicateAccounts</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">AddNewAccountCommand</span> <span class="n">command</span> <span class="o">=</span> <span class="n">AddNewAccountCommand</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">      <span class="o">.</span><span class="na">accountName</span><span class="o">(</span><span class="s">&#34;existing name&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">      <span class="o">.</span><span class="na">build</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">  <span class="n">AddNewAccountService</span> <span class="n">accountService</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AddNewAccountService</span><span class="o">(</span><span class="n">saveAccountPort</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">assertThatExceptionOfType</span><span class="o">(</span><span class="n">IllegalArgumentException</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">      <span class="o">.</span><span class="na">isThrownBy</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="n">accountService</span><span class="o">.</span><span class="na">addNewAccount</span><span class="o">(</span><span class="n">command</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">BDDMockito</span><span class="o">.</span><span class="na">then</span><span class="o">(</span><span class="n">saveAccountPort</span><span class="o">).</span><span class="na">shouldHaveNoInteractions</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>First thing we have to figure out now is to how to find an existing account. Since this will involve querying our persistent data store, we will introduce an interface -</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">FindAccountPort</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">Account</span> <span class="nf">findAccountByName</span><span class="o">(</span><span class="n">String</span> <span class="n">accountName</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>and inject it into our AddNewAccountService -</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@RequiredArgsConstructor</span>
</span></span><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">AddNewAccountService</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">private</span> <span class="kd">final</span> <span class="n">SaveAccountPort</span> <span class="n">saveAccountPort</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">  <span class="kd">private</span> <span class="kd">final</span> <span class="n">FindAccountPort</span> <span class="n">findAccountPort</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  <span class="c1">// Rest of the code
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">}</span>
</span></span></code></pre></div><p>and modify our test -</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Test</span>
</span></span><span class="line"><span class="cl"><span class="nd">@DisplayName</span><span class="o">(</span><span class="s">&#34;Given account with the same name exists When user adds a new account Then add new account fails&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">addNewAccountFailsForDuplicateAccounts</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">String</span> <span class="n">existingAccountName</span> <span class="o">=</span> <span class="s">&#34;existing name&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">AddNewAccountCommand</span> <span class="n">command</span> <span class="o">=</span> <span class="n">AddNewAccountCommand</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">      <span class="o">.</span><span class="na">initialBalance</span><span class="o">(</span><span class="s">&#34;0&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">      <span class="o">.</span><span class="na">accountName</span><span class="o">(</span><span class="n">existingAccountName</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">      <span class="o">.</span><span class="na">build</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">  <span class="n">given</span><span class="o">(</span><span class="n">findAccountPort</span><span class="o">.</span><span class="na">findAccountByName</span><span class="o">(</span><span class="n">existingAccountName</span><span class="o">)).</span><span class="na">willReturn</span><span class="o">(</span><span class="n">mock</span><span class="o">(</span><span class="n">Account</span><span class="o">.</span><span class="na">class</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">  <span class="n">AddNewAccountService</span> <span class="n">accountService</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AddNewAccountService</span><span class="o">(</span><span class="n">saveAccountPort</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">      <span class="n">findAccountPort</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">assertThatExceptionOfType</span><span class="o">(</span><span class="n">IllegalArgumentException</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">      <span class="o">.</span><span class="na">isThrownBy</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="n">accountService</span><span class="o">.</span><span class="na">addNewAccount</span><span class="o">(</span><span class="n">command</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">BDDMockito</span><span class="o">.</span><span class="na">then</span><span class="o">(</span><span class="n">saveAccountPort</span><span class="o">).</span><span class="na">shouldHaveNoInteractions</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>The last change to our AddNewAccountService will also require changes to our existing tests, mainly the place where we were instantiating an instance of that class. We will, however, change a bit more than that -</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@ExtendWith</span><span class="o">(</span><span class="n">MockitoExtension</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">AddNewAccountServiceTest</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nd">@Mock</span>
</span></span><span class="line"><span class="cl">  <span class="kd">private</span> <span class="n">SaveAccountPort</span> <span class="n">saveAccountPort</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nd">@Mock</span>
</span></span><span class="line"><span class="cl">  <span class="kd">private</span> <span class="n">FindAccountPort</span> <span class="n">findAccountPort</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nd">@Nested</span>
</span></span><span class="line"><span class="cl">  <span class="nd">@DisplayName</span><span class="o">(</span><span class="s">&#34;Given account does not exist&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">  <span class="kd">class</span> <span class="nc">AccountDoesNotExist</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">AddNewAccountService</span> <span class="n">accountService</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@BeforeEach</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">setUp</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">accountService</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AddNewAccountService</span><span class="o">(</span><span class="n">saveAccountPort</span><span class="o">,</span> <span class="n">findAccountPort</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Nested</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@DisplayName</span><span class="o">(</span><span class="s">&#34;When user adds a new account&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">class</span> <span class="nc">WhenUserAddsANewAccount</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">      <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">ACCOUNT_NAME</span> <span class="o">=</span> <span class="s">&#34;test account&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">      <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">INITIAL_BALANCE</span> <span class="o">=</span> <span class="s">&#34;56.0&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">      <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">USER_ID</span> <span class="o">=</span> <span class="s">&#34;some id&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="kd">private</span> <span class="n">Account</span> <span class="n">savedAccount</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="nd">@Captor</span>
</span></span><span class="line"><span class="cl">      <span class="kd">private</span> <span class="n">ArgumentCaptor</span><span class="o">&lt;</span><span class="n">Account</span><span class="o">&gt;</span> <span class="n">accountArgumentCaptor</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="nd">@BeforeEach</span>
</span></span><span class="line"><span class="cl">      <span class="kt">void</span> <span class="nf">setUp</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">AddNewAccountCommand</span> <span class="n">command</span> <span class="o">=</span> <span class="n">AddNewAccountCommand</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">            <span class="o">.</span><span class="na">accountName</span><span class="o">(</span><span class="n">ACCOUNT_NAME</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">            <span class="o">.</span><span class="na">initialBalance</span><span class="o">(</span><span class="n">INITIAL_BALANCE</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">            <span class="o">.</span><span class="na">userId</span><span class="o">(</span><span class="n">USER_ID</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">            <span class="o">.</span><span class="na">build</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">accountService</span><span class="o">.</span><span class="na">addNewAccount</span><span class="o">(</span><span class="n">command</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">BDDMockito</span><span class="o">.</span><span class="na">then</span><span class="o">(</span><span class="n">saveAccountPort</span><span class="o">).</span><span class="na">should</span><span class="o">().</span><span class="na">saveAccount</span><span class="o">(</span><span class="n">accountArgumentCaptor</span><span class="o">.</span><span class="na">capture</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="n">savedAccount</span> <span class="o">=</span> <span class="n">accountArgumentCaptor</span><span class="o">.</span><span class="na">getValue</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">      <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="nd">@Test</span>
</span></span><span class="line"><span class="cl">      <span class="nd">@DisplayName</span><span class="o">(</span><span class="s">&#34;Then added account has the given name&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">      <span class="kt">void</span> <span class="nf">accountAddedWithGivenName</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">BDDAssertions</span><span class="o">.</span><span class="na">then</span><span class="o">(</span><span class="n">savedAccount</span><span class="o">.</span><span class="na">getName</span><span class="o">()).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="n">ACCOUNT_NAME</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">      <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="nd">@Test</span>
</span></span><span class="line"><span class="cl">      <span class="nd">@DisplayName</span><span class="o">(</span><span class="s">&#34;Then added account has the given initial balance&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">      <span class="kt">void</span> <span class="nf">accountAddedWithGivenInitialBalance</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">BDDAssertions</span><span class="o">.</span><span class="na">then</span><span class="o">(</span><span class="n">savedAccount</span><span class="o">.</span><span class="na">getBalance</span><span class="o">()).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="k">new</span> <span class="n">BigDecimal</span><span class="o">(</span><span class="n">INITIAL_BALANCE</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">      <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="nd">@Test</span>
</span></span><span class="line"><span class="cl">      <span class="nd">@DisplayName</span><span class="o">(</span><span class="s">&#34;Then added account has user&#39;s id&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">      <span class="kt">void</span> <span class="nf">accountAddedWithUsersId</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">BDDAssertions</span><span class="o">.</span><span class="na">then</span><span class="o">(</span><span class="n">accountArgumentCaptor</span><span class="o">.</span><span class="na">getValue</span><span class="o">().</span><span class="na">getUserId</span><span class="o">()).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="n">USER_ID</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">      <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Test</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@DisplayName</span><span class="o">(</span><span class="s">&#34;When user adds a new account with negative initial balance Then add new account fails&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">addNewAccountFailsWithNegativeInitialBalance</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">AddNewAccountCommand</span> <span class="n">command</span> <span class="o">=</span> <span class="n">AddNewAccountCommand</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">          <span class="o">.</span><span class="na">initialBalance</span><span class="o">(</span><span class="s">&#34;-56.0&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">          <span class="o">.</span><span class="na">build</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="n">assertThatExceptionOfType</span><span class="o">(</span><span class="n">IllegalArgumentException</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">          <span class="o">.</span><span class="na">isThrownBy</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="n">accountService</span><span class="o">.</span><span class="na">addNewAccount</span><span class="o">(</span><span class="n">command</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="n">BDDMockito</span><span class="o">.</span><span class="na">then</span><span class="o">(</span><span class="n">saveAccountPort</span><span class="o">).</span><span class="na">shouldHaveNoInteractions</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nd">@Test</span>
</span></span><span class="line"><span class="cl">  <span class="nd">@DisplayName</span><span class="o">(</span><span class="s">&#34;Given account with the same name exists When user adds a new account Then add new account fails&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">  <span class="kt">void</span> <span class="nf">addNewAccountFailsForDuplicateAccounts</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">String</span> <span class="n">existingAccountName</span> <span class="o">=</span> <span class="s">&#34;existing name&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">AddNewAccountCommand</span> <span class="n">command</span> <span class="o">=</span> <span class="n">AddNewAccountCommand</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">        <span class="o">.</span><span class="na">initialBalance</span><span class="o">(</span><span class="s">&#34;0&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">        <span class="o">.</span><span class="na">accountName</span><span class="o">(</span><span class="n">existingAccountName</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">        <span class="o">.</span><span class="na">build</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">given</span><span class="o">(</span><span class="n">findAccountPort</span><span class="o">.</span><span class="na">findAccountByName</span><span class="o">(</span><span class="n">existingAccountName</span><span class="o">)).</span><span class="na">willReturn</span><span class="o">(</span><span class="n">mock</span><span class="o">(</span><span class="n">Account</span><span class="o">.</span><span class="na">class</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">    <span class="n">AddNewAccountService</span> <span class="n">accountService</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AddNewAccountService</span><span class="o">(</span><span class="n">saveAccountPort</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">findAccountPort</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">assertThatExceptionOfType</span><span class="o">(</span><span class="n">IllegalArgumentException</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">        <span class="o">.</span><span class="na">isThrownBy</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="n">accountService</span><span class="o">.</span><span class="na">addNewAccount</span><span class="o">(</span><span class="n">command</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">BDDMockito</span><span class="o">.</span><span class="na">then</span><span class="o">(</span><span class="n">saveAccountPort</span><span class="o">).</span><span class="na">shouldHaveNoInteractions</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>Here&rsquo;s what we did -</p>
<blockquote>
<p>We created another inner class, marked it as @Nested, and moved our existing passing tests into this. This group of tests test the behaviour of adding a new account when no account with the given name already exists.
We have moved our test set up code into the newly introduced inner class as they are also related to the &ldquo;no account with the given name already exists&rdquo; case.
For the same reason as above, we have also moved our @DisplayName annotation from the top level test class to the newly introduced inner class.</p>
</blockquote>
<p>After our refactoring we quickly run our tests to see if everything is working as expected (failing test failing, passing tests passing), and then move on to modify our service -</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@RequiredArgsConstructor</span>
</span></span><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">AddNewAccountService</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">private</span> <span class="kd">final</span> <span class="n">SaveAccountPort</span> <span class="n">saveAccountPort</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">  <span class="kd">private</span> <span class="kd">final</span> <span class="n">FindAccountPort</span> <span class="n">findAccountPort</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kt">void</span> <span class="nf">addNewAccount</span><span class="o">(</span><span class="n">AddNewAccountCommand</span> <span class="n">command</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">BigDecimal</span> <span class="n">initialBalance</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BigDecimal</span><span class="o">(</span><span class="n">command</span><span class="o">.</span><span class="na">getInitialBalance</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">initialBalance</span><span class="o">.</span><span class="na">compareTo</span><span class="o">(</span><span class="n">BigDecimal</span><span class="o">.</span><span class="na">ZERO</span><span class="o">)</span> <span class="o">&lt;</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalArgumentException</span><span class="o">(</span><span class="s">&#34;Initial balance of an account cannot be negative&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">findAccountPort</span><span class="o">.</span><span class="na">findAccountByName</span><span class="o">(</span><span class="n">command</span><span class="o">.</span><span class="na">getAccountName</span><span class="o">())</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalArgumentException</span><span class="o">(</span><span class="s">&#34;An account with given name already exists&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">saveAccountPort</span><span class="o">.</span><span class="na">saveAccount</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">        <span class="k">new</span> <span class="n">Account</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">command</span><span class="o">.</span><span class="na">getAccountName</span><span class="o">(),</span>
</span></span><span class="line"><span class="cl">            <span class="n">initialBalance</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">command</span><span class="o">.</span><span class="na">getUserId</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">        <span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">);</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nd">@Builder</span>
</span></span><span class="line"><span class="cl">  <span class="nd">@Getter</span>
</span></span><span class="line"><span class="cl">  <span class="kd">static</span> <span class="kd">class</span> <span class="nc">AddNewAccountCommand</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">userId</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">accountName</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">initialBalance</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>All of our tests should now be green.</p>
<p>Since our use case implementation is now complete, we will look at our implementation for one last time and see if we can improve anything. If not, our use case implementation is now complete!</p>
<p>To summarise, this is what we did throughout this article -</p>
<ol>
<li>We have written down a use case that we would like to implement</li>
<li>We have added a failing test, labelling it with a human-readable name</li>
<li>We have added the minimal amount of code needed to make the failing test pass</li>
<li>As soon as we had more than one passing tests, after we made each failing test pass, we looked at our implementation and tried to improve it</li>
<li>When writing the tests we tried writing them in such a way so that our use case specifications are reflected in the test code. For this we have used -</li>
<li>The @DisplayName annotation to assign human-readable names to our tests</li>
<li>Used @Nested to group related tests in a hierarchical structure, reflecting our use case setup</li>
<li>Used BDD-driven API from Mockito and AssertJ to verify the expected behaviours</li>
</ol>
<p>When should we follow this style of writing automated tests? The answer to this question is the same as every other usage questions in Software Engineering - it depends. I personally prefer this style when I am working with an application which has complex business/domain rules, which is intended to be maintained over a long period, for which a close collaboration with the business is required, and many other factors (i.e., application architecture, team adoption etc.).</p>
<p>As always, the full working example has been pushed to <a href="https://github.com/sayembd/java-examples/tree/master/executable-specification-example">Github</a>.</p>
<p>Until next time!</p>
]]></content:encoded>
    </item>
    
    <item>
      <title>A Brief Overview of the Fork Join Framework in Java</title>
      <link>https://sayembd.github.io/posts/a-brief-overview-of-the-fork-join-framework-in-java/</link>
      <pubDate>Sun, 16 Dec 2018 22:17:05 +0200</pubDate>
      
      <guid>https://sayembd.github.io/posts/a-brief-overview-of-the-fork-join-framework-in-java/</guid>
      <description>A tutorial which demonstrates how to use Fork/Join framework in Java for both blocking and non-blocking tasks.</description>
      <content:encoded><![CDATA[<h2 id="introduction">Introduction</h2>
<p>The Fork/Join framework is a framework to solve a problem using a concurrent divide-and-conquer approach. They were introduced to complement the existing concurrency API. Before their introduction, the existing ExecutorService implementations were the popular choice to run asynchronous tasks, but they work best when the tasks are homogenous and independent. Running dependent tasks and combining their results using those implementations were not easy. With the introduction of the Fork/Join framework, an attempt was made to address this shortcoming. In this post, we will take a brief look at the API and solve a couple of simple problems to understand how they work.</p>
<h2 id="solving-a-non-blocking-task">Solving a non-blocking task</h2>
<p>Let&rsquo;s jump directly into code. Let&rsquo;s create a task which would return the sum of all elements of a List. The following steps represent our algorithm in pseudo-code:</p>
<ol>
<li>Find the middle index of the list</li>
<li>Divide the list in the middle</li>
<li>Recursively create a new task which will compute the sum of the left part</li>
<li>Recursively create a new task which will compute the sum of the right part</li>
<li>Add the result of the left sum, the middle element, and the right sum</li>
</ol>
<p>Here is the code -</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Slf4j</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ListSummer</span> <span class="kd">extends</span> <span class="n">RecursiveTask</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">  <span class="kd">private</span> <span class="kd">final</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">listToSum</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">ListSummer</span><span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">listToSum</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="o">.</span><span class="na">listToSum</span> <span class="o">=</span> <span class="n">listToSum</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">  <span class="kd">protected</span> <span class="n">Integer</span> <span class="nf">compute</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">listToSum</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&#34;Found empty list, sum is 0&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="n">0</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">middleIndex</span> <span class="o">=</span> <span class="n">listToSum</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">/</span> <span class="n">2</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&#34;List {}, middle Index: {}&#34;</span><span class="o">,</span> <span class="n">listToSum</span><span class="o">,</span> <span class="n">middleIndex</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">List</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">leftSublist</span> <span class="o">=</span> <span class="n">listToSum</span><span class="o">.</span><span class="na">subList</span><span class="o">(</span><span class="n">0</span><span class="o">,</span> <span class="n">middleIndex</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">List</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">rightSublist</span> <span class="o">=</span> <span class="n">listToSum</span><span class="o">.</span><span class="na">subList</span><span class="o">(</span><span class="n">middleIndex</span> <span class="o">+</span> <span class="n">1</span><span class="o">,</span> <span class="n">listToSum</span><span class="o">.</span><span class="na">size</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">ListSummer</span> <span class="n">leftSummer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ListSummer</span><span class="o">(</span><span class="n">leftSublist</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">ListSummer</span> <span class="n">rightSummer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ListSummer</span><span class="o">(</span><span class="n">rightSublist</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">leftSummer</span><span class="o">.</span><span class="na">fork</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">rightSummer</span><span class="o">.</span><span class="na">fork</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">Integer</span> <span class="n">leftSum</span> <span class="o">=</span> <span class="n">leftSummer</span><span class="o">.</span><span class="na">join</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">Integer</span> <span class="n">rightSum</span> <span class="o">=</span> <span class="n">rightSummer</span><span class="o">.</span><span class="na">join</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">total</span> <span class="o">=</span> <span class="n">leftSum</span> <span class="o">+</span> <span class="n">listToSum</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">middleIndex</span><span class="o">)</span> <span class="o">+</span> <span class="n">rightSum</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&#34;Left sum is {}, right sum is {}, total is {}&#34;</span><span class="o">,</span> <span class="n">leftSum</span><span class="o">,</span> <span class="n">rightSum</span><span class="o">,</span> <span class="n">total</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">total</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>Firstly, we extend the <a href="https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/util/concurrent/RecursiveTask.html">RecursiveTask</a> subtype of the <a href="https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/util/concurrent/ForkJoinTask.html">ForkJoinTask</a>. This is the type to extend from when we expect our concurrent task to return a result. When a task does not return a result but only perform an effect, we extend the <a href="https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/util/concurrent/RecursiveAction.html">RecursiveAction</a> subtype. For most of the practical tasks that we solve, these two subtypes are sufficient.</p>
<p>Secondly, both RecursiveTask and RecursiveAction define an abstract compute method. This is where we put our computation.</p>
<p>Thirdly, inside our compute method, we check the size of the list that is passed through the constructor. If it is empty, we already know the result of the sum which is zero, and we return immediately. Otherwise, we divide our lists into two sublists and create two instances of our ListSummer type. We then call the <a href="https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/util/concurrent/ForkJoinTask.html#fork()">fork()</a> method (defined in ForkJoinTask) on these two instances -</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">leftSummer</span><span class="o">.</span><span class="na">fork</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="n">rightSummer</span><span class="o">.</span><span class="na">fork</span><span class="o">();</span>
</span></span></code></pre></div><p>Which cause these tasks to be scheduled for asynchronous execution, the exact mechanism which is used for this purpose will be explained later in this post.</p>
<p>After that, we invoke the <a href="https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/util/concurrent/ForkJoinTask.html#join()">join()</a> method (also defined in ForkJoinTask) to wait for the result of these two parts -</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">Integer</span> <span class="n">leftSum</span> <span class="o">=</span> <span class="n">leftSummer</span><span class="o">.</span><span class="na">join</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="n">Integer</span> <span class="n">rightSum</span> <span class="o">=</span> <span class="n">rightSummer</span><span class="o">.</span><span class="na">join</span><span class="o">();</span>
</span></span></code></pre></div><p>Which are then summed with the middle element of the list to get the final result.</p>
<p>Plenty of log messages have been added to make the example easier to understand. However, when we process a list containing thousands of entries, it might not be a good idea to have this detailed logging, especially logging the entire list.</p>
<p>That&rsquo;s pretty much it. Let&rsquo;s create a test class now for a test run -</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ListSummerTest</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nd">@Test</span>
</span></span><span class="line"><span class="cl">  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">shouldSumEmptyList</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">ListSummer</span> <span class="n">summer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ListSummer</span><span class="o">(</span><span class="n">List</span><span class="o">.</span><span class="na">of</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="n">ForkJoinPool</span> <span class="n">forkJoinPool</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ForkJoinPool</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">forkJoinPool</span><span class="o">.</span><span class="na">submit</span><span class="o">(</span><span class="n">summer</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="n">summer</span><span class="o">.</span><span class="na">join</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">assertThat</span><span class="o">(</span><span class="n">result</span><span class="o">).</span><span class="na">isZero</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nd">@Test</span>
</span></span><span class="line"><span class="cl">  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">shouldSumListWithOneElement</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">ListSummer</span> <span class="n">summer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ListSummer</span><span class="o">(</span><span class="n">List</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">5</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">    <span class="n">ForkJoinPool</span> <span class="n">forkJoinPool</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ForkJoinPool</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">forkJoinPool</span><span class="o">.</span><span class="na">submit</span><span class="o">(</span><span class="n">summer</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="n">summer</span><span class="o">.</span><span class="na">join</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">assertThat</span><span class="o">(</span><span class="n">result</span><span class="o">).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="n">5</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nd">@Test</span>
</span></span><span class="line"><span class="cl">  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">shouldSumListWithMultipleElements</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">ListSummer</span> <span class="n">summer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ListSummer</span><span class="o">(</span><span class="n">List</span><span class="o">.</span><span class="na">of</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">1</span><span class="o">,</span> <span class="n">2</span><span class="o">,</span> <span class="n">3</span><span class="o">,</span> <span class="n">4</span><span class="o">,</span> <span class="n">5</span><span class="o">,</span> <span class="n">6</span><span class="o">,</span> <span class="n">7</span><span class="o">,</span> <span class="n">8</span><span class="o">,</span> <span class="n">9</span>
</span></span><span class="line"><span class="cl">    <span class="o">));</span>
</span></span><span class="line"><span class="cl">    <span class="n">ForkJoinPool</span> <span class="n">forkJoinPool</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ForkJoinPool</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">forkJoinPool</span><span class="o">.</span><span class="na">submit</span><span class="o">(</span><span class="n">summer</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="n">summer</span><span class="o">.</span><span class="na">join</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">assertThat</span><span class="o">(</span><span class="n">result</span><span class="o">).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="n">45</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>In the test, we create an instance of the <a href="https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/util/concurrent/ForkJoinPool.html">ForkJoinPool</a>. A ForkJoinPool is a unique ExecutorService implementation for running ForkJoinTasks. It employs a special algorithm known as the work-stealing algorithm. Contrary to the other ExecutorService implementations where there is only a single queue holding all the tasks to be executed, in a work-stealing implementation, each worker thread gets its work queue. Each thread starts executing tasks from their queue. When we detect that a ForkJoinTask can be broken down into multiple smaller subtasks, we do break them into smaller tasks, and then we invoke the fork() method on those tasks. This invocation causes the subtasks to be pushed into the executing thread&rsquo;s queue. During the execution, when one thread exhausts its queue/has no tasks to execute, it can &ldquo;steal&rdquo; tasks from other thread&rsquo;s queue (hence the name &ldquo;work-stealing&rdquo;). This stealing behaviour is what results in a better throughput than using any other ExecutorService implementations.</p>
<p>Earlier, when we invoked fork() on our leftSummer and rightSummer task instances, they got pushed into the work queue of the executing thread, after which they were &ldquo;stolen&rdquo; by other active threads in the pool (and so on) since they did not have anything else to do at that point.</p>
<p>Pretty cool, right?</p>
<h2 id="solving-a-blocking-task">Solving a blocking task</h2>
<p>The problem we solved just now is non-blocking in nature. If we want to solve a problem which does some blocking operation, then to have a better throughput we will need to change our strategy.</p>
<p>Let&rsquo;s examine this with another example. Let&rsquo;s say we want to create a very simple web crawler. This crawler will receive a list of HTTP links, execute GET requests to fetch the response bodies, and then calculate the response length. Here is the code -</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Slf4j</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ResponseLengthCalculator</span> <span class="kd">extends</span> <span class="n">RecursiveTask</span><span class="o">&lt;</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">  <span class="kd">private</span> <span class="kd">final</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">links</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">ResponseLengthCalculator</span><span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">links</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="o">.</span><span class="na">links</span> <span class="o">=</span> <span class="n">links</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">  <span class="kd">protected</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;</span> <span class="nf">compute</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">links</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&#34;No more links to fetch&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="n">Collections</span><span class="o">.</span><span class="na">emptyMap</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">middle</span> <span class="o">=</span> <span class="n">links</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">/</span> <span class="n">2</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&#34;Middle index: {}&#34;</span><span class="o">,</span> <span class="n">links</span><span class="o">,</span> <span class="n">middle</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">ResponseLengthCalculator</span> <span class="n">leftPartition</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ResponseLengthCalculator</span><span class="o">(</span><span class="n">links</span><span class="o">.</span><span class="na">subList</span><span class="o">(</span><span class="n">0</span><span class="o">,</span> <span class="n">middle</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">    <span class="n">ResponseLengthCalculator</span> <span class="n">rightPartition</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ResponseLengthCalculator</span><span class="o">(</span><span class="n">links</span><span class="o">.</span><span class="na">subList</span><span class="o">(</span><span class="n">middle</span> <span class="o">+</span> <span class="n">1</span><span class="o">,</span> <span class="n">links</span><span class="o">.</span><span class="na">size</span><span class="o">()));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&#34;Forking left partition&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">leftPartition</span><span class="o">.</span><span class="na">fork</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&#34;Left partition forked, now forking right partition&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">rightPartition</span><span class="o">.</span><span class="na">fork</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&#34;Right partition forked&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">String</span> <span class="n">middleLink</span> <span class="o">=</span> <span class="n">links</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">middle</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">HttpRequester</span> <span class="n">httpRequester</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HttpRequester</span><span class="o">(</span><span class="n">middleLink</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">String</span> <span class="n">response</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&#34;Calling managedBlock for {}&#34;</span><span class="o">,</span> <span class="n">middleLink</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">ForkJoinPool</span><span class="o">.</span><span class="na">managedBlock</span><span class="o">(</span><span class="n">httpRequester</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">response</span> <span class="o">=</span> <span class="n">httpRequester</span><span class="o">.</span><span class="na">response</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">&#34;Error occurred while trying to implement blocking link fetcher&#34;</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">response</span> <span class="o">=</span> <span class="s">&#34;&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;</span> <span class="n">responseMap</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;&gt;(</span><span class="n">links</span><span class="o">.</span><span class="na">size</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;</span> <span class="n">leftLinks</span> <span class="o">=</span> <span class="n">leftPartition</span><span class="o">.</span><span class="na">join</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">responseMap</span><span class="o">.</span><span class="na">putAll</span><span class="o">(</span><span class="n">leftLinks</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">responseMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">middleLink</span><span class="o">,</span> <span class="n">response</span><span class="o">.</span><span class="na">length</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;</span> <span class="n">rightLinks</span> <span class="o">=</span> <span class="n">rightPartition</span><span class="o">.</span><span class="na">join</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">responseMap</span><span class="o">.</span><span class="na">putAll</span><span class="o">(</span><span class="n">rightLinks</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&#34;Left map {}, middle length {}, right map {}&#34;</span><span class="o">,</span> <span class="n">leftLinks</span><span class="o">,</span> <span class="n">response</span><span class="o">.</span><span class="na">length</span><span class="o">(),</span> <span class="n">rightLinks</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">responseMap</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">private</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">HttpRequester</span> <span class="kd">implements</span> <span class="n">ForkJoinPool</span><span class="o">.</span><span class="na">ManagedBlocker</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">link</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">String</span> <span class="n">response</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="nf">HttpRequester</span><span class="o">(</span><span class="n">String</span> <span class="n">link</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">this</span><span class="o">.</span><span class="na">link</span> <span class="o">=</span> <span class="n">link</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">block</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">HttpGet</span> <span class="n">headRequest</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HttpGet</span><span class="o">(</span><span class="n">link</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">CloseableHttpClient</span> <span class="n">client</span> <span class="o">=</span> <span class="n">HttpClientBuilder</span>
</span></span><span class="line"><span class="cl">          <span class="o">.</span><span class="na">create</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">          <span class="o">.</span><span class="na">disableRedirectHandling</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">          <span class="o">.</span><span class="na">build</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">      
</span></span><span class="line"><span class="cl">      <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&#34;Executing blocking request for {}&#34;</span><span class="o">,</span> <span class="n">link</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">      
</span></span><span class="line"><span class="cl">      <span class="k">try</span> <span class="o">(</span><span class="n">client</span><span class="o">;</span> <span class="n">CloseableHttpResponse</span> <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="n">headRequest</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&#34;HTTP request for link {} has been executed&#34;</span><span class="o">,</span> <span class="n">link</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">response</span> <span class="o">=</span> <span class="n">EntityUtils</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">response</span><span class="o">.</span><span class="na">getEntity</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">      <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">&#34;Error while trying to fetch response from link {}: {}&#34;</span><span class="o">,</span> <span class="n">link</span><span class="o">,</span> <span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">response</span> <span class="o">=</span> <span class="s">&#34;&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">      <span class="o">}</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isReleasable</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>We create an implementation of the <a href="https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/util/concurrent/ForkJoinPool.ManagedBlocker.html">ForkJoinPool.ManagedBlocker</a> where we put the blocking HTTP call. This interface defines two methods - block() and isReleasable(). The block() method is where we put our blocking call. After we are done with our blocking operation, we return true indicating that no further blocking is necessary. We return false from the isReleasable() implementation to indicate to a fork-join worker thread that the block() method implementation is potentially blocking in nature. The isReleasable() implementation will be invoked by a fork-join worker thread first before it invokes the block() method. Finally, we submit our  HttpRequester instance to our pool by invoking ForkJoinPool.managedBlock() static method. After that our blocking task will start executing. When it blocks on the HTTP request, the <a href="https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/util/concurrent/ForkJoinPool.html#managedBlock(java.util.concurrent.ForkJoinPool.ManagedBlocker)">ForkJoinPool.managedBlock()</a> method will also arrange for a spare thread to be activated if necessary to ensure sufficient parallelism.</p>
<p>Let&rsquo;s take this implementation for a test drive then! Here&rsquo;s the code -</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ResponseLengthCalculatorTest</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nd">@Test</span>
</span></span><span class="line"><span class="cl">  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">shouldReturnEmptyMapForEmptyList</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">ResponseLengthCalculator</span> <span class="n">responseLengthCalculator</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ResponseLengthCalculator</span><span class="o">(</span><span class="n">Collections</span><span class="o">.</span><span class="na">emptyList</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="n">ForkJoinPool</span> <span class="n">pool</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ForkJoinPool</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">pool</span><span class="o">.</span><span class="na">submit</span><span class="o">(</span><span class="n">responseLengthCalculator</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;</span> <span class="n">result</span> <span class="o">=</span> <span class="n">responseLengthCalculator</span><span class="o">.</span><span class="na">join</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">assertThat</span><span class="o">(</span><span class="n">result</span><span class="o">).</span><span class="na">isEmpty</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nd">@Test</span>
</span></span><span class="line"><span class="cl">  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">shouldHandle200Ok</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">ResponseLengthCalculator</span> <span class="n">responseLengthCalculator</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ResponseLengthCalculator</span><span class="o">(</span><span class="n">List</span><span class="o">.</span><span class="na">of</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">        <span class="s">&#34;http://httpstat.us/200&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="o">));</span>
</span></span><span class="line"><span class="cl">    <span class="n">ForkJoinPool</span> <span class="n">pool</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ForkJoinPool</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">pool</span><span class="o">.</span><span class="na">submit</span><span class="o">(</span><span class="n">responseLengthCalculator</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;</span> <span class="n">result</span> <span class="o">=</span> <span class="n">responseLengthCalculator</span><span class="o">.</span><span class="na">join</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">assertThat</span><span class="o">(</span><span class="n">result</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">        <span class="o">.</span><span class="na">hasSize</span><span class="o">(</span><span class="n">1</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">        <span class="o">.</span><span class="na">containsKeys</span><span class="o">(</span><span class="s">&#34;http://httpstat.us/200&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">        <span class="o">.</span><span class="na">containsValue</span><span class="o">(</span><span class="n">0</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nd">@Test</span>
</span></span><span class="line"><span class="cl">  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">shouldFetchResponseForDifferentResponseStatus</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">ResponseLengthCalculator</span> <span class="n">responseLengthCalculator</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ResponseLengthCalculator</span><span class="o">(</span><span class="n">List</span><span class="o">.</span><span class="na">of</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">        <span class="s">&#34;http://httpstat.us/200&#34;</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">        <span class="s">&#34;http://httpstat.us/302&#34;</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">        <span class="s">&#34;http://httpstat.us/404&#34;</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">        <span class="s">&#34;http://httpstat.us/502&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="o">));</span>
</span></span><span class="line"><span class="cl">    <span class="n">ForkJoinPool</span> <span class="n">pool</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ForkJoinPool</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">pool</span><span class="o">.</span><span class="na">submit</span><span class="o">(</span><span class="n">responseLengthCalculator</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;</span> <span class="n">result</span> <span class="o">=</span> <span class="n">responseLengthCalculator</span><span class="o">.</span><span class="na">join</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">assertThat</span><span class="o">(</span><span class="n">result</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">        <span class="o">.</span><span class="na">hasSize</span><span class="o">(</span><span class="n">4</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>That&rsquo;s it for today, folks! As always, any feedback/improvement suggestions/comments are highly appreciated!</p>
<p>All the examples discussed here can be found on <a href="https://github.com/sayembd/java-examples">Github</a>.</p>
<p>A big shout out to the awesome <a href="http://httpstat.us">http://httpstat.us</a> service, it was quite helpful for developing the simple tests.</p>
]]></content:encoded>
    </item>
    
    <item>
      <title>Java Tips: Creating a Monitoring-friendly ExecutorService</title>
      <link>https://sayembd.github.io/posts/java-tips-creating-a-monitoring-friendly-executorservice/</link>
      <pubDate>Tue, 01 May 2018 03:15:21 +0200</pubDate>
      
      <guid>https://sayembd.github.io/posts/java-tips-creating-a-monitoring-friendly-executorservice/</guid>
      <description>A custom ExecutorService implementation in Java, augmented with monitoring capabilities.</description>
      <content:encoded><![CDATA[<p>In this article we will be extending an <a href="https://docs.oracle.com/javase/10/docs/api/java/util/concurrent/ExecutorService.html">ExecutorService</a> implementation with monitoring capabilities. This monitoring capability will help us to measure a number of pool parameters i.e., active threads, work queue size etc. in a live production environment. It will also enable us to measure task execution time, successful tasks count, and failed tasks count.</p>
<h2 id="monitoring-library">Monitoring Library</h2>
<p>As for the monitoring library we will be using <a href="http://metrics.dropwizard.io/">Metrics</a>. For the sake of simplicity we will be using a <a href="http://metrics.dropwizard.io/4.0.0/apidocs/com/codahale/metrics/ConsoleReporter.html">ConsoleReporter</a> which will report our metrics to the console. For production-grade applications, we should use an advanced reporter (i.e., Graphite reporter). If you are unfamiliar with Metrics, then I recommend you to go through the <a href="http://metrics.dropwizard.io/4.0.0/getting-started.html">getting started guide</a>.</p>
<p>Let&rsquo;s get started.</p>
<h2 id="extending-the-threadpoolexecutor">Extending the ThreadPoolExecutor</h2>
<p>We will be using <a href="https://docs.oracle.com/javase/10/docs/api/java/util/concurrent/ThreadPoolExecutor.html">ThreadPoolExecutor</a> as the base class for our new type. Let&rsquo;s call it <em>MonitoredThreadPoolExecutor</em>. This class will accept a <a href="http://metrics.dropwizard.io/4.0.0/apidocs/com/codahale/metrics/MetricRegistry.html">MetricRegistry</a> as one of its constructor parameters -</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MonitoredThreadPoolExecutor</span> <span class="kd">extends</span> <span class="n">ThreadPoolExecutor</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">  <span class="kd">private</span> <span class="kd">final</span> <span class="n">MetricRegistry</span> <span class="n">metricRegistry</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">public</span> <span class="nf">MonitoredThreadPoolExecutor</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">      <span class="kt">int</span> <span class="n">corePoolSize</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">      <span class="kt">int</span> <span class="n">maximumPoolSize</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">      <span class="kt">long</span> <span class="n">keepAliveTime</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">      <span class="n">TimeUnit</span> <span class="n">unit</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">      <span class="n">BlockingQueue</span><span class="o">&lt;</span><span class="n">Runnable</span><span class="o">&gt;</span> <span class="n">workQueue</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">      <span class="n">MetricRegistry</span> <span class="n">metricRegistry</span>
</span></span><span class="line"><span class="cl">  <span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">super</span><span class="o">(</span><span class="n">corePoolSize</span><span class="o">,</span> <span class="n">maximumPoolSize</span><span class="o">,</span> <span class="n">keepAliveTime</span><span class="o">,</span> <span class="n">unit</span><span class="o">,</span> <span class="n">workQueue</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="o">.</span><span class="na">metricRegistry</span> <span class="o">=</span> <span class="n">metricRegistry</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">public</span> <span class="nf">MonitoredThreadPoolExecutor</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">      <span class="kt">int</span> <span class="n">corePoolSize</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">      <span class="kt">int</span> <span class="n">maximumPoolSize</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">      <span class="kt">long</span> <span class="n">keepAliveTime</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">      <span class="n">TimeUnit</span> <span class="n">unit</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">      <span class="n">BlockingQueue</span><span class="o">&lt;</span><span class="n">Runnable</span><span class="o">&gt;</span> <span class="n">workQueue</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">      <span class="n">ThreadFactory</span> <span class="n">threadFactory</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">      <span class="n">MetricRegistry</span> <span class="n">metricRegistry</span>
</span></span><span class="line"><span class="cl">  <span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">super</span><span class="o">(</span><span class="n">corePoolSize</span><span class="o">,</span> <span class="n">maximumPoolSize</span><span class="o">,</span> <span class="n">keepAliveTime</span><span class="o">,</span> <span class="n">unit</span><span class="o">,</span> <span class="n">workQueue</span><span class="o">,</span> <span class="n">threadFactory</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="o">.</span><span class="na">metricRegistry</span> <span class="o">=</span> <span class="n">metricRegistry</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">public</span> <span class="nf">MonitoredThreadPoolExecutor</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">      <span class="kt">int</span> <span class="n">corePoolSize</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">      <span class="kt">int</span> <span class="n">maximumPoolSize</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">      <span class="kt">long</span> <span class="n">keepAliveTime</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">      <span class="n">TimeUnit</span> <span class="n">unit</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">      <span class="n">BlockingQueue</span><span class="o">&lt;</span><span class="n">Runnable</span><span class="o">&gt;</span> <span class="n">workQueue</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">      <span class="n">RejectedExecutionHandler</span> <span class="n">handler</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">      <span class="n">MetricRegistry</span> <span class="n">metricRegistry</span>
</span></span><span class="line"><span class="cl">  <span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">super</span><span class="o">(</span><span class="n">corePoolSize</span><span class="o">,</span> <span class="n">maximumPoolSize</span><span class="o">,</span> <span class="n">keepAliveTime</span><span class="o">,</span> <span class="n">unit</span><span class="o">,</span> <span class="n">workQueue</span><span class="o">,</span> <span class="n">handler</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="o">.</span><span class="na">metricRegistry</span> <span class="o">=</span> <span class="n">metricRegistry</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">public</span> <span class="nf">MonitoredThreadPoolExecutor</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">      <span class="kt">int</span> <span class="n">corePoolSize</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">      <span class="kt">int</span> <span class="n">maximumPoolSize</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">      <span class="kt">long</span> <span class="n">keepAliveTime</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">      <span class="n">TimeUnit</span> <span class="n">unit</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">      <span class="n">BlockingQueue</span><span class="o">&lt;</span><span class="n">Runnable</span><span class="o">&gt;</span> <span class="n">workQueue</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">      <span class="n">ThreadFactory</span> <span class="n">threadFactory</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">      <span class="n">RejectedExecutionHandler</span> <span class="n">handler</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">      <span class="n">MetricRegistry</span> <span class="n">metricRegistry</span>
</span></span><span class="line"><span class="cl">  <span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">super</span><span class="o">(</span><span class="n">corePoolSize</span><span class="o">,</span> <span class="n">maximumPoolSize</span><span class="o">,</span> <span class="n">keepAliveTime</span><span class="o">,</span> <span class="n">unit</span><span class="o">,</span> <span class="n">workQueue</span><span class="o">,</span> <span class="n">threadFactory</span><span class="o">,</span> <span class="n">handler</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="o">.</span><span class="na">metricRegistry</span> <span class="o">=</span> <span class="n">metricRegistry</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><h2 id="registering-gauges-to-measure-pool-specific-paramters">Registering Gauges to measure pool-specific paramters</h2>
<p>A <a href="http://metrics.dropwizard.io/4.0.0/getting-started.html#gauges">Gauge</a> is an instantaneous measurement of a value. We will be using it to measure different pool parameters like number of active threads, task queue size etc.</p>
<p>Before we can register a Gauge, we need to decide how to calculate a metric name for our thread pool. Each metric, whether it&rsquo;s a Gauge, or a Timer, or simply a Meter, has a unique name. This name is used to identify the metric source. The convention here is to use a dotted string which is often constructed from the fully qualified name of the class being monitored.</p>
<p>For our thread pool, we will be using its fully qualified name as a prefix to our metrics names. Additionally we will add another constructor parameter called <em>poolName,</em> which will be used by the clients to specify instance-specific identifiers.</p>
<p>After implementing these changes the class looks like below -</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MonitoredThreadPoolExecutor</span> <span class="kd">extends</span> <span class="n">ThreadPoolExecutor</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">  <span class="kd">private</span> <span class="kd">final</span> <span class="n">MetricRegistry</span> <span class="n">metricRegistry</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">  <span class="kd">private</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">metricsPrefix</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">public</span> <span class="nf">MonitoredThreadPoolExecutor</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">      <span class="kt">int</span> <span class="n">corePoolSize</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">      <span class="kt">int</span> <span class="n">maximumPoolSize</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">      <span class="kt">long</span> <span class="n">keepAliveTime</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">      <span class="n">TimeUnit</span> <span class="n">unit</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">      <span class="n">BlockingQueue</span><span class="o">&lt;</span><span class="n">Runnable</span><span class="o">&gt;</span> <span class="n">workQueue</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">      <span class="n">MetricRegistry</span> <span class="n">metricRegistry</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">      <span class="n">String</span> <span class="n">poolName</span>
</span></span><span class="line"><span class="cl">  <span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">super</span><span class="o">(</span><span class="n">corePoolSize</span><span class="o">,</span> <span class="n">maximumPoolSize</span><span class="o">,</span> <span class="n">keepAliveTime</span><span class="o">,</span> <span class="n">unit</span><span class="o">,</span> <span class="n">workQueue</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="o">.</span><span class="na">metricRegistry</span> <span class="o">=</span> <span class="n">metricRegistry</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="o">.</span><span class="na">metricsPrefix</span> <span class="o">=</span> <span class="n">MetricRegistry</span><span class="o">.</span><span class="na">name</span><span class="o">(</span><span class="n">getClass</span><span class="o">(),</span> <span class="n">poolName</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// Rest of the constructors
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">}</span>
</span></span></code></pre></div><p>Now we are ready to register our Gauges. For this purpose we will define a private method -</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span> <span class="kt">void</span> <span class="nf">registerGauges</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">metricRegistry</span><span class="o">.</span><span class="na">register</span><span class="o">(</span><span class="n">MetricRegistry</span><span class="o">.</span><span class="na">name</span><span class="o">(</span><span class="n">metricsPrefix</span><span class="o">,</span> <span class="s">&#34;corePoolSize&#34;</span><span class="o">),</span> <span class="o">(</span><span class="n">Gauge</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;)</span> <span class="k">this</span><span class="o">::</span><span class="n">getCorePoolSize</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">metricRegistry</span><span class="o">.</span><span class="na">register</span><span class="o">(</span><span class="n">MetricRegistry</span><span class="o">.</span><span class="na">name</span><span class="o">(</span><span class="n">metricsPrefix</span><span class="o">,</span> <span class="s">&#34;activeThreads&#34;</span><span class="o">),</span> <span class="o">(</span><span class="n">Gauge</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;)</span> <span class="k">this</span><span class="o">::</span><span class="n">getActiveCount</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">metricRegistry</span><span class="o">.</span><span class="na">register</span><span class="o">(</span><span class="n">MetricRegistry</span><span class="o">.</span><span class="na">name</span><span class="o">(</span><span class="n">metricsPrefix</span><span class="o">,</span> <span class="s">&#34;maxPoolSize&#34;</span><span class="o">),</span> <span class="o">(</span><span class="n">Gauge</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;)</span> <span class="k">this</span><span class="o">::</span><span class="n">getMaximumPoolSize</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">metricRegistry</span><span class="o">.</span><span class="na">register</span><span class="o">(</span><span class="n">MetricRegistry</span><span class="o">.</span><span class="na">name</span><span class="o">(</span><span class="n">metricsPrefix</span><span class="o">,</span> <span class="s">&#34;queueSize&#34;</span><span class="o">),</span> <span class="o">(</span><span class="n">Gauge</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;)</span> <span class="o">()</span> <span class="o">-&gt;</span> <span class="n">getQueue</span><span class="o">().</span><span class="na">size</span><span class="o">());</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>For our example we are measuring core pool size, number of active threads, maximum pool size, and task queue size. Depending on monitoring requirements we can register more/less Gauges to measure different properties.</p>
<p>This private method will now be invoked from all constructors -</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="nf">MonitoredThreadPoolExecutor</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">corePoolSize</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">maximumPoolSize</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">    <span class="kt">long</span> <span class="n">keepAliveTime</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">TimeUnit</span> <span class="n">unit</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">BlockingQueue</span><span class="o">&lt;</span><span class="n">Runnable</span><span class="o">&gt;</span> <span class="n">workQueue</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">MetricRegistry</span> <span class="n">metricRegistry</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">String</span> <span class="n">poolName</span>
</span></span><span class="line"><span class="cl"><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">  <span class="kd">super</span><span class="o">(</span><span class="n">corePoolSize</span><span class="o">,</span> <span class="n">maximumPoolSize</span><span class="o">,</span> <span class="n">keepAliveTime</span><span class="o">,</span> <span class="n">unit</span><span class="o">,</span> <span class="n">workQueue</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">this</span><span class="o">.</span><span class="na">metricRegistry</span> <span class="o">=</span> <span class="n">metricRegistry</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">this</span><span class="o">.</span><span class="na">metricsPrefix</span> <span class="o">=</span> <span class="n">MetricRegistry</span><span class="o">.</span><span class="na">name</span><span class="o">(</span><span class="n">getClass</span><span class="o">(),</span> <span class="n">poolName</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">registerGauges</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><h2 id="measuring-task-execution-time">Measuring Task Execution Time</h2>
<p>To measure the task execution time, we will override two life-cycle methods that <em>ThreadPoolExecutor</em> provides - <em>beforeExecute</em> and <em>afterExecute</em>.</p>
<p>As the name implies, <em>beforeExecute</em> callback is invoked prior to executing a task, by the thread that will execute the task. The default implementation of this callback does nothing.</p>
<p>Similarly, the <em>afterExecute</em> callback is invoked after each task is executed, by the thread that executed the task. The default implementation of this callback also does nothing. Even if the task throws an uncaught <em>RuntimeException</em> or <em>Error</em>, this callback will be invoked.</p>
<p>We will be starting a <a href="http://metrics.dropwizard.io/4.0.0/getting-started.html#timers">Timer</a> in our <em>beforeExecute</em> override, which will then be used in our <em>afterExecute</em> override to get the total task execution time. To store a reference to the <em>Timer</em> we will introduce a new <em>ThreadLocal</em> field in our class.</p>
<p>The implementation of the callbacks are given below -</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MonitoredThreadPoolExecutor</span> <span class="kd">extends</span> <span class="n">ThreadPoolExecutor</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">  <span class="kd">private</span> <span class="kd">final</span> <span class="n">MetricRegistry</span> <span class="n">metricRegistry</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">  <span class="kd">private</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">metricsPrefix</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">  <span class="kd">private</span> <span class="n">ThreadLocal</span><span class="o">&lt;</span><span class="n">Timer</span><span class="o">.</span><span class="na">Context</span><span class="o">&gt;</span> <span class="n">taskExecutionTimer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ThreadLocal</span><span class="o">&lt;&gt;();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// Constructors
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">  <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">beforeExecute</span><span class="o">(</span><span class="n">Thread</span> <span class="n">thread</span><span class="o">,</span> <span class="n">Runnable</span> <span class="n">task</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">super</span><span class="o">.</span><span class="na">beforeExecute</span><span class="o">(</span><span class="n">thread</span><span class="o">,</span> <span class="n">task</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">Timer</span> <span class="n">timer</span> <span class="o">=</span> <span class="n">metricRegistry</span><span class="o">.</span><span class="na">timer</span><span class="o">(</span><span class="n">MetricRegistry</span><span class="o">.</span><span class="na">name</span><span class="o">(</span><span class="n">metricsPrefix</span><span class="o">,</span> <span class="s">&#34;task-execution&#34;</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">    <span class="n">taskExecutionTimer</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">timer</span><span class="o">.</span><span class="na">time</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">  <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">afterExecute</span><span class="o">(</span><span class="n">Runnable</span> <span class="n">task</span><span class="o">,</span> <span class="n">Throwable</span> <span class="n">throwable</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Timer</span><span class="o">.</span><span class="na">Context</span> <span class="n">context</span> <span class="o">=</span> <span class="n">taskExecutionTimer</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">context</span><span class="o">.</span><span class="na">stop</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="kd">super</span><span class="o">.</span><span class="na">afterExecute</span><span class="o">(</span><span class="n">task</span><span class="o">,</span> <span class="n">throwable</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><h3 id="recording-number-of-failed-tasks-due-to-uncaught-exceptions">Recording number of failed tasks due to uncaught exceptions</h3>
<p>The second parameter to the <em>afterExecute</em> callback is a <em>Throwable</em>. If non-null, this <em>Throwable</em> refers to the uncaught <em>RuntimeException</em> or <em>Error</em> that caused the execution to terminate. We can use this information to partially count the total number of tasks that were terminated abruptly due to uncaught exceptions.</p>
<p>To get the total number of failed tasks, we must consider another case. Tasks submitted using the <em>execute</em> method will throw any uncaught exceptions, and it will be available as the second argument to the <em>afterExecute</em> callback. However, tasks submitted using the <em>submit</em> method are swallowed by the executor service. This is clearly explained in the <a href="https://docs.oracle.com/javase/10/docs/api/java/util/concurrent/ThreadPoolExecutor.html#afterExecute(java.lang.Runnable,java.lang.Throwable)">JavaDoc</a> (emphasis mine) -</p>
<blockquote>
<p>Note: When actions are enclosed in tasks (such as FutureTask) either explicitly or via methods such as submit, these task objects catch and maintain computational exceptions, and so they do not cause abrupt termination, and <strong>the internal exceptions are not passed to this method</strong>. If you would like to trap both kinds of failures in this method, you can further probe for such cases, as in this sample subclass that prints either the direct cause or the underlying exception if a task has been aborted</p>
</blockquote>
<p>Fortunately, the same doc also offers a solution for this, which is to examine the runnable to see if it&rsquo;s a <em>Future</em>, and then get the underlying exception.</p>
<p>Combining these approaches, we can modify our <em>afterExecute</em> method as follows -</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Override</span>
</span></span><span class="line"><span class="cl"><span class="kd">protected</span> <span class="kt">void</span> <span class="nf">afterExecute</span><span class="o">(</span><span class="n">Runnable</span> <span class="n">runnable</span><span class="o">,</span> <span class="n">Throwable</span> <span class="n">throwable</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">Timer</span><span class="o">.</span><span class="na">Context</span> <span class="n">context</span> <span class="o">=</span> <span class="n">taskExecutionTimer</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">  <span class="n">context</span><span class="o">.</span><span class="na">stop</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">super</span><span class="o">.</span><span class="na">afterExecute</span><span class="o">(</span><span class="n">runnable</span><span class="o">,</span> <span class="n">throwable</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="o">(</span><span class="n">throwable</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">runnable</span> <span class="k">instanceof</span> <span class="n">Future</span> <span class="o">&amp;&amp;</span> <span class="o">((</span><span class="n">Future</span><span class="o">)</span> <span class="n">runnable</span><span class="o">).</span><span class="na">isDone</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">      <span class="o">((</span><span class="n">Future</span><span class="o">)</span> <span class="n">runnable</span><span class="o">).</span><span class="na">get</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">CancellationException</span> <span class="n">ce</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">throwable</span> <span class="o">=</span> <span class="n">ce</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">ExecutionException</span> <span class="n">ee</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">throwable</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="na">getCause</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">ie</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">interrupt</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="o">(</span><span class="n">throwable</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Counter</span> <span class="n">failedTasksCounter</span> <span class="o">=</span> <span class="n">metricRegistry</span><span class="o">.</span><span class="na">counter</span><span class="o">(</span><span class="n">MetricRegistry</span><span class="o">.</span><span class="na">name</span><span class="o">(</span><span class="n">metricsPrefix</span><span class="o">,</span> <span class="s">&#34;failed-tasks&#34;</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">    <span class="n">failedTasksCounter</span><span class="o">.</span><span class="na">inc</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><h2 id="counting-total-number-of-successful-tasks">Counting total number of successful tasks</h2>
<p>The previous approach can also be used to count the total number of successful tasks: tasks that were completed without throwing any exceptions or errors -</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Override</span>
</span></span><span class="line"><span class="cl"><span class="kd">protected</span> <span class="kt">void</span> <span class="nf">afterExecute</span><span class="o">(</span><span class="n">Runnable</span> <span class="n">runnable</span><span class="o">,</span> <span class="n">Throwable</span> <span class="n">throwable</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// Rest of the method body .....
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="o">(</span><span class="n">throwable</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Counter</span> <span class="n">failedTasksCounter</span> <span class="o">=</span> <span class="n">metricRegistry</span><span class="o">.</span><span class="na">counter</span><span class="o">(</span><span class="n">MetricRegistry</span><span class="o">.</span><span class="na">name</span><span class="o">(</span><span class="n">metricsPrefix</span><span class="o">,</span> <span class="s">&#34;failed-tasks&#34;</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">    <span class="n">failedTasksCounter</span><span class="o">.</span><span class="na">inc</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Counter</span> <span class="n">successfulTasksCounter</span> <span class="o">=</span> <span class="n">metricRegistry</span><span class="o">.</span><span class="na">counter</span><span class="o">(</span><span class="n">MetricRegistry</span><span class="o">.</span><span class="na">name</span><span class="o">(</span><span class="n">metricsPrefix</span><span class="o">,</span> <span class="s">&#34;successful-tasks&#34;</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">    <span class="n">successfulTasksCounter</span><span class="o">.</span><span class="na">inc</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><h2 id="conclusion">Conclusion</h2>
<p>In this article we have looked at a few monitoring-friendly customization to an ExecutorService implementation. Like always, any suggestions/improvements/bug fix will be highly appreciated. As for the example source code, it has been uploaded to <a href="https://github.com/sayembd/java-examples/blob/master/java-core/src/main/java/com/codesod/example/executor/MonitoredThreadPoolExecutor.java">Github</a>.</p>
]]></content:encoded>
    </item>
    
  </channel>
</rss>
