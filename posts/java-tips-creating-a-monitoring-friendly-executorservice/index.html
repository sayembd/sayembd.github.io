<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Java Tips: Creating a Monitoring-friendly ExecutorService | Random Musings</title><meta name=keywords content><meta name=description content="A custom ExecutorService implementation in Java, augmented with monitoring capabilities."><meta name=author content><link rel=canonical href=https://www.sayemahmed.com/posts/java-tips-creating-a-monitoring-friendly-executorservice/><link crossorigin=anonymous href=/assets/css/stylesheet.min.05454d598f87e0c631d67ac68ed91c748c4f8cc32ce6b01b10afd02b558bc5ca.css integrity="sha256-BUVNWY+H4MYx1nrGjtkcdIxPjMMs5rAbEK/QK1WLxco=" rel="preload stylesheet" as=style><link rel=icon href=https://www.sayemahmed.com/favicon.ico><link rel=apple-touch-icon href=https://www.sayemahmed.com/apple-touch-icon.png><meta name=twitter:title content="Java Tips: Creating a Monitoring-friendly ExecutorService | Random Musings"><meta name=twitter:description content="A custom ExecutorService implementation in Java, augmented with monitoring capabilities."><meta property="og:title" content="Java Tips: Creating a Monitoring-friendly ExecutorService | Random Musings"><meta property="og:description" content="A custom ExecutorService implementation in Java, augmented with monitoring capabilities."><meta property="og:type" content="article"><meta property="og:url" content="https://www.sayemahmed.com/posts/java-tips-creating-a-monitoring-friendly-executorservice/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2018-05-01T03:15:21+02:00"><meta property="article:modified_time" content="2018-05-01T03:15:21+02:00"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://www.sayemahmed.com/posts/"},{"@type":"ListItem","position":3,"name":"Java Tips: Creating a Monitoring-friendly ExecutorService","item":"https://www.sayemahmed.com/posts/java-tips-creating-a-monitoring-friendly-executorservice/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Java Tips: Creating a Monitoring-friendly ExecutorService | Random Musings","name":"Java Tips: Creating a Monitoring-friendly ExecutorService","description":"A custom ExecutorService implementation in Java, augmented with monitoring capabilities.","keywords":[],"wordCount":"1212","inLanguage":"en","datePublished":"2018-05-01T03:15:21+02:00","dateModified":"2018-05-01T03:15:21+02:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://www.sayemahmed.com/posts/java-tips-creating-a-monitoring-friendly-executorservice/"},"publisher":{"@type":"Organization","name":"Random Musings","logo":{"@type":"ImageObject","url":"https://www.sayemahmed.com/favicon.ico"}}}</script><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript></head><body class="type-posts kind-page layout-" id=top><script data-no-instant>function switchTheme(e){switch(e){case"light":document.body.classList.remove("dark");break;case"dark":document.body.classList.add("dark");break;default:window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")}}function isDarkTheme(){return document.body.className.includes("dark")}function getPrefTheme(){return localStorage.getItem("pref-theme")}function setPrefTheme(e){switchTheme(e),localStorage.setItem("pref-theme",e)}const toggleThemeCallbacks={};toggleThemeCallbacks.main=e=>{setPrefTheme(e?"light":"dark")},window.addEventListener("toggle-theme",function(){const e=isDarkTheme();for(const t in toggleThemeCallbacks)toggleThemeCallbacks[t](e)});function toggleThemeListener(){window.dispatchEvent(new CustomEvent("toggle-theme"))}</script><script>(function(){const t="light",e=getPrefTheme(),n=e||t;switchTheme(n)})()</script><header class=header><nav class=nav><div class=logo><a href=https://www.sayemahmed.com accesskey=h title="Random Musings (Alt + H)">Random Musings</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=https://www.sayemahmed.com/about-me/ title="About Me">About Me</a></li><li><a href=https://www.sayemahmed.com/index.xml/ title=RSS>RSS</a></li></ul></nav></header><main class="main post"><article class=post-single><header class=post-header><h1 class=post-title>Java Tips: Creating a Monitoring-friendly ExecutorService</h1><div class=post-description>A custom ExecutorService implementation in Java, augmented with monitoring capabilities.</div><div class=post-meta><span class=meta-item><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar" style="user-select:text"><rect x="3" y="4" width="18" height="18" rx="2" ry="2" style="user-select:text"/><line x1="16" y1="2" x2="16" y2="6" style="user-select:text"/><line x1="8" y1="2" x2="8" y2="6" style="user-select:text"/><line x1="3" y1="10" x2="21" y2="10" style="user-select:text"/></svg><span>May 1, 2018</span></span></div></header><div class=post-content><p>In this article we will be extending an <a href=https://docs.oracle.com/javase/10/docs/api/java/util/concurrent/ExecutorService.html>ExecutorService</a> implementation with monitoring capabilities. This monitoring capability will help us to measure a number of pool parameters i.e., active threads, work queue size etc. in a live production environment. It will also enable us to measure task execution time, successful tasks count, and failed tasks count.</p><h2 id=monitoring-library>Monitoring Library<a hidden class=anchor aria-hidden=true href=#monitoring-library>¶</a></h2><p>As for the monitoring library we will be using <a href=http://metrics.dropwizard.io/>Metrics</a>. For the sake of simplicity we will be using a <a href=http://metrics.dropwizard.io/4.0.0/apidocs/com/codahale/metrics/ConsoleReporter.html>ConsoleReporter</a> which will report our metrics to the console. For production-grade applications, we should use an advanced reporter (i.e., Graphite reporter). If you are unfamiliar with Metrics, then I recommend you to go through the <a href=http://metrics.dropwizard.io/4.0.0/getting-started.html>getting started guide</a>.</p><p>Let&rsquo;s get started.</p><h2 id=extending-the-threadpoolexecutor>Extending the ThreadPoolExecutor<a hidden class=anchor aria-hidden=true href=#extending-the-threadpoolexecutor>¶</a></h2><p>We will be using <a href=https://docs.oracle.com/javase/10/docs/api/java/util/concurrent/ThreadPoolExecutor.html>ThreadPoolExecutor</a> as the base class for our new type. Let&rsquo;s call it <em>MonitoredThreadPoolExecutor</em>. This class will accept a <a href=http://metrics.dropwizard.io/4.0.0/apidocs/com/codahale/metrics/MetricRegistry.html>MetricRegistry</a> as one of its constructor parameters -</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>MonitoredThreadPoolExecutor</span> <span class=kd>extends</span> <span class=n>ThreadPoolExecutor</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kd>final</span> <span class=n>MetricRegistry</span> <span class=n>metricRegistry</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=nf>MonitoredThreadPoolExecutor</span><span class=o>(</span>
</span></span><span class=line><span class=cl>      <span class=kt>int</span> <span class=n>corePoolSize</span><span class=o>,</span>
</span></span><span class=line><span class=cl>      <span class=kt>int</span> <span class=n>maximumPoolSize</span><span class=o>,</span>
</span></span><span class=line><span class=cl>      <span class=kt>long</span> <span class=n>keepAliveTime</span><span class=o>,</span>
</span></span><span class=line><span class=cl>      <span class=n>TimeUnit</span> <span class=n>unit</span><span class=o>,</span>
</span></span><span class=line><span class=cl>      <span class=n>BlockingQueue</span><span class=o>&lt;</span><span class=n>Runnable</span><span class=o>&gt;</span> <span class=n>workQueue</span><span class=o>,</span>
</span></span><span class=line><span class=cl>      <span class=n>MetricRegistry</span> <span class=n>metricRegistry</span>
</span></span><span class=line><span class=cl>  <span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>super</span><span class=o>(</span><span class=n>corePoolSize</span><span class=o>,</span> <span class=n>maximumPoolSize</span><span class=o>,</span> <span class=n>keepAliveTime</span><span class=o>,</span> <span class=n>unit</span><span class=o>,</span> <span class=n>workQueue</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=o>.</span><span class=na>metricRegistry</span> <span class=o>=</span> <span class=n>metricRegistry</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=nf>MonitoredThreadPoolExecutor</span><span class=o>(</span>
</span></span><span class=line><span class=cl>      <span class=kt>int</span> <span class=n>corePoolSize</span><span class=o>,</span>
</span></span><span class=line><span class=cl>      <span class=kt>int</span> <span class=n>maximumPoolSize</span><span class=o>,</span>
</span></span><span class=line><span class=cl>      <span class=kt>long</span> <span class=n>keepAliveTime</span><span class=o>,</span>
</span></span><span class=line><span class=cl>      <span class=n>TimeUnit</span> <span class=n>unit</span><span class=o>,</span>
</span></span><span class=line><span class=cl>      <span class=n>BlockingQueue</span><span class=o>&lt;</span><span class=n>Runnable</span><span class=o>&gt;</span> <span class=n>workQueue</span><span class=o>,</span>
</span></span><span class=line><span class=cl>      <span class=n>ThreadFactory</span> <span class=n>threadFactory</span><span class=o>,</span>
</span></span><span class=line><span class=cl>      <span class=n>MetricRegistry</span> <span class=n>metricRegistry</span>
</span></span><span class=line><span class=cl>  <span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>super</span><span class=o>(</span><span class=n>corePoolSize</span><span class=o>,</span> <span class=n>maximumPoolSize</span><span class=o>,</span> <span class=n>keepAliveTime</span><span class=o>,</span> <span class=n>unit</span><span class=o>,</span> <span class=n>workQueue</span><span class=o>,</span> <span class=n>threadFactory</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=o>.</span><span class=na>metricRegistry</span> <span class=o>=</span> <span class=n>metricRegistry</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=nf>MonitoredThreadPoolExecutor</span><span class=o>(</span>
</span></span><span class=line><span class=cl>      <span class=kt>int</span> <span class=n>corePoolSize</span><span class=o>,</span>
</span></span><span class=line><span class=cl>      <span class=kt>int</span> <span class=n>maximumPoolSize</span><span class=o>,</span>
</span></span><span class=line><span class=cl>      <span class=kt>long</span> <span class=n>keepAliveTime</span><span class=o>,</span>
</span></span><span class=line><span class=cl>      <span class=n>TimeUnit</span> <span class=n>unit</span><span class=o>,</span>
</span></span><span class=line><span class=cl>      <span class=n>BlockingQueue</span><span class=o>&lt;</span><span class=n>Runnable</span><span class=o>&gt;</span> <span class=n>workQueue</span><span class=o>,</span>
</span></span><span class=line><span class=cl>      <span class=n>RejectedExecutionHandler</span> <span class=n>handler</span><span class=o>,</span>
</span></span><span class=line><span class=cl>      <span class=n>MetricRegistry</span> <span class=n>metricRegistry</span>
</span></span><span class=line><span class=cl>  <span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>super</span><span class=o>(</span><span class=n>corePoolSize</span><span class=o>,</span> <span class=n>maximumPoolSize</span><span class=o>,</span> <span class=n>keepAliveTime</span><span class=o>,</span> <span class=n>unit</span><span class=o>,</span> <span class=n>workQueue</span><span class=o>,</span> <span class=n>handler</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=o>.</span><span class=na>metricRegistry</span> <span class=o>=</span> <span class=n>metricRegistry</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=nf>MonitoredThreadPoolExecutor</span><span class=o>(</span>
</span></span><span class=line><span class=cl>      <span class=kt>int</span> <span class=n>corePoolSize</span><span class=o>,</span>
</span></span><span class=line><span class=cl>      <span class=kt>int</span> <span class=n>maximumPoolSize</span><span class=o>,</span>
</span></span><span class=line><span class=cl>      <span class=kt>long</span> <span class=n>keepAliveTime</span><span class=o>,</span>
</span></span><span class=line><span class=cl>      <span class=n>TimeUnit</span> <span class=n>unit</span><span class=o>,</span>
</span></span><span class=line><span class=cl>      <span class=n>BlockingQueue</span><span class=o>&lt;</span><span class=n>Runnable</span><span class=o>&gt;</span> <span class=n>workQueue</span><span class=o>,</span>
</span></span><span class=line><span class=cl>      <span class=n>ThreadFactory</span> <span class=n>threadFactory</span><span class=o>,</span>
</span></span><span class=line><span class=cl>      <span class=n>RejectedExecutionHandler</span> <span class=n>handler</span><span class=o>,</span>
</span></span><span class=line><span class=cl>      <span class=n>MetricRegistry</span> <span class=n>metricRegistry</span>
</span></span><span class=line><span class=cl>  <span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>super</span><span class=o>(</span><span class=n>corePoolSize</span><span class=o>,</span> <span class=n>maximumPoolSize</span><span class=o>,</span> <span class=n>keepAliveTime</span><span class=o>,</span> <span class=n>unit</span><span class=o>,</span> <span class=n>workQueue</span><span class=o>,</span> <span class=n>threadFactory</span><span class=o>,</span> <span class=n>handler</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=o>.</span><span class=na>metricRegistry</span> <span class=o>=</span> <span class=n>metricRegistry</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><h2 id=registering-gauges-to-measure-pool-specific-paramters>Registering Gauges to measure pool-specific paramters<a hidden class=anchor aria-hidden=true href=#registering-gauges-to-measure-pool-specific-paramters>¶</a></h2><p>A <a href=http://metrics.dropwizard.io/4.0.0/getting-started.html#gauges>Gauge</a> is an instantaneous measurement of a value. We will be using it to measure different pool parameters like number of active threads, task queue size etc.</p><p>Before we can register a Gauge, we need to decide how to calculate a metric name for our thread pool. Each metric, whether it&rsquo;s a Gauge, or a Timer, or simply a Meter, has a unique name. This name is used to identify the metric source. The convention here is to use a dotted string which is often constructed from the fully qualified name of the class being monitored.</p><p>For our thread pool, we will be using its fully qualified name as a prefix to our metrics names. Additionally we will add another constructor parameter called <em>poolName,</em> which will be used by the clients to specify instance-specific identifiers.</p><p>After implementing these changes the class looks like below -</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>MonitoredThreadPoolExecutor</span> <span class=kd>extends</span> <span class=n>ThreadPoolExecutor</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kd>final</span> <span class=n>MetricRegistry</span> <span class=n>metricRegistry</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kd>final</span> <span class=n>String</span> <span class=n>metricsPrefix</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=nf>MonitoredThreadPoolExecutor</span><span class=o>(</span>
</span></span><span class=line><span class=cl>      <span class=kt>int</span> <span class=n>corePoolSize</span><span class=o>,</span>
</span></span><span class=line><span class=cl>      <span class=kt>int</span> <span class=n>maximumPoolSize</span><span class=o>,</span>
</span></span><span class=line><span class=cl>      <span class=kt>long</span> <span class=n>keepAliveTime</span><span class=o>,</span>
</span></span><span class=line><span class=cl>      <span class=n>TimeUnit</span> <span class=n>unit</span><span class=o>,</span>
</span></span><span class=line><span class=cl>      <span class=n>BlockingQueue</span><span class=o>&lt;</span><span class=n>Runnable</span><span class=o>&gt;</span> <span class=n>workQueue</span><span class=o>,</span>
</span></span><span class=line><span class=cl>      <span class=n>MetricRegistry</span> <span class=n>metricRegistry</span><span class=o>,</span>
</span></span><span class=line><span class=cl>      <span class=n>String</span> <span class=n>poolName</span>
</span></span><span class=line><span class=cl>  <span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>super</span><span class=o>(</span><span class=n>corePoolSize</span><span class=o>,</span> <span class=n>maximumPoolSize</span><span class=o>,</span> <span class=n>keepAliveTime</span><span class=o>,</span> <span class=n>unit</span><span class=o>,</span> <span class=n>workQueue</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=o>.</span><span class=na>metricRegistry</span> <span class=o>=</span> <span class=n>metricRegistry</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=o>.</span><span class=na>metricsPrefix</span> <span class=o>=</span> <span class=n>MetricRegistry</span><span class=o>.</span><span class=na>name</span><span class=o>(</span><span class=n>getClass</span><span class=o>(),</span> <span class=n>poolName</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// Rest of the constructors
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>}</span>
</span></span></code></pre></div><p>Now we are ready to register our Gauges. For this purpose we will define a private method -</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span> <span class=kt>void</span> <span class=nf>registerGauges</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=n>metricRegistry</span><span class=o>.</span><span class=na>register</span><span class=o>(</span><span class=n>MetricRegistry</span><span class=o>.</span><span class=na>name</span><span class=o>(</span><span class=n>metricsPrefix</span><span class=o>,</span> <span class=s>&#34;corePoolSize&#34;</span><span class=o>),</span> <span class=o>(</span><span class=n>Gauge</span><span class=o>&lt;</span><span class=n>Integer</span><span class=o>&gt;)</span> <span class=k>this</span><span class=o>::</span><span class=n>getCorePoolSize</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=n>metricRegistry</span><span class=o>.</span><span class=na>register</span><span class=o>(</span><span class=n>MetricRegistry</span><span class=o>.</span><span class=na>name</span><span class=o>(</span><span class=n>metricsPrefix</span><span class=o>,</span> <span class=s>&#34;activeThreads&#34;</span><span class=o>),</span> <span class=o>(</span><span class=n>Gauge</span><span class=o>&lt;</span><span class=n>Integer</span><span class=o>&gt;)</span> <span class=k>this</span><span class=o>::</span><span class=n>getActiveCount</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=n>metricRegistry</span><span class=o>.</span><span class=na>register</span><span class=o>(</span><span class=n>MetricRegistry</span><span class=o>.</span><span class=na>name</span><span class=o>(</span><span class=n>metricsPrefix</span><span class=o>,</span> <span class=s>&#34;maxPoolSize&#34;</span><span class=o>),</span> <span class=o>(</span><span class=n>Gauge</span><span class=o>&lt;</span><span class=n>Integer</span><span class=o>&gt;)</span> <span class=k>this</span><span class=o>::</span><span class=n>getMaximumPoolSize</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=n>metricRegistry</span><span class=o>.</span><span class=na>register</span><span class=o>(</span><span class=n>MetricRegistry</span><span class=o>.</span><span class=na>name</span><span class=o>(</span><span class=n>metricsPrefix</span><span class=o>,</span> <span class=s>&#34;queueSize&#34;</span><span class=o>),</span> <span class=o>(</span><span class=n>Gauge</span><span class=o>&lt;</span><span class=n>Integer</span><span class=o>&gt;)</span> <span class=o>()</span> <span class=o>-&gt;</span> <span class=n>getQueue</span><span class=o>().</span><span class=na>size</span><span class=o>());</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>For our example we are measuring core pool size, number of active threads, maximum pool size, and task queue size. Depending on monitoring requirements we can register more/less Gauges to measure different properties.</p><p>This private method will now be invoked from all constructors -</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=nf>MonitoredThreadPoolExecutor</span><span class=o>(</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>corePoolSize</span><span class=o>,</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>maximumPoolSize</span><span class=o>,</span>
</span></span><span class=line><span class=cl>    <span class=kt>long</span> <span class=n>keepAliveTime</span><span class=o>,</span>
</span></span><span class=line><span class=cl>    <span class=n>TimeUnit</span> <span class=n>unit</span><span class=o>,</span>
</span></span><span class=line><span class=cl>    <span class=n>BlockingQueue</span><span class=o>&lt;</span><span class=n>Runnable</span><span class=o>&gt;</span> <span class=n>workQueue</span><span class=o>,</span>
</span></span><span class=line><span class=cl>    <span class=n>MetricRegistry</span> <span class=n>metricRegistry</span><span class=o>,</span>
</span></span><span class=line><span class=cl>    <span class=n>String</span> <span class=n>poolName</span>
</span></span><span class=line><span class=cl><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=kd>super</span><span class=o>(</span><span class=n>corePoolSize</span><span class=o>,</span> <span class=n>maximumPoolSize</span><span class=o>,</span> <span class=n>keepAliveTime</span><span class=o>,</span> <span class=n>unit</span><span class=o>,</span> <span class=n>workQueue</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=k>this</span><span class=o>.</span><span class=na>metricRegistry</span> <span class=o>=</span> <span class=n>metricRegistry</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=k>this</span><span class=o>.</span><span class=na>metricsPrefix</span> <span class=o>=</span> <span class=n>MetricRegistry</span><span class=o>.</span><span class=na>name</span><span class=o>(</span><span class=n>getClass</span><span class=o>(),</span> <span class=n>poolName</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=n>registerGauges</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><h2 id=measuring-task-execution-time>Measuring Task Execution Time<a hidden class=anchor aria-hidden=true href=#measuring-task-execution-time>¶</a></h2><p>To measure the task execution time, we will override two life-cycle methods that <em>ThreadPoolExecutor</em> provides - <em>beforeExecute</em> and <em>afterExecute</em>.</p><p>As the name implies, <em>beforeExecute</em> callback is invoked prior to executing a task, by the thread that will execute the task. The default implementation of this callback does nothing.</p><p>Similarly, the <em>afterExecute</em> callback is invoked after each task is executed, by the thread that executed the task. The default implementation of this callback also does nothing. Even if the task throws an uncaught <em>RuntimeException</em> or <em>Error</em>, this callback will be invoked.</p><p>We will be starting a <a href=http://metrics.dropwizard.io/4.0.0/getting-started.html#timers>Timer</a> in our <em>beforeExecute</em> override, which will then be used in our <em>afterExecute</em> override to get the total task execution time. To store a reference to the <em>Timer</em> we will introduce a new <em>ThreadLocal</em> field in our class.</p><p>The implementation of the callbacks are given below -</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>MonitoredThreadPoolExecutor</span> <span class=kd>extends</span> <span class=n>ThreadPoolExecutor</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kd>final</span> <span class=n>MetricRegistry</span> <span class=n>metricRegistry</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kd>final</span> <span class=n>String</span> <span class=n>metricsPrefix</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=n>ThreadLocal</span><span class=o>&lt;</span><span class=n>Timer</span><span class=o>.</span><span class=na>Context</span><span class=o>&gt;</span> <span class=n>taskExecutionTimer</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ThreadLocal</span><span class=o>&lt;&gt;();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// Constructors
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>  <span class=kd>protected</span> <span class=kt>void</span> <span class=nf>beforeExecute</span><span class=o>(</span><span class=n>Thread</span> <span class=n>thread</span><span class=o>,</span> <span class=n>Runnable</span> <span class=n>task</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>super</span><span class=o>.</span><span class=na>beforeExecute</span><span class=o>(</span><span class=n>thread</span><span class=o>,</span> <span class=n>task</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>Timer</span> <span class=n>timer</span> <span class=o>=</span> <span class=n>metricRegistry</span><span class=o>.</span><span class=na>timer</span><span class=o>(</span><span class=n>MetricRegistry</span><span class=o>.</span><span class=na>name</span><span class=o>(</span><span class=n>metricsPrefix</span><span class=o>,</span> <span class=s>&#34;task-execution&#34;</span><span class=o>));</span>
</span></span><span class=line><span class=cl>    <span class=n>taskExecutionTimer</span><span class=o>.</span><span class=na>set</span><span class=o>(</span><span class=n>timer</span><span class=o>.</span><span class=na>time</span><span class=o>());</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>  <span class=kd>protected</span> <span class=kt>void</span> <span class=nf>afterExecute</span><span class=o>(</span><span class=n>Runnable</span> <span class=n>task</span><span class=o>,</span> <span class=n>Throwable</span> <span class=n>throwable</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Timer</span><span class=o>.</span><span class=na>Context</span> <span class=n>context</span> <span class=o>=</span> <span class=n>taskExecutionTimer</span><span class=o>.</span><span class=na>get</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>context</span><span class=o>.</span><span class=na>stop</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=kd>super</span><span class=o>.</span><span class=na>afterExecute</span><span class=o>(</span><span class=n>task</span><span class=o>,</span> <span class=n>throwable</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><h3 id=recording-number-of-failed-tasks-due-to-uncaught-exceptions>Recording number of failed tasks due to uncaught exceptions<a hidden class=anchor aria-hidden=true href=#recording-number-of-failed-tasks-due-to-uncaught-exceptions>¶</a></h3><p>The second parameter to the <em>afterExecute</em> callback is a <em>Throwable</em>. If non-null, this <em>Throwable</em> refers to the uncaught <em>RuntimeException</em> or <em>Error</em> that caused the execution to terminate. We can use this information to partially count the total number of tasks that were terminated abruptly due to uncaught exceptions.</p><p>To get the total number of failed tasks, we must consider another case. Tasks submitted using the <em>execute</em> method will throw any uncaught exceptions, and it will be available as the second argument to the <em>afterExecute</em> callback. However, tasks submitted using the <em>submit</em> method are swallowed by the executor service. This is clearly explained in the <a href=https://docs.oracle.com/javase/10/docs/api/java/util/concurrent/ThreadPoolExecutor.html#afterExecute(java.lang.Runnable,java.lang.Throwable)>JavaDoc</a> (emphasis mine) -</p><blockquote><p>Note: When actions are enclosed in tasks (such as FutureTask) either explicitly or via methods such as submit, these task objects catch and maintain computational exceptions, and so they do not cause abrupt termination, and <strong>the internal exceptions are not passed to this method</strong>. If you would like to trap both kinds of failures in this method, you can further probe for such cases, as in this sample subclass that prints either the direct cause or the underlying exception if a task has been aborted</p></blockquote><p>Fortunately, the same doc also offers a solution for this, which is to examine the runnable to see if it&rsquo;s a <em>Future</em>, and then get the underlying exception.</p><p>Combining these approaches, we can modify our <em>afterExecute</em> method as follows -</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Override</span>
</span></span><span class=line><span class=cl><span class=kd>protected</span> <span class=kt>void</span> <span class=nf>afterExecute</span><span class=o>(</span><span class=n>Runnable</span> <span class=n>runnable</span><span class=o>,</span> <span class=n>Throwable</span> <span class=n>throwable</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=n>Timer</span><span class=o>.</span><span class=na>Context</span> <span class=n>context</span> <span class=o>=</span> <span class=n>taskExecutionTimer</span><span class=o>.</span><span class=na>get</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=n>context</span><span class=o>.</span><span class=na>stop</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>super</span><span class=o>.</span><span class=na>afterExecute</span><span class=o>(</span><span class=n>runnable</span><span class=o>,</span> <span class=n>throwable</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>throwable</span> <span class=o>==</span> <span class=kc>null</span> <span class=o>&amp;&amp;</span> <span class=n>runnable</span> <span class=k>instanceof</span> <span class=n>Future</span> <span class=o>&amp;&amp;</span> <span class=o>((</span><span class=n>Future</span><span class=o>)</span> <span class=n>runnable</span><span class=o>).</span><span class=na>isDone</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=o>((</span><span class=n>Future</span><span class=o>)</span> <span class=n>runnable</span><span class=o>).</span><span class=na>get</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>CancellationException</span> <span class=n>ce</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>throwable</span> <span class=o>=</span> <span class=n>ce</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>ExecutionException</span> <span class=n>ee</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>throwable</span> <span class=o>=</span> <span class=n>ee</span><span class=o>.</span><span class=na>getCause</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>InterruptedException</span> <span class=n>ie</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>Thread</span><span class=o>.</span><span class=na>currentThread</span><span class=o>().</span><span class=na>interrupt</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>throwable</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Counter</span> <span class=n>failedTasksCounter</span> <span class=o>=</span> <span class=n>metricRegistry</span><span class=o>.</span><span class=na>counter</span><span class=o>(</span><span class=n>MetricRegistry</span><span class=o>.</span><span class=na>name</span><span class=o>(</span><span class=n>metricsPrefix</span><span class=o>,</span> <span class=s>&#34;failed-tasks&#34;</span><span class=o>));</span>
</span></span><span class=line><span class=cl>    <span class=n>failedTasksCounter</span><span class=o>.</span><span class=na>inc</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><h2 id=counting-total-number-of-successful-tasks>Counting total number of successful tasks<a hidden class=anchor aria-hidden=true href=#counting-total-number-of-successful-tasks>¶</a></h2><p>The previous approach can also be used to count the total number of successful tasks: tasks that were completed without throwing any exceptions or errors -</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Override</span>
</span></span><span class=line><span class=cl><span class=kd>protected</span> <span class=kt>void</span> <span class=nf>afterExecute</span><span class=o>(</span><span class=n>Runnable</span> <span class=n>runnable</span><span class=o>,</span> <span class=n>Throwable</span> <span class=n>throwable</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// Rest of the method body .....
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>throwable</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Counter</span> <span class=n>failedTasksCounter</span> <span class=o>=</span> <span class=n>metricRegistry</span><span class=o>.</span><span class=na>counter</span><span class=o>(</span><span class=n>MetricRegistry</span><span class=o>.</span><span class=na>name</span><span class=o>(</span><span class=n>metricsPrefix</span><span class=o>,</span> <span class=s>&#34;failed-tasks&#34;</span><span class=o>));</span>
</span></span><span class=line><span class=cl>    <span class=n>failedTasksCounter</span><span class=o>.</span><span class=na>inc</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Counter</span> <span class=n>successfulTasksCounter</span> <span class=o>=</span> <span class=n>metricRegistry</span><span class=o>.</span><span class=na>counter</span><span class=o>(</span><span class=n>MetricRegistry</span><span class=o>.</span><span class=na>name</span><span class=o>(</span><span class=n>metricsPrefix</span><span class=o>,</span> <span class=s>&#34;successful-tasks&#34;</span><span class=o>));</span>
</span></span><span class=line><span class=cl>    <span class=n>successfulTasksCounter</span><span class=o>.</span><span class=na>inc</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><h2 id=conclusion>Conclusion<a hidden class=anchor aria-hidden=true href=#conclusion>¶</a></h2><p>In this article we have looked at a few monitoring-friendly customization to an ExecutorService implementation. Like always, any suggestions/improvements/bug fix will be highly appreciated. As for the example source code, it has been uploaded to <a href=https://github.com/sayembd/java-examples/blob/master/java-core/src/main/java/com/codesod/example/executor/MonitoredThreadPoolExecutor.java>Github</a>.</p></div><footer class=post-footer><nav class=paginav><a class=prev href=https://www.sayemahmed.com/posts/a-brief-overview-of-the-fork-join-framework-in-java/><span class=title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-left" style="user-select:text"><line x1="19" y1="12" x2="5" y2="12" style="user-select:text"/><polyline points="12 19 5 12 12 5" style="user-select:text"/></svg>&nbsp;Prev Page</span><br><span>A Brief Overview of the Fork Join Framework in Java</span></a>
<a class=next href=https://www.sayemahmed.com/posts/jpa-tips-avoiding-the-n-plus-1-select-problem/><span class=title>Next Page&nbsp;<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-right" style="user-select:text"><line x1="5" y1="12" x2="19" y2="12" style="user-select:text"/><polyline points="12 5 19 12 12 19" style="user-select:text"/></svg></span><br><span>Jpa Tips: Avoiding the N + 1 Select Problem</span></a></nav></footer><div class=comments-separator></div></article></main><footer class=footer><span>&copy; 2024 <a href=https://www.sayemahmed.com>Random Musings</a></span><span style=display:inline-block;margin-left:1em>
<a href=https://creativecommons.org/licenses/by-sa/4.0/>CC BY-SA</a></span>
<span style=display:inline-block;margin-left:1em>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
    <a href=https://github.com/reorx/hugo-PaperModX/ rel=noopener target=_blank>PaperModX</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>(function(){const t=""=="1";if(t)return;let e=document.getElementById("theme-toggle");e.removeEventListener("click",toggleThemeListener),e.addEventListener("click",toggleThemeListener)})()</script><script>(function(){let e=document.getElementById("menu");e&&(e.scrollLeft=localStorage.getItem("menu-scroll-position"),e.onscroll=function(){localStorage.setItem("menu-scroll-position",e.scrollLeft)});const t=""=="1",n=""=="1";if(window.matchMedia("(prefers-reduced-motion: reduce)").matches||t||n)return;document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})})()</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>if(window.scrollListeners)for(const e of scrollListeners)window.removeEventListener("scroll",e);window.scrollListeners=[]</script><script src=/js/medium-zoom.min.js data-no-instant></script>
<script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerText="copy";function s(){t.innerText="copied!",setTimeout(()=>{t.innerText="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script><script>(function(){const a=""=="1";if(!a)return;if(!document.querySelector(".toc")){console.log("no toc found, ignore toc scroll");return}const r=window.scrollListeners,t=document.querySelectorAll("h1[id],h2[id],h3[id],h4[id],h5[id]"),n="active";let e=t[0];o(e).classList.add(n);const c=()=>{const s=[];for(const e of t)if(l(e)<5)s.push(e);else break;s.length>0?newActiveHeading=s[s.length-1]:newActiveHeading=t[0],e!=newActiveHeading&&(o(e).classList.remove(n),e=newActiveHeading,o(e).classList.add(n))};let s=null;const i=()=>{s!==null&&clearTimeout(s),s=setTimeout(c,50)};window.addEventListener("scroll",i,!1),r.push(i);function o(e){const t=encodeURI(e.getAttribute("id")).toLowerCase();return document.querySelector(`.toc ul li a[href="#${t}"]`)}function l(e){if(!e.getClientRects().length)return 0;let t=e.getBoundingClientRect();return t.top}})()</script></body></html>